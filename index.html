<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Qbit</title>
    <link rel="icon" id="dynamic-favicon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>Q</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- Root Variables and Base Styles --- */
        :root {
            /* Theme Variables */ --bg: #1e1e1e; --sidebar: #111; --topbar: #2c2c2c; --accent: #444; --text: #ffffff;
            /* Font */ --font-size: 16px; --font-family: 'Segoe UI', sans-serif;
            /* Radii */ --radius-std: 8px; --radius-lg: 12px;
            /* Slider */ --slider-track-bg: var(--accent); --slider-thumb-bg: var(--text); --slider-progress-color: var(--text); --slider-track-height: 6px; --slider-thumb-size: 16px;
            /* Components */ --game-card-bg: var(--topbar); --game-card-hover-bg: var(--accent);
            /* Colors */ --delete-color: #e53e3e; --edit-color: #4299e1; --play-color: #48bb78; --mod-color: #4ec9b0; --owner-color: #c586c0; --system-color: #ce9178;
            /* Background */ --custom-bg-image: none;
            /* Added: Accent Blue for focus */ --accent-blue: #3b82f6;
        }
        html, body { height: 100%; margin: 0; overflow: hidden; }
        body, .sidebar, .main, .modal-overlay, .modal-box, .sidebar button, .search input, .icon-btn, .content, iframe, .settings-panel label, .settings-panel select, .settings-panel input[type="file"], .settings-panel button, .custom-slider-container, input[type="range"].custom-slider, .modal-box input, .modal-box select, .modal-box button, .game-card, .game-card button, #addGameBtn, #gameModal input, #gameModal select, #gameModal button, #addCategoryBtn, .proxy-card, .proxy-card button, #clearDataBtn, .tool-card, #clearBgImageBtn { /* Added #clearDataBtn, #clearBgImageBtn */ box-sizing: border-box; }
        body { font-family: var(--font-family); display: flex; background-color: var(--bg); color: var(--text); font-size: var(--font-size); transition: background-color 0.3s, color 0.3s; background-image: var(--custom-bg-image); background-size: cover; background-position: center center; background-repeat: no-repeat; background-attachment: fixed;
          /* Themed Scrollbar (Firefox) */
          scrollbar-width: thin;
          scrollbar-color: var(--accent) var(--sidebar); /* thumb track */
        }

        /* --- Themed Scrollbar (WebKit - Chrome, Edge, Safari) --- */
        ::-webkit-scrollbar {
          width: 10px; /* Width of the scrollbar */
        }
        ::-webkit-scrollbar-track {
          background: var(--sidebar); /* Track color, slightly different from main bg */
          border-radius: 5px; /* Rounded corners for the track */
        }
        ::-webkit-scrollbar-thumb {
          background-color: var(--accent); /* Thumb color using accent */
          border-radius: 5px; /* Rounded corners for the thumb */
          border: 2px solid var(--sidebar); /* Creates padding around thumb */
        }
        ::-webkit-scrollbar-thumb:hover {
          background-color: var(--text); /* Lighter thumb on hover */
          opacity: 0.8;
        }
        ::-webkit-scrollbar-corner {
           background: transparent; /* Hides the bottom right corner square */
        }

        /* --- Layout: Sidebar, Main, Topbar --- */
        .sidebar { width: 200px; background-color: var(--sidebar); flex-shrink: 0; animation: slideInLeft 0.5s ease forwards; transition: background-color 0.3s; display:flex; flex-direction:column; padding: 20px 10px; gap: 20px; height: 100vh; overflow-y: auto; /* Added overflow */ }
        .sidebar h2 { font-size: 1.1em; border-bottom: 1px solid var(--accent); padding-bottom: 5px; margin-bottom: 10px; color: var(--text);}
        .sidebar button { background: var(--accent); border: none; padding: 0.6em 0.8em; text-align: left; color: var(--text); cursor: pointer; border-radius: var(--radius-std); transition: background 0.3s, transform 0.2s, color 0.3s; font-size: 0.9em; display: block; width: 100%; }
        .sidebar button:hover:not(:disabled) { filter: brightness(1.1); transform: scale(1.03); }
        .sidebar button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(50%); transform: none;} /* Kept for potential future use */
        .main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; height: 100vh; }
        .topbar { background-color: var(--topbar); animation: slideDown 0.5s ease forwards; transition: background-color 0.3s; display:flex; align-items:center; justify-content: space-between; padding: 10px 20px; flex-shrink: 0; z-index: 2; }
        .search { flex-grow: 1; margin-right: 10px; }
        .search input { width: 100%; padding: 8px 12px; background-color: var(--bg); color: var(--text); border: 1px solid var(--accent); border-radius: var(--radius-std); font-size: 0.9em; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        .top-buttons { display: flex; gap: 10px; }
        .icon-btn { width: 38px; height: 38px; border-radius: 50%; background-color: var(--accent); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.3s, transform 0.2s, filter 0.2s; padding: 0; }
        .icon-btn:disabled { filter: grayscale(70%) opacity(50%); cursor: not-allowed; transform: none; }
        .icon-btn:hover:not(:disabled) { filter: brightness(1.1); transform: scale(1.1); }
        .icon-btn svg { width: 18px; height: 18px; fill: var(--text); display: block; }

        /* --- Content Area --- */
        .content { padding: 25px; overflow-y: auto; flex-grow: 1; line-height: 1.6; color: var(--text); display: block; height: calc(100% - 58px); /* Adjusted for topbar height */ }
        .content h1 { font-size: 1.8em; margin-bottom: 0.5em; color: var(--text);} .content h2 { font-size: 1.4em; margin-bottom: 0.4em; margin-top: 1em; color: var(--text);} .content p { font-size: 1em; margin-bottom: 1em; color: var(--text);}

        /* --- Welcome Area --- */
        #welcome-area { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100%; opacity: 0; animation: fadeIn 1s 0.2s forwards; padding-bottom: 20px; overflow-y: auto; /* Added overflow */ }
        #welcome-logo-container { width: 64px; height: 64px; margin-bottom: 20px; opacity: 0; transform: scale(0.5); animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.5s forwards; flex-shrink: 0; }
        #welcome-logo-container svg { display: block; width: 100%; height: 100%; }
        #welcome-message { opacity: 0; transform: translateY(20px); animation: fadeInUp 0.8s ease-out 0.8s forwards; color: var(--text); margin-bottom: 15px; flex-shrink: 0; font-size: 1.6em; }
        /* Removed #user-count-display */
        #changelog-section { margin-top: 20px; padding: 15px 20px; background-color: rgba(0, 0, 0, 0.1); border-radius: var(--radius-std); width: 80%; max-width: 600px; text-align: left; border: 1px solid var(--accent); flex-shrink: 0; margin-bottom: auto; }
        #changelog-section h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.2em; border-bottom: 1px solid var(--accent); padding-bottom: 5px; color: var(--text); }
        .changelog-version { margin-bottom: 15px; }
        .changelog-version h4 { margin: 0 0 5px 0; font-size: 1em; color: var(--text); }
        .changelog-version ul { margin: 0; padding-left: 20px; list-style: disc; font-size: 0.9em; color: var(--text); opacity: 0.9; }
        .changelog-version ul li { margin-bottom: 4px; }

        /* --- Settings Panel --- */
        .settings-panel { position: fixed; top: 55px; right: 20px; background-color: var(--topbar); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 280px; z-index: 10; opacity: 0; transform: translateY(-20px); transition: opacity 0.4s ease, transform 0.4s ease, background-color 0.3s, visibility 0s linear 0.4s; display: none; flex-direction: column; gap: 15px; color: var(--text); max-height: calc(100vh - 75px); overflow-y: auto; /* Added max-height and overflow */ }
        .settings-panel.show { display: flex; opacity: 1; transform: translateY(0); visibility: visible; transition: opacity 0.4s ease, transform 0.4s ease, background-color 0.3s; }
        .settings-panel label:not(.toggle-switch-label):not(#usernameSettingLabel) { /* Exclude username label from default column layout */
            font-size: 0.9em;
            display: flex;
            flex-direction: column;
            gap: 8px;
            color: var(--text);
        }
        /* --- Styles for Username Setting Area --- */
        .settings-panel label#usernameSettingLabel {
            display: flex; /* Use flexbox for alignment */
            align-items: center; /* Vertically align items */
            justify-content: space-between; /* Space out label text and input/button */
            gap: 10px; /* Add gap between elements */
            font-size: 0.9em;
            color: var(--text);
            width: 100%; /* Ensure label takes full width */
        }
        .settings-panel #settingsUsernameInput {
            flex-grow: 1; /* Allow input to take available space */
            padding: 6px 10px; /* Adjust padding */
            font-size: 0.9em; /* Match label font size */
            border-radius: var(--radius-std);
            border: 1px solid var(--accent);
            background-color: var(--bg);
            color: var(--text);
            transition: border-color 0.3s, background-color 0.3s;
        }
        .settings-panel #saveUsernameBtn {
            flex-shrink: 0; /* Prevent button from shrinking */
            padding: 6px 12px; /* Adjust padding */
            font-size: 0.85em; /* Slightly smaller font */
            background-color: var(--accent);
            color: var(--text);
            border: none;
            border-radius: var(--radius-std);
            cursor: pointer;
            transition: background-color 0.3s, filter 0.2s;
        }
         .settings-panel #saveUsernameBtn:hover {
            filter: brightness(1.2);
         }
         .settings-panel #saveUsernameBtn:active {
            transform: scale(0.95);
         }
        /* --- End Username Setting Styles --- */

        .settings-panel select { padding: 10px; border-radius: var(--radius-std); border: 1px solid var(--accent); background-color: var(--bg); color: var(--text); transition: background-color 0.3s, color 0.3s, border-color 0.3s; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23${(typeof getComputedStyle !== 'undefined' ? (getComputedStyle(document.documentElement).getPropertyValue('--text') || '#ffffff').substring(1) : 'ffffff')}%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 12px center; background-size: 10px auto; padding-right: 35px; font-size: 0.9em; }
        /* Slider Styles */
        .custom-slider-container { position: relative; width: 100%; height: var(--slider-thumb-size); display: flex; align-items: center; cursor: pointer; margin-top: 5px; }
        input[type="range"].custom-slider { appearance: none; -webkit-appearance: none; width: 100%; height: var(--slider-track-height); background: transparent; position: absolute; top: calc(50% - var(--slider-track-height) / 2); left: 0; z-index: 2; margin: 0; cursor: pointer; }
        input[type="range"].custom-slider::-webkit-slider-thumb { appearance: none; -webkit-appearance: none; width: var(--slider-thumb-size); height: var(--slider-thumb-size); background: transparent; border: none; }
        input[type="range"].custom-slider::-moz-range-thumb { width: var(--slider-thumb-size); height: var(--slider-thumb-size); background: transparent; border: none; border-radius: 0; }
        .slider-track { position: absolute; width: 100%; height: var(--slider-track-height); background-color: var(--slider-track-bg); border-radius: var(--slider-track-height); top: calc(50% - var(--slider-track-height) / 2); left: 0; z-index: 0; transition: background-color 0.3s; }
        .slider-progress { position: absolute; height: var(--slider-track-height); background-color: var(--slider-progress-color); border-radius: var(--slider-track-height); top: calc(50% - var(--slider-track-height) / 2); left: 0; z-index: 1; width: 50%; transition: background-color 0.3s; opacity: 0.7; }
        .slider-thumb { position: absolute; width: var(--slider-thumb-size); height: var(--slider-thumb-size); background-color: var(--slider-thumb-bg); border-radius: 50%; border: 1px solid var(--accent); top: calc(50% - var(--slider-thumb-size) / 2); left: 50%; transform: translateX(-50%); z-index: 3; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: background-color 0.3s, border-color 0.3s; }
        .slider-value-display { margin-left: 10px; font-size: 0.85em; color: var(--text); opacity: 0.8; position: absolute; right: 0; top: -1.5em; min-width: 30px; text-align: right; }
        /* Toggle Switch Styles */
        .toggle-switch-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-size: 0.9em; color: var(--text); position: relative; user-select: none; }
        .toggle-switch { opacity: 0; width: 0; height: 0; position: absolute; }
        .toggle-slider { position: relative; display: inline-block; width: 40px; height: 20px; background-color: var(--accent); border-radius: 20px; transition: background-color 0.3s; flex-shrink: 0; }
        .toggle-slider::before { content: ""; position: absolute; width: 16px; height: 16px; left: 2px; bottom: 2px; background-color: var(--text); border-radius: 50%; transition: transform 0.3s; }
        .toggle-switch:checked + .toggle-slider { background-color: var(--play-color); }
        .toggle-switch:checked + .toggle-slider::before { transform: translateX(20px); }
        .toggle-switch:focus-visible + .toggle-slider { box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent); }
        /* Danger/Action Buttons */
        .danger-btn { background-color: var(--accent); color: var(--text); border: none; padding: 10px 15px; border-radius: var(--radius-std); cursor: pointer; font-size: 0.9em; font-weight: bold; text-align: center; transition: background-color 0.3s, transform 0.1s, filter 0.3s; margin-top: 10px; width: 100%; }
        .danger-btn:hover { filter: brightness(0.85); }
        .danger-btn:active { transform: scale(0.98); }
        /* Specific style for Clear Data button */
        #clearDataBtn {
             background-color: var(--delete-color); /* Use the delete color */
        }
        #clearDataBtn:hover {
             filter: brightness(1.1); /* Make it brighter red on hover */
             background-color: var(--delete-color); /* Keep base color */
        }
        /* Removed #logoutBtn styles */

        /* --- Modals (Only Game Modal Needed) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 100; opacity: 0; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .modal-overlay.visible { display: flex; opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-box { background-color: var(--topbar); padding: 30px 40px; border-radius: var(--radius-lg); border: 1px solid var(--accent); box-shadow: 0 5px 20px rgba(0,0,0,0.4); text-align: center; color: var(--text); transform: scale(0.9); transition: transform 0.3s ease, background-color 0.3s, color 0.3s; max-width: 450px; width: 90%; max-height: 90vh; /* Added max-height */ display: flex; flex-direction: column; /* Added flex */ }
        .modal-overlay.visible .modal-box { transform: scale(1); }
        .modal-box h3 { margin-top: 0; margin-bottom: 25px; font-size: 1.3em; color: var(--text); flex-shrink: 0; /* Prevent shrinking */ }
        .modal-box p { margin-bottom: 20px; font-size: 0.95em; opacity: 0.9; text-align: left; color: var(--text); flex-shrink: 0; /* Prevent shrinking */ }
        .modal-box .form-field { margin-bottom: 18px; flex-shrink: 0; /* Prevent shrinking */ }
        .modal-box .category-field { display: flex; align-items: center; gap: 10px; }
        .modal-box label { display: block; text-align: left; margin-bottom: 5px; font-size: 0.9em; font-weight: bold; color: var(--text); }
        .modal-box input[type="text"], .modal-box input[type="url"], .modal-box input[type="password"], .modal-box select { display: block; width: 100%; padding: 10px; border: 1px solid var(--accent); border-radius: var(--radius-std); background-color: var(--bg); color: var(--text); font-size: 1em; flex-grow: 1; }
        .modal-box select { appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23${(typeof getComputedStyle !== 'undefined' ? (getComputedStyle(document.documentElement).getPropertyValue('--text') || '#ffffff').substring(1) : 'ffffff')}%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 12px center; background-size: 10px auto; padding-right: 35px; }
        #addCategoryBtn { padding: 6px 10px; font-size: 0.8em; flex-shrink: 0; background-color: var(--accent); color: var(--text); border: none; border-radius: var(--radius-std); cursor: pointer; }
        #addCategoryBtn:hover { filter: brightness(1.2); }
        .modal-box .modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; /* Prevent shrinking */ }
        .modal-box button { padding: 10px 20px; border: none; border-radius: var(--radius-std); font-size: 1em; cursor: pointer; transition: background-color 0.3s, transform 0.1s; color: var(--text); }
        .modal-box button.primary { background-color: var(--accent); }
        .modal-box button.secondary { background-color: transparent; border: 1px solid var(--accent); }
        .modal-box button:hover { filter: brightness(1.2); } .modal-box button:active { transform: scale(0.95); }
        .modal-box button:disabled { filter: grayscale(50%); opacity: 0.6; cursor: not-allowed; }
        /* Removed #loginError, #registerError styles */

        /* --- Game/Tool/Proxy Cards --- */
        #games-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--accent); }
        #addGameBtn { background-color: var(--accent); color: var(--text); border: none; padding: 8px 15px; border-radius: var(--radius-std); cursor: pointer; font-size: 0.9em; transition: background-color 0.3s, transform 0.1s; }
        #addGameBtn:hover { filter: brightness(1.2); } #addGameBtn:active { transform: scale(0.95); }
        .game-list-container, .tools-list-container, .proxy-list-container { /* Added containers */ display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; padding-top: 10px; }
        .game-card, .tool-card, .proxy-card { /* Added cards */ background-color: var(--game-card-bg); border-radius: var(--radius-lg); padding: 15px; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid transparent; transition: transform 0.3s ease, background-color 0.3s, border-color 0.3s, box-shadow 0.3s; opacity: 0; transform: translateY(20px); animation: cardFadeInUp 0.5s ease forwards; min-height: 110px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); color: var(--text); }
        .game-card:nth-child(n), .tool-card:nth-child(n), .proxy-card:nth-child(n) { animation-delay: calc(0.05s * n); } /* Stagger animation slightly */
        .game-card:hover, .tool-card:hover, .proxy-card:hover { transform: translateY(-5px) scale(1.02); background-color: var(--game-card-hover-bg); border-color: var(--text); box-shadow: 0 8px 15px rgba(0,0,0,0.3); }
        .proxy-card h4 { font-size: 1.05em; margin-top: 0; margin-bottom: 8px; word-break: break-word; flex-grow: 1; color: var(--text);} /* Specific style for proxy card title */
        .game-card p.category, .tool-card p.category { /* Added .tool-card */ font-size: 0.75em; color: var(--text); opacity: 0.7; margin-top: 0; margin-bottom: 10px; background-color: rgba(0,0,0,0.2); padding: 3px 8px; border-radius: var(--radius-std); display: inline-block; }
        .game-card-actions, .tool-card-actions, .proxy-card-actions { /* Added actions */ display: flex; justify-content: flex-end; gap: 8px; margin-top: auto; }
        .game-card-actions button, .tool-card-actions button, .proxy-card-actions button { background-color: transparent; border: none; border-radius: var(--radius-std); cursor: pointer; padding: 5px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, transform 0.1s; }
        .game-card-actions button svg, .tool-card-actions button svg, .proxy-card-actions button svg { width: 18px; height: 18px; display: block; fill: var(--text); opacity: 0.7; transition: opacity 0.2s, fill 0.2s; }
        .game-card-actions button:hover svg, .tool-card-actions button:hover svg, .proxy-card-actions button:hover svg { opacity: 1; }
        .game-card-actions button:active, .tool-card-actions button:active, .proxy-card-actions button:active { transform: scale(0.9); }
        .game-card-actions button.play-btn:hover svg, .tool-card-actions button.play-btn:hover svg, .proxy-card-actions button.play-btn:hover svg { fill: var(--play-color); }
        .game-card-actions button.proxy-play-btn:hover svg { fill: var(--edit-color); } /* Blue hover for proxy play */
        .game-card-actions button.edit-btn:hover svg { fill: var(--edit-color); }
        .game-card-actions button.delete-btn:hover svg { fill: var(--delete-color); }
        .game-card.deleting { animation: cardFadeOut 0.4s ease forwards; }
        #no-games-found { display: none; grid-column: 1 / -1; text-align: center; opacity: 0.7; padding: 20px; color: var(--text);}
        .game-card-header, .tool-card-header { /* Added .tool-card */ display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-grow: 1; min-height: 20px; }
        .game-favicon { width: 16px; height: 16px; flex-shrink: 0; border-radius: 3px; object-fit: contain; background-color: rgba(128, 128, 128, 0.1); display: inline-block; vertical-align: middle; }
        .game-card-header h4, .tool-card-header h4 { margin: 0; flex-grow: 1; line-height: 1.2; color: var(--text); word-break: break-word; }

        /* --- Chat Styles Removed --- */

        /* --- Focus Styles --- */
        *:focus { outline: none; }
        button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible, iframe:focus-visible, .game-card:focus-visible, .tool-card:focus-visible, .proxy-card:focus-visible, input[type="file"]:focus-visible { box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent-blue); transition: box-shadow 0.2s ease-in-out; border-color: var(--accent-blue); }
        .settings-panel:focus-visible { border-radius: var(--radius-lg); box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent-blue); }
        input[type="range"].custom-slider:focus-visible { box-shadow: none; }
        input[type="range"].custom-slider:focus-visible + .slider-track + .slider-progress + .slider-thumb { box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent-blue); border-radius: 50%; }

        /* --- Placeholders --- */
        input::placeholder, .modal-box input::placeholder, .search input::placeholder, textarea::placeholder { color: var(--text); opacity: 0.6; }

        /* --- Theme Overrides (Example: Trigonometrical Red) --- */
        [data-theme="trigonometrical-red"] { --mod-color: #1abc9c; --owner-color: #9b59b6; --system-color: #e67e22; }
        [data-theme="trigonometrical-red"] .modal-box, [data-theme="trigonometrical-red"] .settings-panel, [data-theme="trigonometrical-red"] .sidebar button, [data-theme="trigonometrical-red"] .sidebar h2, [data-theme="trigonometrical-red"] .icon-btn svg, [data-theme="trigonometrical-red"] .slider-value-display { color: #ffffff; fill: #ffffff; }
        /* ... other overrides ... */
        /* Removed chat panel overrides */

        /* --- Animations --- */
        @keyframes slideInLeft { from { transform: translateX(-100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes fadeInUp { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes cardFadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes cardFadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.8); } }

    </style>
</head>
<body data-theme="dark">

    <div class="modal-overlay" id="gameModal">
        <div class="modal-box">
            <h3 id="gameModalTitle">Add New Game</h3>
            <input type="hidden" id="gameIdInput">
            <div class="form-field">
                <label for="gameNameInput">Name:</label>
                <input type="text" id="gameNameInput" placeholder="e.g., Shell Shockers" required>
            </div>
            <div class="form-field">
                <label for="gameUrlInput">URL:</label>
                <input type="url" id="gameUrlInput" placeholder="https://shellshock.io/" required>
            </div>
            <div class="form-field">
                <label for="gameCategorySelect">Category:</label>
                <div class="category-field">
                    <select id="gameCategorySelect">
                        <option value="">Uncategorized</option>
                     </select>
                    <button id="addCategoryBtn" title="Add New Category">+</button>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="secondary" id="cancelGameBtn">Cancel</button>
                <button type="button" class="primary" id="saveGameBtn">Save Game</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <h2>Qbit</h2>
        <button onclick="showSection('welcome')">Home</button>
        <button onclick="showSection('games')" id="sidebarGamesBtn">Games</button>
        <button onclick="showSection('proxy')" id="sidebarProxyBtn">Proxy</button>
        <button onclick="showSection('tools')" id="sidebarToolsBtn">Tools</button>
    </div>

    <div class="main">
        <div class="topbar">
            <div class="search">
                <input type="text" id="search" placeholder="Search Games, Proxies, or Tools..." /> </div>
            <div class="top-buttons">
                <button class="icon-btn" title="Settings" id="settingsBtn">
                    <svg viewBox="0 0 24 24"><path d="M12 15.5C10.07 15.5 8.5 13.93 8.5 12S10.07 8.5 12 8.5 15.5 10.07 15.5 12 13.93 15.5 12 15.5ZM19.43 12.98C19.46 12.66 19.5 12.34 19.5 12S19.46 11.34 19.43 11.02L21.54 9.37C21.73 9.21 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.06 19.3 4.97 19.07 5.03L16.56 5.67C16.04 5.25 15.47 4.89 14.85 4.6L14.5 2H9.5L9.15 4.6C8.53 4.89 7.96 5.25 7.44 5.67L4.93 5.03C4.7 4.97 4.46 5.06 4.34 5.27L2.34 8.73C2.22 8.95 2.27 9.21 2.46 9.37L4.57 11.02C4.54 11.34 4.5 11.66 4.5 12S4.54 12.66 4.57 12.98L2.46 14.63C2.27 14.79 2.22 15.05 2.34 15.27L4.34 18.73C4.46 18.94 4.7 19.03 4.93 18.97L7.44 18.33C7.96 18.75 8.53 19.11 9.15 19.4L9.5 22H14.5L14.85 19.4C15.47 19.11 16.04 18.75 16.56 18.33L19.07 18.97C19.3 19.03 19.54 18.94 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.79 21.54 14.63L19.43 12.98Z"/></svg>
                </button>
            </div>
        </div>

        <div class="content" id="main-content">
            <div id="welcome-area-placeholder" style="display: flex; flex-direction:column; align-items:center; justify-content:center; height:100%; text-align:center;"><h2>Loading Qbit...</h2><p style="opacity:0.7;">Please wait.</p></div>
        </div>

        <div class="settings-panel" id="settingsPanel">
             <label id="usernameSettingLabel">Username:
                 <input type="text" id="settingsUsernameInput" placeholder="Enter username" maxlength="30">
                 <button id="saveUsernameBtn">Save</button> </label>
             <hr style="border: none; border-top: 1px solid var(--accent); margin: 5px 0;">
             <label>Font Size: <span class="slider-value-display" id="fontSizeValue">16px</span>
                 <div class="custom-slider-container">
                     <div class="slider-track"></div>
                     <div class="slider-progress" id="fontSizeProgress"></div>
                     <div class="slider-thumb" id="fontSizeThumb"></div>
                     <input type="range" id="fontSizeSlider" class="custom-slider" min="12" max="24" step="1" value="16">
                 </div>
             </label>
             <label>Color Scheme:
                 <select id="themeSelector" onchange="updateTheme(this.value)">
                     <option value="dark">Dark</option>
                     <option value="light">Light</option>
                     <option value="blue">Cool Blue</option>
                     <option value="forest">Forest Green</option>
                     <option value="sunset">Sunset Orange</option>
                     <option value="trigonometrical-red">Trigonometrical Red</option>
                 </select>
             </label>
             <label>Font Family:
                 <select id="fontSelector" onchange="updateFontFamily(this.value)">
                     <option value="'Segoe UI', sans-serif">Segoe UI</option>
                     <option value="Arial, sans-serif">Arial</option>
                     <option value="Verdana, sans-serif">Verdana</option>
                     <option value="'Times New Roman', Times, serif">Times New Roman</option>
                     <option value="'Courier New', Courier, monospace">Courier New</option>
                     <option value="Georgia, serif">Georgia</option>
                     <option value="'Roboto', sans-serif">Roboto</option>
                     <option value="'Lato', sans-serif">Lato</option>
                 </select>
             </label>
             <label class="toggle-switch-label">
                 <span>Custom Background:</span>
                 <input type="checkbox" id="bgImageToggleSwitch" class="toggle-switch">
                 <span class="toggle-slider"></span>
             </label>
             <div id="bgImageControlContainer" style="display: none;"> <label for="bgImageFileInput">Select Image (Max 2MB):</label>
                 <input type="file" id="bgImageFileInput" accept="image/*">
                 <button id="clearBgImageBtn" title="Remove custom background" class="danger-btn" style="margin-top: 5px;">Clear Background</button>
             </div>
             <label class="toggle-switch-label"> Warn on Close:
                 <input type="checkbox" id="warnOnCloseSwitch" class="toggle-switch">
                 <span class="toggle-slider"></span>
             </label>
             <hr style="border: none; border-top: 1px solid var(--accent); margin: 10px 0;">
             <button id="clearDataBtn" title="Reset all settings, games, and categories to default" class="danger-btn">Clear All Stored Data</button> </div>
    </div>

<script>
    // --- Constants (Simplified) ---
    const MAX_IMAGE_SIZE_MB = 2;
    const MAX_IMAGE_SIZE_BYTES = MAX_IMAGE_SIZE_MB * 1024 * 1024;
    const LS_PREFIX = 'qbit_simplified_'; // Use a different prefix if needed
    const LS_USERNAME = LS_PREFIX + 'username'; // Added for username persistence
    const LS_THEME = LS_PREFIX + 'theme';
    const LS_FONTSIZE = LS_PREFIX + 'fontSize';
    const LS_FONTFAMILY = LS_PREFIX + 'fontFamily';
    const LS_GAMES = LS_PREFIX + 'games';
    const LS_CATEGORIES = LS_PREFIX + 'categories';
    const LS_WARNONCLOSE = LS_PREFIX + 'warnOnClose';
    const LS_INITIALIZED = LS_PREFIX + 'initialized_v5'; // Increment version if defaults change (v4->v5 for game list update)
    const LS_BGIMAGE_ENABLED = LS_PREFIX + 'bgImageEnabled';
    const LS_BGIMAGE_URL = LS_PREFIX + 'bgImageUrl';
    // Removed backend, chat, login, ban constants

    // --- DOM Element References (Simplified) ---
    let mainContent, settingsPanel, root, body, faviconLink,
        gameModal, gameModalTitle, gameIdInput, gameNameInput, gameUrlInput,
        gameCategorySelect, addCategoryBtn, saveGameBtn, cancelGameBtn,
        fontSizeSlider, fontSizeThumb, fontSizeValueDisplay, fontSizeProgress,
        themeSelector, fontSelector, settingsBtn, searchInput, warnOnCloseSwitch,
        bgImageToggleSwitch, bgImageControlContainer, bgImageFileInput, clearBgImageBtn,
        sidebarGamesBtn, sidebarProxyBtn, sidebarToolsBtn, // Re-added sidebarProxyBtn
        settingsUsernameInput, saveUsernameBtn, // Added refs for username setting
        clearDataBtn, // Added ref for clear data button
        welcomeAreaPlaceholder;
    // Removed refs for login/register modals, chat elements, logout button

    // --- Global State (Simplified) ---
    let currentUsername = 'Guest'; // Replaces isLoggedIn/loggedInUsername
    let currentThemeColor = '#444444';
    let games = [];
    let categories = [];
    let isEditingGame = false;
    let warnOnClose = false;
    let bgImageEnabled = false;
    let bgImageUrl = '';
    let debounceTimer;
    // Removed state for login, bans, chat polling

    // --- SVG Icons ---
    const ICONS = {
        play: `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`,
        edit: `<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`,
        delete: `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`,
        proxyPlay: `<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>` // Globe Icon
    };

    // --- Helper Functions (debounce, hash, color, logo) ---
    function debounce(func, delay) { return function(...args) { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => { func.apply(this, args); }, delay); }; }
    function simpleHash(str) { let hash = 5381; for (let i = 0; i < str.length; i++) { const char = str.charCodeAt(i); hash = ((hash << 5) + hash) + char; } return Math.abs(hash); }
    function stringToHslColor(str, s = 65, l = 55) { if (!str) str = "default"; const hash = simpleHash(str); const h = hash % 360; return `hsl(${h}, ${s}%, ${l}%)`; }
    function getLogoSvg(color) { const safeColor = color || '#444444'; return `<svg width="40" height="40" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" fill="${safeColor}"><rect x="5" y="9" width="7" height="14" rx="2.5"/><rect x="13" y="9" width="7" height="14" rx="2.5"/><rect x="21" y="9" width="7" height="14" rx="2.5"/></svg>`; }
    function generateUserPfpSvg(username) { const userColor = stringToHslColor(username, 65, 55); return getLogoSvg(userColor); }

    // --- LocalStorage/Settings Helpers ---
    function updateFavicon(color) { if (!faviconLink) return; const svgString = getLogoSvg(color); const dataUri = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgString)}`; faviconLink.href = dataUri; }
    function saveSetting(key, value) { try { localStorage.setItem(key, value); } catch (e) { console.error(`LS Save Error for key "${key}":`, e); if (e.name === 'QuotaExceededError') alert(`Could not save setting. Storage limit reached.`); } }
    function removeSetting(key) { try { localStorage.removeItem(key); } catch (e) { console.error(`LS Remove Error for key "${key}":`, e); } }
    function updateSelectArrowColor(textColor = '#ffffff') { const styleId = 'dynamic-select-arrow-style'; let el = document.getElementById(styleId); if (!el) { el = document.createElement('style'); el.id = styleId; document.head.appendChild(el); } const safeColor = encodeURIComponent((textColor || '#ffffff').substring(1)); const svgUrl = `data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23${safeColor}%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E`; el.textContent = ` .settings-panel select, .modal-box select { background-image: url('${svgUrl}'); } `; }

    // --- Authentication/Ban Functions Removed ---

    // --- Get Username on Load (No Prompt if Exists) ---
    function loadOrPromptUsername() {
        const savedUsername = localStorage.getItem(LS_USERNAME);
        // Only prompt if username is missing, empty, or still 'Guest'
        if (!savedUsername || savedUsername.trim() === '' || savedUsername === 'Guest') {
            promptForUsername(); // Call the prompt function
        } else {
            currentUsername = savedUsername; // Load existing username
            console.log(`Username loaded: ${currentUsername}`);
            updateUsernameDisplay(); // Update display
        }
    }

    // --- Prompt for Username (Only called when needed) ---
    function promptForUsername() {
        const name = prompt("Please enter your username:", "Guest"); // Default to Guest if prompt shown

        if (name && name.trim() && name.trim() !== 'Guest') {
            currentUsername = name.trim().substring(0, 30); // Limit length
            saveSetting(LS_USERNAME, currentUsername); // Save immediately if changed/entered
        } else {
            currentUsername = 'Guest'; // Fallback or if prompt cancelled/empty/Guest
            // Optionally save 'Guest' back if you want to avoid prompting again
            // saveSetting(LS_USERNAME, currentUsername);
        }
        console.log(`Username set to: ${currentUsername}`);
        updateUsernameDisplay(); // Update display if element exists
    }


    // --- Handle Username Update from Settings ---
    function handleUpdateUsername() {
        if (!settingsUsernameInput || !saveUsernameBtn) return;

        const newName = settingsUsernameInput.value.trim();
        if (!newName) {
            alert("Username cannot be empty.");
            settingsUsernameInput.value = currentUsername; // Reset input
            return;
        }
        if (newName === currentUsername) {
             // Optional: Provide feedback that name is unchanged
             saveUsernameBtn.textContent = 'Saved!';
             setTimeout(() => { saveUsernameBtn.textContent = 'Save'; }, 1500);
             return;
        }

        currentUsername = newName.substring(0, 30); // Limit length
        saveSetting(LS_USERNAME, currentUsername); // Save to localStorage
        console.log(`Username updated to: ${currentUsername}`);

        updateUsernameDisplay(); // Update any top-level display
        // Update welcome message if visible
        const welcomeMsgEl = document.getElementById('welcome-message');
        if (welcomeMsgEl) {
             welcomeMsgEl.textContent = `Welcome, ${currentUsername.replace(/</g, "&lt;").replace(/>/g, "&gt;")}!`;
        }

        // Provide feedback
        saveUsernameBtn.textContent = 'Saved!';
        setTimeout(() => { saveUsernameBtn.textContent = 'Save'; }, 1500);
    }


    // --- Helper to update display (optional) ---
    function updateUsernameDisplay() {
         // Example: If you add <span id="usernameDisplay"></span> in the topbar
         // const displayEl = document.getElementById('usernameDisplay');
         // if (displayEl) {
         //      displayEl.textContent = `User: ${currentUsername.replace(/</g, "&lt;")}`;
         // }
         // Update settings input field as well
         if (settingsUsernameInput) {
             settingsUsernameInput.value = currentUsername;
         }
    }

    // --- Welcome Area ---
    function displayWelcomeMessage(name) { // Accepts username
        console.log("[DEBUG] Displaying welcome message for:", name);
        if (!mainContent) return;
        mainContent.innerHTML = ''; // Clear previous content

        const welcomeArea = document.createElement('div');
        welcomeArea.id = 'welcome-area';

        const logoContainer = document.createElement('div');
        logoContainer.id = 'welcome-logo-container';
        logoContainer.innerHTML = getLogoSvg(currentThemeColor);

        const messageHeading = document.createElement('h1');
        messageHeading.id = 'welcome-message';
        messageHeading.textContent = `Welcome, ${name.replace(/</g, "&lt;").replace(/>/g, "&gt;")}!`; // Use passed name

        // User Count Removed

        const changelogDiv = document.createElement('div');
        changelogDiv.id = 'changelog-section';
        // Keep changelog content as is, or update it
        changelogDiv.innerHTML = `<h2>Changelog</h2><div class="changelog-version"><h4>v1.4</h4><ul><li>Games now open directly by default.</li><li>Added optional "Play with Proxy" button (🌐) to games for the internal proxy method.</li></ul></div><div class="changelog-version"><h4>v1.3</h4><ul><li>Username prompt only appears on first load or after data clear.</li><li>Games opened via an internal proxy (allorigins.win) to handle navigation within the game window.</li></ul></div><div class="changelog-version"><h4>v1.2</h4><ul><li>Added themed scrollbars.</li><li>Added Clear All Data button to settings.</li><li>Replaced Slither.io with Snake.io and added 10 more .io games.</li></ul></div><div class="changelog-version"><h4>v1.1</h4><ul><li>Re-added Proxy section.</li><li>Added ability to change username in Settings.</li></ul></div><div class="changelog-version"><h4>v1.0</h4><ul><li>Initial simplified version.</li></ul></div>`; // Updated changelog

        welcomeArea.appendChild(logoContainer);
        welcomeArea.appendChild(messageHeading);
        // Removed user count append
        welcomeArea.appendChild(changelogDiv);
        mainContent.appendChild(welcomeArea);

        mainContent.style.opacity = 1; // Trigger fade-in
        // Removed startUserCountPolling()
    }
    function updateWelcomeLogoColor(color) { const wa=document.getElementById('welcome-area'); if(!wa) return; const lse=wa.querySelector('#welcome-logo-container svg'); if(lse){ const sc=color||'#444444'; lse.setAttribute('fill', sc); lse.querySelectorAll('rect').forEach(r=>r.setAttribute('fill', sc)); } }

    // --- Game & Category Management ---
    function loadGames() {
        // Updated default games list
        const dg = [
            // Strategy
            {id: crypto.randomUUID(), name: "N-GON", url: "https://landgreen.github.io/n-gon/index.html", category: "Strategy"},
            {id: crypto.randomUUID(), name: "Netquel", url: "https://netquel.com/", category: "Strategy"},
            {id: crypto.randomUUID(), name: "MK48", url: "https://mk48.io/", category: "Strategy"},
            {id: crypto.randomUUID(), name: "Starblast.io", url: "https://starblast.io/", category: "Strategy"}, // Also Action
            {id: crypto.randomUUID(), name: "Tanx", url:"https://tanx.io/", category:"Strategy"}, // Also Action
            {id: crypto.randomUUID(), name: "Diep.io", url: "https://diep.io/", category: "Strategy"}, // Added
            {id: crypto.randomUUID(), name: "ZombsRoyale.io", url: "https://zombsroyale.io/", category: "Strategy"}, // Added (Battle Royale)
            {id: crypto.randomUUID(), name: "Bloxd.io", url: "https://bloxd.io/", category: "Strategy"}, // Added (Voxel/Building)

            // Action / Shooter / .io
            {id: crypto.randomUUID(), name: "Dead Shot", url: "https://deadshot.io/", category: "Action"},
            {id: crypto.randomUUID(), name: "Ships 3D", url: "https://yp3d.com/ships3d/", category: "Action"},
            {id: crypto.randomUUID(), name: "Shell Shockers", url: "https://shellshock.io/", category: "Action"},
            {id: crypto.randomUUID(), name: "Snake.io", url: "https://snake.io/", category: "Action"}, // Replaced Slither.io
            {id: crypto.randomUUID(), name: "Venge.io", url: "https://venge.io/", category: "Action"},
            {id: crypto.randomUUID(), name: "Robostorm.io", url: "https://robostorm.io/", category: "Action"},
            {id: crypto.randomUUID(), name: "Agar.io", url: "https://agar.io/", category: "Action"}, // Added
            {id: crypto.randomUUID(), name: "Krunker.io", url: "https://krunker.io/", category: "Action"}, // Added
            {id: crypto.randomUUID(), name: "Paper.io 2", url: "https://paper-io.com/", category: "Action"}, // Added
            {id: crypto.randomUUID(), name: "Ev.io", url: "https://ev.io/", category: "Action"}, // Added

            // Racing / Driving
            {id: crypto.randomUUID(), name: "HexGL", url: "https://hexgl.bkcore.com/", category: "Racing"},
            {id: crypto.randomUUID(), name: "Madalin Stunt Cars 2", url: "https://madalinstuntcars2.io/", category: "Racing"},

            // Platformer / Skill
            {id: crypto.randomUUID(), name: "Geometry Dash", url: "https://geometrylite.github.io", category: "Skill"}, // Unofficial web port
            {id: crypto.randomUUID(), name: "Tetr.io", url: "https://tetr.io/", category: "Skill"}, // Added (Tetris)

            // Adventure / Exploration
             {id: crypto.randomUUID(), name: "Aritelia", url: "https://aritelia.io/", category: "Adventure"}, // Metaverse/Exploration

            // Educational
            {id: crypto.randomUUID(), name: "Interland", url: "https://beinternetawesome.withgoogle.com/en_us/interland", category: "Educational"},

             // Drawing / Social
             {id: crypto.randomUUID(), name: "Skribbl.io", url: "https://skribbl.io/", category: "Drawing"}, // Added
             {id: crypto.randomUUID(), name: "Gartic.io", url: "https://gartic.io/", category: "Drawing"}, // Added
        ];
        try {
            // Logic to load from localStorage or use defaults
            if (!localStorage.getItem(LS_INITIALIZED)) {
                console.log("[DEBUG] First run or reset. Loading default games.");
                games = dg;
                saveGames();
                localStorage.setItem(LS_INITIALIZED, 'true');
            } else {
                const sg = localStorage.getItem(LS_GAMES);
                try { games = sg ? JSON.parse(sg) : []; }
                catch (pe) { console.error("Error parsing stored games:", pe); games = dg; } // Fallback to defaults on error
            }
        } catch (e) { console.error("Error loading games:", e); games = dg; } // Fallback to defaults on error
    }
    function saveGames() { try { saveSetting(LS_GAMES, JSON.stringify(games)); } catch (e) { console.error("Failed to save games:", e); } }
    function loadCategories() { const dc=['Action','Puzzle','Strategy','Simulation','Misc','Horror','Media','Coding','Conversation', 'Racing', 'Skill', 'Adventure', 'Educational', 'Drawing']; try { const sc=localStorage.getItem(LS_CATEGORIES); categories=sc?JSON.parse(sc):dc; } catch (e){ console.error("Failed load categories:",e); categories=dc; } dc.forEach(c=>{if(!categories.includes(c))categories.push(c);}); categories.sort(); }
    function saveCategories() { try { saveSetting(LS_CATEGORIES, JSON.stringify(categories)); } catch (e) { console.error("Failed save categories:", e); } }
    function populateCategorySelect(se, sc="") { if (!se) return; se.innerHTML='<option value="">Uncategorized</option>'; categories.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;if(c===sc)o.selected=true;se.appendChild(o);}); }
    function handleAddCategory() { const cs=document.getElementById('gameCategorySelect'); if(!cs)return; const nc=prompt("Enter new category name:"); if(nc && nc.trim()){const tc=nc.trim(); if(!categories.includes(tc)){categories.push(tc);categories.sort();saveCategories();populateCategorySelect(cs,tc);} else {alert("Category exists!");cs.value=tc;}} }
    function renderGames() {
        const container=mainContent?mainContent.querySelector('.game-list-container'):null;
        if(!container)return;
        container.innerHTML='';
        let ngfp=mainContent.querySelector('#no-games-found');
        if(!ngfp && games.length === 0){
            container.innerHTML='<p id="no-games-found" style="grid-column:1/-1;text-align:center;opacity:0.7;color:var(--text);">No games added yet.</p>';
            ngfp=mainContent.querySelector('#no-games-found');
        } else if(ngfp){
            ngfp.style.display='none';
        }
        if(games.length > 0){
            games.forEach((g, index)=>{
                const card=document.createElement('div');
                card.className='game-card';
                card.dataset.id=g.id;
                card.setAttribute('tabindex','0');
                card.style.animationDelay = `${0.05 * (index + 1)}s`;
                // Added proxy-play-btn
                card.innerHTML=`
                    <div class="game-card-header">
                        <img class="game-favicon" alt="" width="16" height="16" loading="lazy">
                        <h4></h4>
                    </div>
                    <p class="category"></p>
                    <div class="game-card-actions">
                        <button class="play-btn" title="Play Game">${ICONS.play}</button>
                        <button class="proxy-play-btn" title="Play with Proxy">${ICONS.proxyPlay}</button> <button class="edit-btn" title="Edit Game">${ICONS.edit}</button>
                        <button class="delete-btn" title="Delete Game">${ICONS.delete}</button>
                    </div>`;
                const ne=card.querySelector('h4');
                const ce=card.querySelector('p.category');
                const fe=card.querySelector('.game-favicon');
                ne.textContent=g.name.replace(/</g,"&lt;");
                ce.textContent=g.category||'Uncategorized';
                if(fe){
                    fe.alt=`${g.name} Favicon`;
                    if(g.url && (g.url.startsWith('http://')||g.url.startsWith('https://'))){
                        try{
                            const gu=new URL(g.url);
                            const hn=gu.hostname;
                            const fsu=`https://www.google.com/s2/favicons?domain=${hn}&sz=32`;
                            fe.src=fsu;
                            fe.onerror=()=>{fe.style.display='none';};
                            fe.style.display='inline-block';
                        } catch(e) {
                            fe.style.display='none';
                        }
                    } else {
                        fe.style.display='none';
                    }
                }
                // Keydown listener for main card (still opens direct)
                card.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();openInAboutBlank(g.url,g.name);}});
                // Play button opens direct
                card.querySelector('.play-btn').onclick=(e)=>{e.stopPropagation();openInAboutBlank(g.url,g.name);};
                // Proxy Play button opens via proxy
                card.querySelector('.proxy-play-btn').onclick=(e)=>{e.stopPropagation();openGameInProxiedIframe(g.url,g.name);};
                // Edit and Delete buttons
                card.querySelector('.edit-btn').onclick=(e)=>{e.stopPropagation();openGameModal(g);};
                card.querySelector('.delete-btn').onclick=(e)=>{e.stopPropagation();deleteGame(g.id,card);};
                container.appendChild(card);
            });
        }
        filterGames();
    }
    function openGameModal(gte=null) { const m=document.getElementById('gameModal');const t=document.getElementById('gameModalTitle');const ii=document.getElementById('gameIdInput');const ni=document.getElementById('gameNameInput');const ui=document.getElementById('gameUrlInput');const cs=document.getElementById('gameCategorySelect');const sb=document.getElementById('saveGameBtn'); if(!m||!t||!ii||!ni||!ui||!cs||!sb)return; isEditingGame=!!gte;ii.value='';ni.value='';ui.value='';ni.style.borderColor='';ui.style.borderColor='';populateCategorySelect(cs,gte?gte.category:"");if(isEditingGame){t.textContent='Edit Game';ii.value=gte.id;ni.value=gte.name;ui.value=gte.url;sb.textContent='Save Changes';}else{t.textContent='Add New Game';sb.textContent='Add Game';} m.classList.add('visible');ni.focus();}
    function closeGameModal() { const m=document.getElementById('gameModal'); if(m)m.classList.remove('visible'); isEditingGame=false; }
    function handleSaveGame() { const ni=document.getElementById('gameNameInput');const ui=document.getElementById('gameUrlInput');const cs=document.getElementById('gameCategorySelect');const ii=document.getElementById('gameIdInput'); if(!ni||!ui||!cs||!ii)return; const name=ni.value.trim(); const url=ui.value.trim(); const category=cs.value; const id=ii.value; let iv=true; if(!name){ni.style.borderColor='red';iv=false;}else{ni.style.borderColor='';} if(!url||!url.match(/^(https?:\/\/|.\/|..\/|\/)/)){ui.style.borderColor='red';iv=false;alert("Valid URL needed (http://, https://, /, ./, ../)");}else{ui.style.borderColor='';} if(!iv)return; if(isEditingGame&&id){const gi=games.findIndex(g=>g.id===id); if(gi>-1){games[gi]={...games[gi],name,url,category};}else{console.error("Edit fail: ID not found");closeGameModal();return;}}else{const ng={id:crypto.randomUUID(),name,url,category};games.push(ng);} saveGames();renderGames();closeGameModal();}
    function deleteGame(id, ce) { if (!confirm(`Delete this game?`)) return; if (ce) { ce.classList.add('deleting'); ce.addEventListener('animationend', () => { games = games.filter(g => g.id !== id); saveGames(); renderGames(); }, { once: true }); } else { games = games.filter(g => g.id !== id); saveGames(); renderGames(); } }

    // --- Game Playing function removed (buttons call specific methods now) ---

    // --- Standard Link Opening (Used by default Game play, Proxy sites, Tools) ---
    function openInAboutBlank(url, title = 'Content') {
        if (!url || !url.match(/^(https?:\/\/|.\/|..\/|\/)/)) {
            console.error("Invalid URL provided:", url);
            alert("Cannot open link: Invalid URL provided.");
            return;
        }
        const newWindow = window.open('', '_blank');
        if (newWindow) {
            try {
                newWindow.document.open();
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>${title.replace(/</g, "&lt;")}</title>
                        <style>html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#000;}iframe{display:block;width:100%;height:100%;border:none;}</style>
                    </head>
                    <body>
                        <iframe src="${url}" frameborder="0" allowfullscreen sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-top-navigation-by-user-activation"></iframe>
                        <script>
                            const shouldWarnOnClose = ${warnOnClose};
                            window.addEventListener('beforeunload', (event) => {
                                if (shouldWarnOnClose) {
                                    const confirmationMessage = 'Closing this window might interrupt your session. Are you sure?';
                                    event.preventDefault();
                                    event.returnValue = confirmationMessage;
                                    return confirmationMessage;
                                }
                            });
                        <\/script>
                    </body>
                    </html>
                `);
                newWindow.document.close();
            } catch (e) {
                console.error("Error writing direct iframe to new window:", e);
                try { newWindow.location.href = url; } // Fallback navigation
                catch (e2) { console.error("Error navigating new window:", e2); alert("Could not open link. Check pop-up blocker."); newWindow.close(); }
            }
        } else {
            alert("Could not open link. Please check pop-up blocker.");
        }
    }

    // --- Open Game using AllOrigins Proxy (Used by Proxy Play button) ---
    function openGameInProxiedIframe(url, title = 'Game') {
        if (!url || !url.match(/^https?:\/\//)) { // Require http/https for proxy
            console.error("Invalid URL for proxy:", url);
            alert("Cannot open game via proxy: Invalid or non-HTTP(S) URL provided.");
            return;
        }

        const newWindow = window.open('', '_blank');
        if (!newWindow) {
            alert("Could not open game window. Please check pop-up blocker.");
            return;
        }

        // Initial loading message
        newWindow.document.open();
        newWindow.document.write(`
            <!DOCTYPE html><html><head><title>Loading ${title.replace(/</g, "&lt;")} (via Proxy)...</title><style>body{font-family:sans-serif; background:#111; color:#eee; display:flex; justify-content:center; align-items:center; height:100vh; margin:0;}div{text-align:center;}p{margin-top:5px;opacity:0.7;}</style></head><body><div><h2>Loading Game via Proxy...</h2><p>Please wait.</p></div></body></html>
        `);
        newWindow.document.close();

        // Function to fetch content via proxy and inject it
        const fetchAndInject = async (targetUrl, windowRef) => {
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;
            console.log(`[Proxy Fetch] Requesting: ${targetUrl} via ${proxyUrl}`);

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    throw new Error(`Network response was not ok. Status: ${response.status}`);
                }
                const data = await response.json();

                if (!data.contents) {
                    throw new Error("Proxy response did not contain 'contents'.");
                }

                let htmlContent = data.contents;

                // --- Inject Base Tag and Interception Script ---
                // Create a base URL from the target URL to resolve relative paths
                let baseHref = '';
                try {
                    const urlObject = new URL(targetUrl);
                    baseHref = urlObject.origin + (urlObject.pathname.endsWith('/') ? urlObject.pathname : urlObject.pathname.substring(0, urlObject.pathname.lastIndexOf('/') + 1));
                } catch (e) {
                    console.warn("Could not create base URL, relative paths might break.", e);
                    baseHref = targetUrl; // Fallback
                }

                const interceptScript = `
                    <script>
                        const currentBaseUrl = document.baseURI; // Get the base URL set by <base> tag
                        const shouldWarnOnClose = ${warnOnClose};

                        // Function to fetch and replace content (defined inside iframe)
                        async function fetchAndReplace(newUrl) {
                            // Show loading indicator maybe?
                            document.body.style.opacity = '0.5';
                            document.body.style.pointerEvents = 'none';

                            const proxyFetchUrl = \`https://api.allorigins.win/get?url=\${encodeURIComponent(newUrl)}\`;
                            console.log('[Iframe Proxy Fetch] Requesting:', newUrl, 'via', proxyFetchUrl);
                            try {
                                const resp = await fetch(proxyFetchUrl);
                                if (!resp.ok) throw new Error('Proxy fetch failed: ' + resp.status);
                                const newData = await resp.json();
                                if (!newData.contents) throw new Error('Proxy response missing contents.');

                                // Calculate new base URL
                                let newBase = '';
                                try {
                                    const newUrlObj = new URL(newUrl);
                                    newBase = newUrlObj.origin + (newUrlObj.pathname.endsWith('/') ? newUrlObj.pathname : newUrlObj.pathname.substring(0, newUrlObj.pathname.lastIndexOf('/') + 1));
                                } catch(e) { newBase = newUrl; }

                                // Replace content, keeping the script logic
                                const baseTag = '<base href="' + newBase + '">';
                                // IMPORTANT: Re-inject the script itself!
                                const scriptTag = '<script>' + document.currentScript.innerHTML.replace(/<\\/script>/g, '<\\\\/script>') + '<\\/script>';
                                document.open();
                                document.write('<!DOCTYPE html>' + baseTag + newData.contents + scriptTag);
                                document.close();

                            } catch (error) {
                                console.error('Error fetching/replacing content:', error);
                                alert('Failed to load content: ' + error.message);
                                // Restore interaction on error
                                document.body.style.opacity = '1';
                                document.body.style.pointerEvents = 'auto';
                            }
                        }

                        // Intercept clicks on links
                        document.addEventListener('click', function(event) {
                            let targetElement = event.target;
                            while (targetElement && targetElement.tagName !== 'A') {
                                targetElement = targetElement.parentNode;
                            }

                            if (targetElement && targetElement.tagName === 'A') {
                                const href = targetElement.getAttribute('href');
                                const targetAttr = targetElement.getAttribute('target');

                                // Only intercept if href exists, is not just '#', and target is not _blank etc.
                                if (href && href.trim() !== '' && href !== '#' && (!targetAttr || targetAttr === '_self' || targetAttr === '_top')) {
                                    // Avoid intercepting javascript: links
                                    if(href.toLowerCase().startsWith('javascript:')) {
                                        console.log('Ignoring javascript: link');
                                        return;
                                    }
                                    event.preventDefault(); // Stop default navigation
                                    const absoluteUrl = new URL(href, currentBaseUrl).href;
                                    console.log('Intercepted link click:', href, '->', absoluteUrl);
                                    fetchAndReplace(absoluteUrl);
                                }
                            }
                        }, true); // Use capture phase

                        // Intercept form submissions
                        document.addEventListener('submit', function(event) {
                             const form = event.target;
                             const action = form.getAttribute('action');
                             const method = form.getAttribute('method')?.toLowerCase() || 'get';

                             if (action) {
                                 event.preventDefault(); // Stop default submission
                                 const absoluteUrl = new URL(action, currentBaseUrl).href;
                                 console.log('Intercepted form submission:', action, '->', absoluteUrl);
                                 // TODO: Handle form data for POST requests if needed (more complex)
                                 fetchAndReplace(absoluteUrl); // Simple fetch for now (ignores method and data)
                             }
                        }, true); // Use capture phase

                        // Warn on close listener
                        window.addEventListener('beforeunload', (event) => {
                            if (shouldWarnOnClose) {
                                const confirmationMessage = 'Closing this window might interrupt your game/session. Are you sure?';
                                event.preventDefault();
                                event.returnValue = confirmationMessage;
                                return confirmationMessage;
                            }
                        });

                        console.log('Proxy interception script loaded. Base URL:', currentBaseUrl);
                    <\/script>
                `;

                // Inject into the new window
                windowRef.document.open();
                const doctype = htmlContent.toLowerCase().startsWith('<!doctype') ? '' : '<!DOCTYPE html>';
                windowRef.document.write(doctype + '<base href="' + baseHref + '">' + htmlContent + interceptScript);
                windowRef.document.close();
                // Set title after content is loaded
                windowRef.document.title = title.replace(/</g, "&lt;") + " (Proxy)";
                console.log(`[Proxy Fetch] Content injected for: ${targetUrl}`);

            } catch (error) {
                console.error(`[Proxy Fetch] Error fetching ${targetUrl}:`, error);
                try {
                    windowRef.document.body.innerHTML = `
                        <div style="color:red; padding: 20px; text-align:center;">
                            <h2>Error Loading Game via Proxy</h2>
                            <p>Could not load content from: ${targetUrl.replace(/</g, "&lt;")}</p>
                            <p>Error: ${error.message.replace(/</g, "&lt;")}</p>
                            <p><small>The proxy might be blocked, the site might be down, or the content is incompatible.</small></p>
                        </div>`;
                    windowRef.document.title = "Proxy Load Error";
                } catch (writeError) {
                     console.error("Failed to write error message to window:", writeError);
                     windowRef.close(); // Close if we can't even write error
                     alert(`Failed to load game via proxy: ${error.message}`);
                }
            }
        };

        // Initial fetch
        fetchAndInject(url, newWindow);
    }


    // --- Tools Section ---
    function renderTools() {
        if (!mainContent) return;
        mainContent.innerHTML = ''; // Clear previous content

        const toolsList = [
            { name: "ChatGPT", url: "https://cars.happyforever.com/&?q=ChatGPT", description: "AI Language Model" },
            { name: "VS-Code", url: "https://cars.happyforever.com/&?q=VS%20Code", description: "Web-based Code Editor" },
            { name: "Online Calculator", url: "https://www.calculator.net/", description: "General purpose calculator" },
            { name: "Unit Converter", url: "https://www.calculator.net/conversion-calculator.html", description: "Convert various units" },
            { name: "Google Canvas", url: "https://canvas.apps.chrome/", description: "Simple drawing tool" },
            { name: "Dice Roller", url: "https://webutility.io/tools/dice-roller/", description: "Roll virtual dice" },
            { name: "Coin Flip", url: "https://webutility.io/tools/flip-coin/", description: "Flip a virtual coin" },
            { name: "Quick Draw", url: "https://quickdraw.withgoogle.com/", description: "AI Drawing Game" },
            { name: "Web Utilities", url: "https://webutility.io/", description: "Collection of web tools" }
        ];

        const header = document.createElement('h2');
        header.textContent = 'Tools';
        mainContent.appendChild(header);

        const listContainer = document.createElement('div');
        // Reuse game-list-container class for grid layout
        listContainer.className = 'game-list-container tools-list-container'; // Use both classes
        mainContent.appendChild(listContainer);

        if (toolsList.length === 0) {
             listContainer.innerHTML = '<p style="grid-column:1/-1;text-align:center;opacity:0.7;">No tools available.</p>';
             return;
        }

        toolsList.forEach((tool, index) => {
            const card = document.createElement('div');
            // Reuse game-card class for styling
            card.className = 'game-card tool-card'; // Add specific tool-card class
            card.setAttribute('tabindex', '0');
            card.style.animationDelay = `${0.05 * (index + 1)}s`;
            // Use game-card structure, replacing category with description
            card.innerHTML = `
                <div class="game-card-header tool-card-header"><h4></h4></div>
                <p class="category">${tool.description.replace(/</g, "&lt;")}</p>
                <div class="game-card-actions tool-card-actions">
                    <button class="play-btn" title="Open ${tool.name.replace(/</g, "&lt;")}">${ICONS.play}</button>
                </div>`;

            card.querySelector('h4').textContent = tool.name.replace(/</g, "&lt;");

            // Add event listener to open the tool URL using the standard method
            const openTool = () => openInAboutBlank(tool.url, tool.name);
            card.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openTool(); } });
            card.querySelector('.play-btn').onclick = (e) => { e.stopPropagation(); openTool(); };

            listContainer.appendChild(card);
        });
         filterGames(); // Apply search filter immediately if needed
    }

     // --- Proxy Section (Re-added) ---
     function renderProxySites() {
         const container = mainContent; // Render directly into main content
         if (!container) return;
         container.innerHTML = ''; // Clear previous content

         const header = document.createElement('h2');
         header.textContent = 'Proxy Sites';
         container.appendChild(header);

         const listContainer = document.createElement('div');
         listContainer.className = 'proxy-list-container'; // Use specific class
         container.appendChild(listContainer);

         const spaceUrls = [
             "https://yessir.happyforever.com/",
             "https://fish.happyforever.com/",
             "https://turtle.happyforever.com/",
             "https://cars.happyforever.com/"
         ];
         const proxySites = [
             { name: "Space", url: null }, // Special case handled below
             { name: "Transend", url: "https://hw.billigerhost.com/" },
             { name: "RammerHead", url: "https://pluh.root.sx/" },
             { name: "Utopia", url: "https://bio.write.examinedbytopmen.com/" }
         ];

         if (proxySites.length === 0) {
              listContainer.innerHTML = '<p style="grid-column:1/-1;text-align:center;opacity:0.7;">No proxy sites available.</p>';
              return;
         }

         proxySites.forEach((s, index) => {
             const card = document.createElement('div');
             card.className = 'proxy-card'; // Use proxy-card class
             card.setAttribute('tabindex', '0');
             card.style.animationDelay = `${0.05 * (index + 1)}s`;
             card.innerHTML = `
                 <div><h4></h4></div>
                 <div class="proxy-card-actions">
                     <button class="play-btn" title="Open ${s.name.replace(/</g, "&lt;")}">${ICONS.play}</button>
                 </div> `;
             card.querySelector('h4').textContent = s.name.replace(/</g, "&lt;");

             const handleOpen = () => {
                 const urlToOpen = s.name === "Space" ? spaceUrls[Math.floor(Math.random() * spaceUrls.length)] : s.url;
                 if (urlToOpen) {
                     openInAboutBlank(urlToOpen, s.name); // Use standard method for proxies
                 } else {
                     alert("No URL configured for this proxy.");
                 }
             };
             card.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleOpen(); } });
             card.querySelector('.play-btn').onclick = (e) => { e.stopPropagation(); handleOpen(); };
             listContainer.appendChild(card);
         });
         filterGames(); // Apply search filter
      }


    // --- UI Section Management (Simplified & Updated) ---
    function showSection(section) {
        if (!mainContent) return;
        // Removed chat view logic
        // Removed user count polling stop

        // Removed login check

        mainContent.style.display = 'block';
        mainContent.style.opacity = 0;

        setTimeout(() => {
            mainContent.innerHTML = ''; // Clear content before adding new section
            mainContent.style.animation = 'none'; // Reset animation before applying fade

            let sectionContent = '';
            if (section === "welcome") {
                displayWelcomeMessage(currentUsername); // Use current username
            } else if (section === "games") {
                sectionContent = `<div id="games-section-header"><h2>My Games</h2><button id="addGameBtn">+ Add Game</button></div><div class="game-list-container"></div>`;
                mainContent.innerHTML = sectionContent;
                const addBtn = document.getElementById('addGameBtn');
                if (addBtn) addBtn.onclick = () => openGameModal();
                renderGames();
            } else if (section === "proxy") { // Re-added proxy case
                 renderProxySites();
            } else if (section === "tools") {
                renderTools(); // Call the function to render tools
            } else { // Default to welcome
                displayWelcomeMessage(currentUsername);
            }

            // Apply fade-in animation
            if (mainContent.innerHTML || section === "welcome" || section === "tools" || section === "proxy") { // Ensure fade-in happens for rendered sections
                requestAnimationFrame(() => {
                    mainContent.style.opacity = 0; // Ensure opacity is 0 before animation
                    mainContent.style.animation = "fadeIn 0.5s forwards";
                    mainContent.style.opacity = 1; // Set final state (though animation does this)
                });
            } else {
                mainContent.style.opacity = 1; // Fallback if no content was added
            }
        }, 50); // Short delay for smoother transition
    }

    // --- Settings Panel & Controls (Simplified) ---
    function handleSettingsButtonClick() { // Removed async
        if (!settingsBtn || !settingsPanel) return;

        // Removed ban check logic

        if (settingsPanel.classList.contains('show')) {
            settingsPanel.classList.remove('show');
             // Removed startBanStatusPolling();
            console.log("[DEBUG] Settings panel closed.");
        } else {
             // Removed stopBanStatusPolling();
            console.log("[DEBUG] Opening settings panel.");
            updateUsernameDisplay(); // Ensure input shows current name when opening
            settingsPanel.classList.add('show');
        }
        // Removed button disabling/enabling logic related to checks
    }
    function updateSliderVisuals(s,t,p,d) { if(!s||!t||!p||!d)return; try{const min=parseFloat(s.min)||12; const max=parseFloat(s.max)||24; const v=parseFloat(s.value)||16; let pct=((v-min)/(max-min))*100; pct=Math.max(0,Math.min(100,pct)); t.style.left=`${pct}%`; t.style.transform='translateX(-50%)'; p.style.width=`${pct}%`; d.textContent=`${Math.round(v)}px`;}catch(e){console.error("Slider update err:",e);} }
    function updateFontSize(v) { const s=document.getElementById('fontSizeSlider');const t=document.getElementById('fontSizeThumb');const p=document.getElementById('fontSizeProgress');const d=document.getElementById('fontSizeValue'); if(!s||!root)return; const val=v||s.value; root.style.setProperty("--font-size",`${val}px`); saveSetting(LS_FONTSIZE,val); updateSliderVisuals(s,t,p,d); }
    function updateFontFamily(fn) { const s=document.getElementById('fontSelector'); if(!s||!root)return; const v=fn||s.value; root.style.setProperty("--font-family",v); saveSetting(LS_FONTFAMILY,v); }
    function applyCustomBackground() { if(!root||!bgImageControlContainer||!bgImageToggleSwitch)return; if(bgImageEnabled){bgImageControlContainer.style.display='flex'; bgImageControlContainer.style.flexDirection='column'; /* Ensure controls stack */}else{bgImageControlContainer.style.display='none';} if(bgImageEnabled&&bgImageUrl&&bgImageUrl.startsWith('data:image/')){root.style.setProperty('--custom-bg-image',`url("${bgImageUrl}")`);}else{root.style.setProperty('--custom-bg-image','none');} bgImageToggleSwitch.checked=bgImageEnabled; }
    function handleImageFileSelect(e) { if(!e.target.files||e.target.files.length===0)return; const f=e.target.files[0]; if(!f.type.startsWith('image/')){alert("Select image file.");e.target.value=null;return;} if(f.size>MAX_IMAGE_SIZE_BYTES){alert(`Image too large (${(f.size/1024/1024).toFixed(1)}MB). Max ${MAX_IMAGE_SIZE_MB}MB.`);e.target.value=null;return;} const r=new FileReader(); r.onload=(le)=>{bgImageUrl=le.target.result;saveSetting(LS_BGIMAGE_URL,bgImageUrl);applyCustomBackground();console.log("BG saved.");}; r.onerror=(ee)=>{console.error("FileRead err:",ee);alert("Error reading file.");e.target.value=null;}; r.onabort=()=>{console.warn("FileRead abort.");e.target.value=null;}; r.readAsDataURL(f); }
    function clearCustomBackground() { bgImageUrl=''; removeSetting(LS_BGIMAGE_URL); if(bgImageFileInput)bgImageFileInput.value=null; applyCustomBackground(); }
    function updateTheme(theme) { const selector=document.getElementById('themeSelector'); if(!root||!body) return; const value=theme||(selector?selector.value:'dark'); let accentColor='#444444'; let textColorValue='#ffffff'; switch(value){ case "light": root.style.setProperty("--bg","#ffffff"); root.style.setProperty("--sidebar","#eeeeee"); root.style.setProperty("--topbar","#dddddd"); root.style.setProperty("--accent","#cccccc"); root.style.setProperty("--text","#1a1a1a"); accentColor='#cccccc'; textColorValue='#1a1a1a'; break; case "blue": root.style.setProperty("--bg","#0a0f1c"); root.style.setProperty("--sidebar","#091121"); root.style.setProperty("--topbar","#101a35"); root.style.setProperty("--accent","#395b9c"); root.style.setProperty("--text","#e0e0ff"); accentColor='#395b9c'; textColorValue='#e0e0ff'; break; case "forest": root.style.setProperty("--bg","#1f2e1f"); root.style.setProperty("--sidebar","#141e14"); root.style.setProperty("--topbar","#2a3f2a"); root.style.setProperty("--accent","#4a784a"); root.style.setProperty("--text","#e5f5e5"); accentColor='#4a784a'; textColorValue='#e5f5e5'; break; case "sunset": root.style.setProperty("--bg","#2b1a1a"); root.style.setProperty("--sidebar","#3a2525"); root.style.setProperty("--topbar","#4d3333"); root.style.setProperty("--accent","#b36b4a"); root.style.setProperty("--text","#ffe8e0"); accentColor='#b36b4a'; textColorValue='#ffe8e0'; break; case "trigonometrical-red": root.style.setProperty("--bg", "#ffffff"); root.style.setProperty("--sidebar", "#a02020"); root.style.setProperty("--topbar", "#b03030"); root.style.setProperty("--accent", "#e53e3e"); root.style.setProperty("--text", "#1a1a1a"); accentColor='#e53e3e'; textColorValue='#1a1a1a'; break; case "dark": default: root.style.setProperty("--bg","#1e1e1e"); root.style.setProperty("--sidebar","#111111"); root.style.setProperty("--topbar","#2c2c2c"); root.style.setProperty("--accent","#444444"); root.style.setProperty("--text","#ffffff"); accentColor='#444444'; textColorValue='#ffffff'; break; } currentThemeColor=accentColor; body.setAttribute('data-theme', value); updateSelectArrowColor(textColorValue); if(root.style && typeof root.style.setProperty==='function'){ const ca=getComputedStyle(root).getPropertyValue('--accent').trim(); const ct=getComputedStyle(root).getPropertyValue('--text').trim(); const ctb=getComputedStyle(root).getPropertyValue('--topbar').trim(); root.style.setProperty('--slider-track-bg', ca); root.style.setProperty('--slider-thumb-bg', ct); root.style.setProperty('--slider-progress-color', ct); root.style.setProperty('--game-card-bg', ctb); root.style.setProperty('--game-card-hover-bg', ca); } updateFavicon(accentColor); updateWelcomeLogoColor(accentColor); saveSetting(LS_THEME, value); applyCustomBackground(); }

    // --- Clear All Data Function ---
    function handleClearAllData() {
        if (!confirm('Are you absolutely sure? This will reset ALL settings, custom games, and categories to their defaults. This cannot be undone.')) {
            return; // User cancelled
        }

        console.warn("Clearing all application data from localStorage...");
        try {
            let keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(LS_PREFIX)) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                console.log(`Removed ${key}`);
            });

            console.log("Data cleared. Reloading application...");
            // Reload the page to apply defaults
            location.reload();

        } catch (e) {
            console.error("Error clearing data:", e);
            alert("An error occurred while trying to clear data.");
        }
    }


    // --- Search & Filtering (Updated to include Proxies & Tools) ---
    function filterGames() {
        const s_in=document.getElementById('search');
        const mc=document.getElementById('main-content');
        if(!s_in||!mc) return;
        const st=s_in.value.toLowerCase().trim();

        // Filter Game Cards
        const glc=mc.querySelector('.game-list-container:not(.tools-list-container)'); // Target game list specifically if possible
        let ngfm=mc.querySelector('#no-games-found'); // Specific message for games
        let vgc=0;
        if(glc){
            const gcs=glc.querySelectorAll('.game-card:not(.tool-card)'); // Exclude tool cards
             if(gcs.length>0){
                 gcs.forEach(c=>{
                     const ne=c.querySelector('h4');
                     const ce=c.querySelector('p.category');
                     const n=ne?ne.textContent.toLowerCase():'';
                     const cat=ce?ce.textContent.toLowerCase():'';
                     if(!st||n.includes(st)||cat.includes(st)){
                         c.style.display=''; vgc++;
                     } else {
                         c.style.display='none';
                     }
                 });
             } else { vgc = 0; } // No game cards found in container
        }

        // Handle "No Games Found" message specifically for the games section
        if (!ngfm && glc && games.length === 0 && !st) {
             const me=document.createElement('p'); me.id='no-games-found'; me.style.cssText="grid-column:1/-1;text-align:center;opacity:0.7;padding:20px;color:var(--text);"; me.textContent="No games added yet."; glc.appendChild(me); ngfm=me;
        } else if (ngfm) {
             const tg=games.length;
             // Check if this specific message element belongs to the game container
             const parentIsGameContainer = ngfm.closest('.game-list-container:not(.tools-list-container)');
             if (parentIsGameContainer) {
                 if (vgc===0 && tg>0 && st) { ngfm.textContent=`No games found matching "${s_in.value.trim()}"`; ngfm.style.display='block'; }
                 else if (vgc===0 && tg===0) { ngfm.textContent=`No games added yet.`; ngfm.style.display='block'; }
                 else { ngfm.style.display='none'; }
             } else {
                  ngfm.style.display='none'; // Hide if not in game container
             }
        }

        // Filter Tool Cards
        const tlc=mc.querySelector('.tools-list-container'); // Find tool container specifically
        if (tlc) {
            const tcs = tlc.querySelectorAll('.tool-card'); // Find tool cards by specific class
            tcs.forEach(c => {
                const ne = c.querySelector('h4');
                const de = c.querySelector('p.category'); // Using category para for description
                const n = ne ? ne.textContent.toLowerCase() : '';
                const desc = de ? de.textContent.toLowerCase() : '';
                if (!st || n.includes(st) || desc.includes(st)) { // Show if no search or match
                    c.style.display = '';
                } else {
                    c.style.display = 'none';
                }
            });
        }

        // Filter Proxy Cards
        const plc = mc.querySelector('.proxy-list-container');
        if (plc) {
            const pcs = plc.querySelectorAll('.proxy-card');
            pcs.forEach(c => {
                const ne = c.querySelector('h4');
                const n = ne ? ne.textContent.toLowerCase() : '';
                if (!st || n.includes(st)) { // Show if no search or match
                    c.style.display = '';
                } else {
                    c.style.display = 'none';
                }
            });
        }
    }
    const debouncedFilterGames = debounce(filterGames, 300);

    // --- Warn on Close Logic ---
    function handleMainBeforeUnload(e) { if(warnOnClose){const cm='Close Qbit? Changes might be lost.';e.preventDefault();e.returnValue=cm;return cm;} }

    // --- Chat Functions Removed ---
    // --- User Count Functions Removed ---

    // --- Load Settings & Initial Setup (Simplified) ---
    function loadSettingsAndInit() { // Removed async
        console.log("[DEBUG] loadSettingsAndInit called.");
        try {
            // --- Load basic settings ---
            const t=localStorage.getItem(LS_THEME)||'dark';
            const fs=localStorage.getItem(LS_FONTSIZE)||'16';
            const ff=localStorage.getItem(LS_FONTFAMILY)||"'Segoe UI', sans-serif";
            warnOnClose=localStorage.getItem(LS_WARNONCLOSE)==='true';
            bgImageEnabled=localStorage.getItem(LS_BGIMAGE_ENABLED)==='true';
            bgImageUrl=localStorage.getItem(LS_BGIMAGE_URL)||'';

            // --- Username is handled by loadOrPromptUsername called earlier ---
            // currentUsername = localStorage.getItem(LS_USERNAME) || 'Guest'; // Already set

            // --- Apply visual settings ---
            if(themeSelector)themeSelector.value=t; if(fontSelector)fontSelector.value=ff; if(fontSizeSlider)fontSizeSlider.value=fs; if(warnOnCloseSwitch)warnOnCloseSwitch.checked=warnOnClose; if(bgImageToggleSwitch)bgImageToggleSwitch.checked=bgImageEnabled;
            updateTheme(t); updateFontSize(fs); updateFontFamily(ff); applyCustomBackground();

            // --- Load app data ---
            loadGames(); loadCategories();

            // --- Final UI setup ---
            updateLoginUI(); // Update UI based on currentUsername
            if(warnOnClose) window.addEventListener('beforeunload',handleMainBeforeUnload);
            if(welcomeAreaPlaceholder) welcomeAreaPlaceholder.style.display='none'; // Hide loading placeholder
            showSection('welcome'); // Show initial section
            updateFavicon(currentThemeColor);

        } catch(e){
            console.error("Init err:", e);
            if(mainContent)mainContent.innerHTML=`<h2 style="color:red;">Error loading: ${e.message}</h2>`;
            // Reset to defaults on error
            updateTheme('dark'); updateFontSize('16'); updateFontFamily("'Segoe UI', sans-serif");
            currentUsername = 'Guest';
            updateLoginUI();
            showSection('welcome');
        }
        updateSelectArrowColor(getComputedStyle(root).getPropertyValue('--text').trim());
        console.log("[DEBUG] Init complete.");
    }

    // --- Update UI Based on Username (Simplified) ---
    function updateLoginUI() {
        updateUsernameDisplay(); // Update display span and settings input

        // Ensure section buttons are enabled
        const sectionBtns = [sidebarGamesBtn, sidebarProxyBtn, sidebarToolsBtn]; // Re-added proxy btn
        sectionBtns.forEach(btn => { if(btn) btn.disabled = false; });

        // Ensure settings button is enabled
        if (settingsBtn) settingsBtn.disabled = false;

        // Remove logout button logic
        // Remove chat input/button logic
    }

    // --- Event Listeners Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM ready.");
        try {
            // --- Find Elements ---
            mainContent=document.getElementById("main-content"); settingsPanel=document.getElementById("settingsPanel"); root=document.documentElement; body=document.body; faviconLink=document.getElementById('dynamic-favicon'); gameModal=document.getElementById('gameModal'); settingsBtn=document.getElementById('settingsBtn'); searchInput=document.getElementById('search'); welcomeAreaPlaceholder=document.getElementById('welcome-area-placeholder'); themeSelector=document.getElementById('themeSelector'); fontSelector=document.getElementById('fontSelector'); fontSizeSlider=document.getElementById('fontSizeSlider'); warnOnCloseSwitch=document.getElementById('warnOnCloseSwitch'); bgImageToggleSwitch=document.getElementById('bgImageToggleSwitch'); bgImageControlContainer=document.getElementById('bgImageControlContainer'); bgImageFileInput=document.getElementById('bgImageFileInput'); clearBgImageBtn=document.getElementById('clearBgImageBtn');
            fontSizeThumb = document.getElementById('fontSizeThumb'); fontSizeValueDisplay = document.getElementById('fontSizeValue'); fontSizeProgress = document.getElementById('fontSizeProgress');
            sidebarGamesBtn = document.getElementById('sidebarGamesBtn'); sidebarProxyBtn = document.getElementById('sidebarProxyBtn'); sidebarToolsBtn = document.getElementById('sidebarToolsBtn'); // Re-added proxy btn ref
            settingsUsernameInput = document.getElementById('settingsUsernameInput'); // Added ref
            saveUsernameBtn = document.getElementById('saveUsernameBtn'); // Added ref
            clearDataBtn = document.getElementById('clearDataBtn'); // Added ref for clear data button
            gameModalTitle=document.getElementById('gameModalTitle'); gameIdInput=document.getElementById('gameIdInput'); gameNameInput=document.getElementById('gameNameInput'); gameUrlInput=document.getElementById('gameUrlInput'); gameCategorySelect=document.getElementById('gameCategorySelect'); addCategoryBtn=document.getElementById('addCategoryBtn'); saveGameBtn=document.getElementById('saveGameBtn'); cancelGameBtn=document.getElementById('cancelGameBtn');
            // Removed refs for deleted elements

            const criticalElements = { mainContent, settingsPanel, root, body, gameModal, settingsBtn, searchInput, settingsUsernameInput, saveUsernameBtn, clearDataBtn }; // Updated critical list
            const missingCritical = Object.entries(criticalElements).filter(([k, v]) => !v).map(([k]) => k);
            if (missingCritical.length > 0) throw new Error(`Missing critical elements: ${missingCritical.join(', ')}`);

        } catch(e){ console.error("FATAL: Element finding error:", e); document.body.innerHTML=`<div style="padding:30px;color:red;background:#333;"><h2>App Init Error</h2><p>${e.message}</p></div>`; return; }

        // --- Load or Prompt for Username ---
        loadOrPromptUsername(); // Determine username first

        // --- Then Load Settings & Initialize UI ---
        loadSettingsAndInit(); // This will now use the determined currentUsername

        console.log("Attaching listeners.");

        // --- Settings Button Listener ---
        settingsBtn.addEventListener('click', handleSettingsButtonClick);

        // --- Listener to close settings panel ---
        document.addEventListener('click', (event) => {
            if (settingsPanel && settingsPanel.classList.contains('show') &&
                !settingsPanel.contains(event.target) && !settingsBtn.contains(event.target))
            {
                console.log("[DEBUG] Click outside settings panel detected. Closing panel.");
                settingsPanel.classList.remove('show');
                // Removed startBanStatusPolling();
            }
        });

        // --- Other Standard Listeners ---
        searchInput.addEventListener('input',debouncedFilterGames);
        if(saveGameBtn)saveGameBtn.addEventListener('click',handleSaveGame); if(cancelGameBtn)cancelGameBtn.addEventListener('click',closeGameModal); if(addCategoryBtn)addCategoryBtn.addEventListener('click',handleAddCategory); if(gameModal)gameModal.addEventListener('click',(e)=>{if(e.target===gameModal)closeGameModal();});
        fontSizeSlider.addEventListener('input',(e)=>updateFontSize(e.target.value)); warnOnCloseSwitch.addEventListener('change',(e)=>{ warnOnClose=e.target.checked; saveSetting(LS_WARNONCLOSE,warnOnClose); if(warnOnClose)window.addEventListener('beforeunload',handleMainBeforeUnload); else window.removeEventListener('beforeunload',handleMainBeforeUnload); });
        bgImageToggleSwitch.addEventListener('change',(e)=>{bgImageEnabled=e.target.checked;saveSetting(LS_BGIMAGE_ENABLED,bgImageEnabled);if(!bgImageEnabled){bgImageUrl='';removeSetting(LS_BGIMAGE_URL);if(bgImageFileInput)bgImageFileInput.value=null;}applyCustomBackground();});
        bgImageFileInput.addEventListener('change',handleImageFileSelect); clearBgImageBtn.addEventListener('click',clearCustomBackground);
        // Added listener for saving username
        if(saveUsernameBtn) saveUsernameBtn.addEventListener('click', handleUpdateUsername);
        if(settingsUsernameInput) settingsUsernameInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleUpdateUsername(); });
        // Added listener for clearing data
        if(clearDataBtn) clearDataBtn.addEventListener('click', handleClearAllData);


        // --- Auth Listeners Removed ---
        // --- Chat Listeners Removed ---

        console.log("Listeners attached.");
    }); // End DOMContentLoaded
</script>

</body>
</html>
