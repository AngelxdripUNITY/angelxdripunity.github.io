<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Qbit</title>
    <link rel="icon" id="dynamic-favicon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>Q</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Base Styles */
         :root { /* Theme Variables */ --bg: #1e1e1e; --sidebar: #111; --topbar: #2c2c2c; --accent: #444; --text: #ffffff; --font-size: 16px; --font-family: 'Segoe UI', sans-serif; /* Radii */ --radius-std: 8px; --radius-lg: 12px; /* Slider */ --slider-track-bg: var(--accent); --slider-thumb-bg: var(--text); --slider-progress-color: var(--text); --slider-track-height: 6px; --slider-thumb-size: 16px; /* Games Section Specific */ --game-card-bg: var(--topbar); --game-card-hover-bg: var(--accent); --delete-color: #e53e3e; --edit-color: #4299e1; --play-color: #48bb78; /* Custom Background */ --custom-bg-image: none; }
         body, .sidebar, .main, .modal-overlay, .modal-box, .sidebar button, .search input, .icon-btn, .content, iframe, .settings-panel label, .settings-panel select, .settings-panel input[type="file"], .settings-panel button, .custom-slider-container, input[type="range"].custom-slider, .modal-box input, .modal-box select, .modal-box button, .game-card, .game-card button, #addGameBtn, #gameModal input, #gameModal select, #gameModal button, #addCategoryBtn, .proxy-card, .proxy-card button, #clearDataBtn { box-sizing: border-box; }
         body { margin: 0; font-family: var(--font-family); display: flex; height: 100vh; overflow: hidden; background-color: var(--bg); color: var(--text); font-size: var(--font-size); transition: background-color 0.3s, color 0.3s; background-image: var(--custom-bg-image); background-size: cover; background-position: center center; background-repeat: no-repeat; background-attachment: fixed; }
        .sidebar { width: 200px; background-color: var(--sidebar); flex-shrink: 0; animation: slideInLeft 0.5s ease forwards; transition: background-color 0.3s; display:flex; flex-direction:column; padding: 20px 10px; gap: 20px; }
        .sidebar h2 { font-size: 1.1em; border-bottom: 1px solid var(--accent); padding-bottom: 5px; margin-bottom: 10px; color: var(--text);}
        .sidebar button { background: var(--accent); border: none; padding: 0.6em 0.8em; text-align: left; color: var(--text); cursor: pointer; border-radius: var(--radius-std); transition: background 0.3s, transform 0.2s, color 0.3s; font-size: 0.9em; display: block; width: 100%; }
        .sidebar button:hover { filter: brightness(1.1); transform: scale(1.03); }
        .main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .topbar { background-color: var(--topbar); animation: slideDown 0.5s ease forwards; transition: background-color 0.3s; display:flex; align-items:center; justify-content: space-between; padding: 10px 20px; position: sticky; top:0; z-index: 2; }
        .search { flex-grow: 1; margin-right: 10px; }
        .search input { width: 100%; padding: 8px 12px; background-color: var(--bg); color: var(--text); border: 1px solid var(--accent); border-radius: var(--radius-std); font-size: 0.9em; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        .top-buttons { display: flex; gap: 10px; }
        .icon-btn { width: 38px; height: 38px; border-radius: 50%; background-color: var(--accent); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.3s, transform 0.2s; padding: 0; }
        .icon-btn:hover { filter: brightness(1.1); transform: scale(1.1); }
        .icon-btn svg { width: 18px; height: 18px; fill: var(--text); display: block; }
        .content { padding: 25px; overflow-y: auto; flex-grow: 1; line-height: 1.6; position: relative; z-index: 1; color: var(--text); }
        .content h1 { font-size: 1.8em; margin-bottom: 0.5em; color: var(--text);} .content h2 { font-size: 1.4em; margin-bottom: 0.4em; margin-top: 1em; color: var(--text);} .content p { font-size: 1em; margin-bottom: 1em; color: var(--text);}
        #welcome-area { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100%; opacity: 0; animation: fadeIn 1s 0.2s forwards; }
        #welcome-logo-container { width: 64px; height: 64px; margin-bottom: 20px; opacity: 0; transform: scale(0.5); animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.5s forwards; }
        #welcome-logo-container svg { display: block; width: 100%; height: 100%; }
        #welcome-message { opacity: 0; transform: translateY(20px); animation: fadeInUp 0.8s ease-out 0.8s forwards; color: var(--text); }
        .settings-panel { position: fixed; top: 55px; right: 20px; background-color: var(--topbar); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 280px; z-index: 10; opacity: 0; transform: translateY(-20px); transition: opacity 0.4s ease, transform 0.4s ease, background-color 0.3s, visibility 0s linear 0.4s; display: none; flex-direction: column; gap: 15px; color: var(--text); }
        .settings-panel.show { display: flex; opacity: 1; transform: translateY(0); visibility: visible; transition: opacity 0.4s ease, transform 0.4s ease, background-color 0.3s; }
        .settings-panel label:not(.toggle-switch-label) { font-size: 0.9em; display: flex; flex-direction: column; gap: 8px; color: var(--text); }
        .settings-panel select { padding: 10px; border-radius: var(--radius-std); border: 1px solid var(--accent); background-color: var(--bg); color: var(--text); transition: background-color 0.3s, color 0.3s, border-color 0.3s; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23${(typeof getComputedStyle !== 'undefined' ? (getComputedStyle(document.documentElement).getPropertyValue('--text') || '#ffffff').substring(1) : 'ffffff')}%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 12px center; background-size: 10px auto; padding-right: 35px; font-size: 0.9em; }
        .custom-slider-container { position: relative; width: 100%; height: var(--slider-thumb-size); display: flex; align-items: center; cursor: pointer; margin-top: 5px; }
        input[type="range"].custom-slider { appearance: none; -webkit-appearance: none; width: 100%; height: var(--slider-track-height); background: transparent; position: absolute; top: calc(50% - var(--slider-track-height) / 2); left: 0; z-index: 2; margin: 0; cursor: pointer; }
        input[type="range"].custom-slider::-webkit-slider-thumb { appearance: none; -webkit-appearance: none; width: var(--slider-thumb-size); height: var(--slider-thumb-size); background: transparent; border: none; }
        input[type="range"].custom-slider::-moz-range-thumb { width: var(--slider-thumb-size); height: var(--slider-thumb-size); background: transparent; border: none; border-radius: 0; }
        .slider-track { position: absolute; width: 100%; height: var(--slider-track-height); background-color: var(--slider-track-bg); border-radius: var(--slider-track-height); top: calc(50% - var(--slider-track-height) / 2); left: 0; z-index: 0; transition: background-color 0.3s; }
        .slider-progress { position: absolute; height: var(--slider-track-height); background-color: var(--slider-progress-color); border-radius: var(--slider-track-height); top: calc(50% - var(--slider-track-height) / 2); left: 0; z-index: 1; width: 50%; transition: background-color 0.3s; opacity: 0.7; }
        .slider-thumb { position: absolute; width: var(--slider-thumb-size); height: var(--slider-thumb-size); background-color: var(--slider-thumb-bg); border-radius: 50%; border: 1px solid var(--accent); top: calc(50% - var(--slider-thumb-size) / 2); left: 50%; transform: translateX(-50%); z-index: 3; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: background-color 0.3s, border-color 0.3s; }
        .slider-value-display { margin-left: 10px; font-size: 0.85em; color: var(--text); opacity: 0.8; position: absolute; right: 0; top: -1.5em; min-width: 30px; text-align: right; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 100; opacity: 0; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .modal-overlay.visible { display: flex; opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-box { background-color: var(--topbar); padding: 30px 40px; border-radius: var(--radius-lg); border: 1px solid var(--accent); box-shadow: 0 5px 20px rgba(0,0,0,0.4); text-align: center; color: var(--text); transform: scale(0.9); transition: transform 0.3s ease, background-color 0.3s, color 0.3s; max-width: 450px; width: 90%; }
        .modal-overlay.visible .modal-box { transform: scale(1); }
        .modal-box h3 { margin-top: 0; margin-bottom: 25px; font-size: 1.3em; color: var(--text); }
        .modal-box p { margin-bottom: 20px; font-size: 0.95em; opacity: 0.9; text-align: left; color: var(--text); }
        .modal-box label { display: block; text-align: left; margin-bottom: 5px; font-size: 0.9em; font-weight: bold; color: var(--text); }
        .modal-box .form-field { margin-bottom: 18px; }
        .modal-box .category-field { display: flex; align-items: center; gap: 10px; }
        .modal-box input[type="text"],
        .modal-box input[type="url"],
        .modal-box select,
        #nameInput
        { display: block; width: 100%; padding: 10px; border: 1px solid var(--accent); border-radius: var(--radius-std); background-color: var(--bg); color: var(--text); font-size: 1em; flex-grow: 1; }
        .modal-box select { appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23${(typeof getComputedStyle !== 'undefined' ? (getComputedStyle(document.documentElement).getPropertyValue('--text') || '#ffffff').substring(1) : 'ffffff')}%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 12px center; background-size: 10px auto; padding-right: 35px; }
        #addCategoryBtn { padding: 6px 10px; font-size: 0.8em; flex-shrink: 0; background-color: var(--accent); color: var(--text); border: none; border-radius: var(--radius-std); cursor: pointer; }
        #addCategoryBtn:hover { filter: brightness(1.2); }
        .modal-box .modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-box button { padding: 10px 20px; border: none; border-radius: var(--radius-std); font-size: 1em; cursor: pointer; transition: background-color 0.3s, transform 0.1s; color: var(--text); }
        .modal-box button.primary { background-color: var(--accent); }
        .modal-box button.secondary { background-color: transparent; border: 1px solid var(--accent); }
        .modal-box button:hover { filter: brightness(1.2); } .modal-box button:active { transform: scale(0.95); }
        #games-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--accent); }
        #addGameBtn { background-color: var(--accent); color: var(--text); border: none; padding: 8px 15px; border-radius: var(--radius-std); cursor: pointer; font-size: 0.9em; transition: background-color 0.3s, transform 0.1s; }
        #addGameBtn:hover { filter: brightness(1.2); } #addGameBtn:active { transform: scale(0.95); }
        .game-list-container, .proxy-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; padding-top: 10px; }
        .game-card, .proxy-card { background-color: var(--game-card-bg); border-radius: var(--radius-lg); padding: 15px; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid transparent; transition: transform 0.3s ease, background-color 0.3s, border-color 0.3s, box-shadow 0.3s; opacity: 0; transform: translateY(20px); animation: cardFadeInUp 0.5s ease forwards; min-height: 110px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); color: var(--text); }
        .game-card:nth-child(1), .proxy-card:nth-child(1) { animation-delay: 0.05s; } .game-card:nth-child(2), .proxy-card:nth-child(2) { animation-delay: 0.1s; } .game-card:nth-child(3), .proxy-card:nth-child(3) { animation-delay: 0.15s; } .game-card:nth-child(4), .proxy-card:nth-child(4) { animation-delay: 0.2s; }
        .game-card:hover, .proxy-card:hover { transform: translateY(-5px) scale(1.02); background-color: var(--game-card-hover-bg); border-color: var(--text); box-shadow: 0 8px 15px rgba(0,0,0,0.3); }
        .proxy-card h4 { font-size: 1.05em; margin-top: 0; margin-bottom: 8px; word-break: break-word; flex-grow: 1; color: var(--text);}
        .game-card p.category { font-size: 0.75em; color: var(--text); opacity: 0.7; margin-top: 0; margin-bottom: 10px; background-color: rgba(0,0,0,0.2); padding: 3px 8px; border-radius: var(--radius-std); display: inline-block; }
        .game-card-actions, .proxy-card-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: auto; }
        .game-card-actions button, .proxy-card-actions button { background-color: transparent; border: none; border-radius: var(--radius-std); cursor: pointer; padding: 5px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, transform 0.1s; }
        .game-card-actions button svg, .proxy-card-actions button svg { width: 18px; height: 18px; display: block; fill: var(--text); opacity: 0.7; transition: opacity 0.2s, fill 0.2s; }
        .game-card-actions button:hover svg, .proxy-card-actions button:hover svg { opacity: 1; }
        .game-card-actions button:active, .proxy-card-actions button:active { transform: scale(0.9); }
        .game-card-actions button.play-btn:hover svg, .proxy-card-actions button.play-btn:hover svg { fill: var(--play-color); }
        .game-card-actions button.edit-btn:hover svg { fill: var(--edit-color); }
        .game-card-actions button.delete-btn:hover svg { fill: var(--delete-color); }
        .game-card.deleting { animation: cardFadeOut 0.4s ease forwards; }
        #no-games-found { display: none; grid-column: 1 / -1; text-align: center; opacity: 0.7; padding: 20px; color: var(--text);}
        *:focus { outline: none; }
        button:focus-visible, input:focus-visible, select:focus-visible, iframe:focus-visible, .game-card:focus-visible, .proxy-card:focus-visible, input[type="file"]:focus-visible { box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent); transition: box-shadow 0.2s ease-in-out; }
        .settings-panel:focus-visible { border-radius: var(--radius-lg); box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent); }
        input[type="range"].custom-slider:focus-visible { box-shadow: none; }
        input[type="range"].custom-slider:focus-visible + .slider-track + .slider-progress + .slider-thumb { box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent); border-radius: 50%; }

        /* Placeholders */
        input::placeholder,
        .modal-box input::placeholder,
        .search input::placeholder
        { color: var(--text); opacity: 0.6; }

        /* Toggle Switch Styles */
        .toggle-switch-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-size: 0.9em; color: var(--text); position: relative; user-select: none; }
        .toggle-switch { opacity: 0; width: 0; height: 0; position: absolute; }
        .toggle-slider { position: relative; display: inline-block; width: 40px; height: 20px; background-color: var(--accent); border-radius: 20px; transition: background-color 0.3s; flex-shrink: 0; }
        .toggle-slider::before { content: ""; position: absolute; width: 16px; height: 16px; left: 2px; bottom: 2px; background-color: var(--text); border-radius: 50%; transition: transform 0.3s; }
        .toggle-switch:checked + .toggle-slider { background-color: var(--play-color); }
        .toggle-switch:checked + .toggle-slider::before { transform: translateX(20px); }
        .toggle-switch:focus-visible + .toggle-slider { box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent); }

        /* Clear Data Button Style (Themed) */
        .danger-btn { background-color: var(--accent); color: var(--text); border: none; padding: 10px 15px; border-radius: var(--radius-std); cursor: pointer; font-size: 0.9em; font-weight: bold; text-align: center; transition: background-color 0.3s, transform 0.1s, filter 0.3s; margin-top: 10px; width: 100%; }
        .danger-btn:hover { filter: brightness(0.85); }
        .danger-btn:active { transform: scale(0.98); }
        .danger-btn:focus-visible { box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent); }

        /* Custom Background Setting Styles */
        #bgImageControlContainer { display: none; flex-direction: column; align-items: flex-start; gap: 8px; margin-top: 5px; padding-left: 5px; border-left: 2px solid var(--accent); margin-left: 2px; }
        #bgImageControlContainer label { font-size: 0.85em; color: var(--text); opacity: 0.9; margin-bottom: 0; font-weight: normal; }
        #bgImageFileInput { font-size: 0.85em; color: var(--text); background-color: var(--bg); border: 1px solid var(--accent); padding: 5px 8px; border-radius: var(--radius-std); max-width: 100%; }
        #bgImageFileInput::file-selector-button { background-color: var(--accent); color: var(--text); border: none; padding: 4px 8px; border-radius: var(--radius-std); cursor: pointer; margin-right: 8px; font-size: 0.8em; transition: background-color 0.3s; }
        #bgImageFileInput::file-selector-button:hover { filter: brightness(1.1); }
        #clearBgImageBtn { font-size: 0.8em; padding: 4px 10px; background-color: transparent; color: var(--text); border: 1px solid var(--accent); border-radius: var(--radius-std); cursor: pointer; opacity: 0.8; transition: opacity 0.3s, background-color 0.3s; align-self: flex-start; }
        #clearBgImageBtn:hover { opacity: 1; background-color: rgba(255, 255, 255, 0.1); }

        /* Game Card Favicon Styles */
        .game-card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-grow: 1; min-height: 20px; }
        .game-favicon { width: 16px; height: 16px; flex-shrink: 0; border-radius: 3px; object-fit: contain; background-color: rgba(128, 128, 128, 0.1); display: inline-block; vertical-align: middle; }
        .game-card-header h4 { margin: 0; flex-grow: 1; line-height: 1.2; color: var(--text); word-break: break-word; }

        /* --- Specific Overrides for Trigonometrical Red Theme --- */
        [data-theme="trigonometrical-red"] .modal-box,
        [data-theme="trigonometrical-red"] .settings-panel,
        [data-theme="trigonometrical-red"] .sidebar button,
        [data-theme="trigonometrical-red"] .sidebar h2,
        [data-theme="trigonometrical-red"] .icon-btn svg,
        [data-theme="trigonometrical-red"] .slider-value-display,
        [data-theme="trigonometrical-red"] #addCategoryBtn,
        [data-theme="trigonometrical-red"] .modal-box button,
        [data-theme="trigonometrical-red"] .game-card,
        [data-theme="trigonometrical-red"] .proxy-card
        { color: #ffffff; fill: #ffffff; }

        [data-theme="trigonometrical-red"] .modal-box input[type="text"],
        [data-theme="trigonometrical-red"] .modal-box input[type="url"],
        [data-theme="trigonometrical-red"] .modal-box select,
        [data-theme="trigonometrical-red"] .settings-panel select,
        [data-theme="trigonometrical-red"] #bgImageFileInput
        { color: #ffffff; background-color: #801818; border-color: var(--accent); }

        [data-theme="trigonometrical-red"] .modal-box input::placeholder,
        [data-theme="trigonometrical-red"] .settings-panel input::placeholder,
        [data-theme="trigonometrical-red"] #nameInput::placeholder
        { color: #ffffff; opacity: 0.7; }

        [data-theme="trigonometrical-red"] .search input { color: #1a1a1a; background-color: #ffffff;}
        [data-theme="trigonometrical-red"] .search input::placeholder { color: #1a1a1a; opacity: 0.6;}
        [data-theme="trigonometrical-red"] #nameInput { color: #1a1a1a; background-color: #ffffff;}

        [data-theme="trigonometrical-red"] #bgImageFileInput::file-selector-button { color: #ffffff; }

        [data-theme="trigonometrical-red"] .modal-box button.secondary { color: #ffffff; border-color: #ffffff; }
        [data-theme="trigonometrical-red"] .modal-box button.secondary:hover { border-color: var(--accent); background-color: rgba(255,255,255,0.1); }
        [data-theme="trigonometrical-red"] #clearBgImageBtn { color: #ffffff; border-color: #ffffff; }
        [data-theme="trigonometrical-red"] #clearBgImageBtn:hover { border-color: var(--accent); background-color: rgba(255,255,255,0.1); }

        [data-theme="trigonometrical-red"] .slider-thumb,
        [data-theme="trigonometrical-red"] .slider-progress { background-color: #ffffff; }

        /* Animations */
        @keyframes slideInLeft { from { transform: translateX(-100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } } @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } } @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } } @keyframes fadeInUp { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } } @keyframes cardFadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } } @keyframes cardFadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.8); } }
    </style>
</head>
<body data-theme="dark">
    <div class="modal-overlay" id="namePromptModal"> <div class="modal-box"> <h3>Welcome to Qbit!</h3> <p>Please enter your name:</p> <div class="form-field"> <input type="text" id="nameInput" placeholder="Your Name" maxlength="50"> </div> <div class="modal-actions"> <button id="submitNameBtn" class="primary">Continue</button> </div> </div> </div>
    <div class="modal-overlay" id="gameModal"> <div class="modal-box"> <h3 id="gameModalTitle">Add New Game</h3> <input type="hidden" id="gameIdInput"> <div class="form-field"> <label for="gameNameInput">Name:</label> <input type="text" id="gameNameInput" placeholder="e.g., 2048" required> </div> <div class="form-field"> <label for="gameUrlInput">URL:</label> <input type="url" id="gameUrlInput" placeholder="https://play2048.co/" required> </div> <div class="form-field"> <label for="gameCategorySelect">Category:</label> <div class="category-field"> <select id="gameCategorySelect"> <option value="">Uncategorized</option> </select> <button id="addCategoryBtn" title="Add New Category">+</button> </div> </div> <div class="modal-actions"> <button type="button" class="secondary" id="cancelGameBtn">Cancel</button> <button type="button" class="primary" id="saveGameBtn">Save Game</button> </div> </div> </div>

    <div class="sidebar"> <h2>Qbit</h2> <button onclick="showSection('games')">Games</button> <button onclick="showSection('proxy')">Proxy</button> <button onclick="showSection('tools')">Tools</button> </div>

    <div class="main">
        <div class="topbar"> <div class="search"> <input type="text" id="search" placeholder="Search Games or..." /> </div> <div class="top-buttons"> <button class="icon-btn" onclick="openChat()" title="Open Chat"> <svg viewBox="0 0 24 24"><path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z"/></svg> </button> <button class="icon-btn" title="Settings" id="settingsBtn"> <svg viewBox="0 0 24 24"><path d="M12 15.5C10.07 15.5 8.5 13.93 8.5 12S10.07 8.5 12 8.5 15.5 10.07 15.5 12 13.93 15.5 12 15.5ZM19.43 12.98C19.46 12.66 19.5 12.34 19.5 12S19.46 11.34 19.43 11.02L21.54 9.37C21.73 9.21 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.06 19.3 4.97 19.07 5.03L16.56 5.67C16.04 5.25 15.47 4.89 14.85 4.6L14.5 2H9.5L9.15 4.6C8.53 4.89 7.96 5.25 7.44 5.67L4.93 5.03C4.7 4.97 4.46 5.06 4.34 5.27L2.34 8.73C2.22 8.95 2.27 9.21 2.46 9.37L4.57 11.02C4.54 11.34 4.5 11.66 4.5 12S4.54 12.66 4.57 12.98L2.46 14.63C2.27 14.79 2.22 15.05 2.34 15.27L4.34 18.73C4.46 18.94 4.7 19.03 4.93 18.97L7.44 18.33C7.96 18.75 8.53 19.11 9.15 19.4L9.5 22H14.5L14.85 19.4C15.47 19.11 16.04 18.75 16.56 18.33L19.07 18.97C19.3 19.03 19.54 18.94 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.79 21.54 14.63L19.43 12.98Z"/></svg> </button> </div> </div>
        <div class="content" id="main-content"> <div id="welcome-area-placeholder" style="display: none;">Loading...</div> </div>
    </div>

    <div class="settings-panel" id="settingsPanel">
        <label>Font Size: <span class="slider-value-display" id="fontSizeValue">16px</span> <div class="custom-slider-container"> <div class="slider-track"></div> <div class="slider-progress" id="fontSizeProgress"></div> <div class="slider-thumb" id="fontSizeThumb"></div> <input type="range" id="fontSizeSlider" class="custom-slider" min="12" max="24" step="1" value="16"> </div> </label>
        <label>Color Scheme: <select id="themeSelector" onchange="updateTheme(this.value)"> <option value="dark">Dark</option> <option value="light">Light</option> <option value="blue">Cool Blue</option> <option value="forest">Forest Green</option> <option value="sunset">Sunset Orange</option> <option value="trigonometrical-red">Trigonometrical Red</option> </select> </label>
        <label>Font Family: <select id="fontSelector" onchange="updateFontFamily(this.value)"> <option value="'Segoe UI', sans-serif">Segoe UI</option> <option value="Arial, sans-serif">Arial</option> <option value="Verdana, sans-serif">Verdana</option> <option value="'Times New Roman', Times, serif">Times New Roman</option> <option value="'Courier New', Courier, monospace">Courier New</option> <option value="Georgia, serif">Georgia</option> <option value="'Roboto', sans-serif">Roboto</option> <option value="'Lato', sans-serif">Lato</option> </select> </label>
        <label class="toggle-switch-label"> <span>Custom Background:</span> <input type="checkbox" id="bgImageToggleSwitch" class="toggle-switch"> <span class="toggle-slider"></span> </label>
        <div id="bgImageControlContainer"> <label for="bgImageFileInput">Select Image (Max 2MB):</label> <input type="file" id="bgImageFileInput" accept="image/*"> <button id="clearBgImageBtn" title="Remove custom background">Clear Background</button> </div>
        <label class="toggle-switch-label"> Warn on Close: <input type="checkbox" id="warnOnCloseSwitch" class="toggle-switch"> <span class="toggle-slider"></span> </label>
        <button id="clearDataBtn" class="danger-btn">Clear All Data</button>
    </div>

    <script>
        // --- DOM Element References ---
        let mainContent, settingsPanel, root, body, faviconLink, namePromptModal, nameInput, submitNameBtn, welcomeAreaPlaceholder, gameModal, gameModalTitle, gameIdInput, gameNameInput, gameUrlInput, gameCategorySelect, addCategoryBtn, saveGameBtn, cancelGameBtn, fontSizeSlider, fontSizeThumb, fontSizeValueDisplay, fontSizeProgress, themeSelector, fontSelector, settingsBtn, searchInput, warnOnCloseSwitch, bgImageToggleSwitch, bgImageControlContainer, bgImageFileInput, clearBgImageBtn;

        // --- Global State ---
        let currentUserName = null; let currentThemeColor = '#444444'; let games = []; let categories = []; let isEditingGame = false; let warnOnClose = false; let bgImageEnabled = false; let bgImageUrl = ''; let debounceTimer;
        const MAX_IMAGE_SIZE_MB = 2; const MAX_IMAGE_SIZE_BYTES = MAX_IMAGE_SIZE_MB * 1024 * 1024;

        // --- LocalStorage Keys ---
        const LS_PREFIX = 'qbit_v3.1_'; const LS_USERNAME = LS_PREFIX + 'userName'; const LS_THEME = LS_PREFIX + 'theme'; const LS_FONTSIZE = LS_PREFIX + 'fontSize'; const LS_FONTFAMILY = LS_PREFIX + 'fontFamily'; const LS_GAMES = LS_PREFIX + 'games'; const LS_CATEGORIES = LS_PREFIX + 'categories'; const LS_WARNONCLOSE = LS_PREFIX + 'warnOnClose'; const LS_INITIALIZED = LS_PREFIX + 'initialized'; const LS_BGIMAGE_ENABLED = LS_PREFIX + 'bgImageEnabled'; const LS_BGIMAGE_URL = LS_PREFIX + 'bgImageUrl';

        // --- SVG Icons ---
        const ICONS = { play: `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`, edit: `<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`, delete: `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>` };

        // --- Broadcast Channel ---
        let warningChannel;
        try {
             warningChannel = new BroadcastChannel('qbit_warn_channel'); // Define the channel
             console.log("[DEBUG] Main: Broadcast channel created.");
        } catch (e) {
             console.error("Main: BroadcastChannel API not supported or failed.", e);
             warningChannel = null; // Fallback if API not supported
        }


        // --- Helper: Debounce ---
        function debounce(func, delay) { return function(...args) { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => { func.apply(this, args); }, delay); }; }

        // --- General Function Definitions ---
        function getLogoSvg(color) { const safeColor = color || '#444444'; return `<svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" fill="${safeColor}"><rect x="5" y="10" width="6" height="12" rx="2"/><rect x="13" y="10" width="6" height="12" rx="2"/><rect x="21" y="10" width="6" height="12" rx="2"/></svg>`; }
        function updateFavicon(color) { if (!faviconLink) return; const svgString = getLogoSvg(color); const dataUri = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgString)}`; faviconLink.href = dataUri; }
        function saveSetting(key, value) { try { localStorage.setItem(key, value); } catch (e) { console.error(`LS Save Error for key "${key}":`, e); if (e.name === 'QuotaExceededError') { alert(`Could not save setting. Storage limit reached. Try clearing the custom background or removing some games.`); } } }
        function removeSetting(key) { try { localStorage.removeItem(key); } catch (e) { console.error(`LS Remove Error for key "${key}":`, e); } }
        function updateSelectArrowColor(textColor = '#ffffff') { const styleId = 'dynamic-select-arrow-style'; let styleElement = document.getElementById(styleId); if (!styleElement) { styleElement = document.createElement('style'); styleElement.id = styleId; document.head.appendChild(styleElement); } const safeTextColor = encodeURIComponent((textColor || '#ffffff').substring(1)); const svgUrl = `data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23${safeTextColor}%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E`; styleElement.textContent = ` .settings-panel select, .modal-box select { background-image: url('${svgUrl}'); } `; }

        // --- User & Welcome Functions ---
        function promptForName() { console.log("[DEBUG] Executing promptForName"); const modal = document.getElementById('namePromptModal'); const input = document.getElementById('nameInput'); const button = document.getElementById('submitNameBtn'); if (!modal || !input || !button) { console.error("Name prompt modal inner elements missing."); return; } modal.classList.add('visible'); input.focus(); let cs=null, ce=null; cs = () => { const name = input.value.trim(); if (name) { currentUserName = name; saveSetting(LS_USERNAME, name); modal.classList.remove('visible'); displayWelcomeMessage(name); button.removeEventListener('click', cs); input.removeEventListener('keypress', ce); } else { input.style.borderColor='red'; setTimeout(()=>{ input.style.borderColor=''; },1500); } }; ce = (e) => { if (e.key === 'Enter') cs(); }; button.removeEventListener('click', cs); input.removeEventListener('keypress', ce); button.addEventListener('click', cs, { once: true }); input.addEventListener('keypress', ce); }
        function displayWelcomeMessage(name) { console.log("[DEBUG] Displaying welcome message for:", name); if (!mainContent) return; mainContent.innerHTML = ''; const wa = document.createElement('div'); wa.id = 'welcome-area'; const lc = document.createElement('div'); lc.id = 'welcome-logo-container'; lc.innerHTML = getLogoSvg(currentThemeColor); const msg = document.createElement('h1'); msg.id = 'welcome-message'; msg.textContent = `Welcome, ${name.replace(/</g, "&lt;").replace(/>/g, "&gt;")}!`; wa.appendChild(lc); wa.appendChild(msg); mainContent.appendChild(wa); mainContent.style.opacity = 1; }
        function updateWelcomeLogoColor(color) { const wa=document.getElementById('welcome-area'); if(!wa) return; const lse=wa.querySelector('#welcome-logo-container svg'); if(lse){ const sc=color||'#444444'; lse.setAttribute('fill', sc); lse.querySelectorAll('rect').forEach(r=>r.setAttribute('fill', sc)); } }

        // --- Game & Category Management ---
        function loadGames() { const dg=[{id:crypto.randomUUID(),name:"N-GON",url:"https://landgreen.github.io/n-gon/index.html",category:"Strategy"},{id:crypto.randomUUID(),name:"Dead Shot",url:"https://deadshot.io/",category:"Action"},{id:crypto.randomUUID(),name:"Tik-Tok",url:"https://shop.lang.hm/&?q=TikTok",category:"Media"},{id:crypto.randomUUID(),name:"VS-Code",url:"https://shop.lang.hm/&?q=VS%20Code",category:"Coding"},{id:crypto.randomUUID(),name:"ChatGPT",url:"https://shop.lang.hm/&?q=ChatGPT",category:"Conversation"},{id:crypto.randomUUID(),name:"Netquel",url:"https://netquel.com/",category:"Strategy"},{id:crypto.randomUUID(),name:"MK48",url:"https://mk48.io/",category:"Strategy"},{id:crypto.randomUUID(),name:"Ships 3D",url:"https://yp3d.com/ships3d/",category:"Action"},{id:crypto.randomUUID(),name:"Geometry Dash",url:"https://geometrylite.github.io",category:"Action"},{id:crypto.randomUUID(),name:"Five Nights At Freddy's",url:"https://wellsousaaa.github.io/Five-Nights-at-Freddys-Web/",category:"Horror"},{id:crypto.randomUUID(),name:"Five Nights At Freddy's Two",url:"https://ruihq.github.io/FNAF2/",category:"Horror"},{id:crypto.randomUUID(),name:"Five Nights At Freddy's Three",url:"https://sussygamedeveloper.github.io/fnaf3/",category:"Horror"}]; try { if(!localStorage.getItem(LS_INITIALIZED)){ console.log("[DEBUG] First run. Loading default games."); games=dg; saveGames(); localStorage.setItem(LS_INITIALIZED,'true'); } else { const sg=localStorage.getItem(LS_GAMES); try { games=sg?JSON.parse(sg):[]; } catch(pe){ console.error("Error parsing stored games:", pe); games=[]; } console.log("[DEBUG] Games loaded:", games.length); } } catch(e){ console.error("Error loading games:",e); if(localStorage.getItem(LS_INITIALIZED)){ games=[]; } else { console.warn("Error during initial load, using defaults."); games=dg; saveGames(); localStorage.setItem(LS_INITIALIZED,'true'); } } }
        function saveGames() { try { saveSetting(LS_GAMES, JSON.stringify(games)); console.log("[DEBUG] Games saved."); } catch (e) { console.error("Failed to save games:", e); } }
        function loadCategories() { const dc=['Action','Puzzle','Strategy','Simulation','Misc','Horror','Media','Coding','Conversation']; try { const sc=localStorage.getItem(LS_CATEGORIES); categories=sc?JSON.parse(sc):dc; } catch (e){ console.error("Failed load categories:",e); categories=dc; } dc.forEach(c=>{if(!categories.includes(c))categories.push(c);}); categories.sort(); console.log("[DEBUG] Categories loaded:", categories); }
        function saveCategories() { try { saveSetting(LS_CATEGORIES, JSON.stringify(categories)); console.log("[DEBUG] Categories saved."); } catch (e) { console.error("Failed save categories:", e); } }
        function populateCategorySelect(se, sc="") { if (!se) return; se.innerHTML='<option value="">Uncategorized</option>'; categories.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;if(c===sc)o.selected=true;se.appendChild(o);}); }
        function handleAddCategory() { const cs=document.getElementById('gameCategorySelect'); if(!cs)return; const nc=prompt("Enter new category name:"); if(nc && nc.trim()){const tc=nc.trim(); if(!categories.includes(tc)){categories.push(tc);categories.sort();saveCategories();populateCategorySelect(cs,tc);} else {alert("Category exists!");cs.value=tc;}} }
        function renderGames() { const container=mainContent?mainContent.querySelector('.game-list-container'):null; if(!container)return; console.log("[DEBUG] Rendering games..."); container.innerHTML=''; let ngfp=mainContent.querySelector('#no-games-found'); if(!ngfp && games.length === 0){container.innerHTML='<p id="no-games-found" style="grid-column:1/-1;text-align:center;opacity:0.7;color:var(--text);">No games added yet.</p>'; ngfp=mainContent.querySelector('#no-games-found');} else if(ngfp){ngfp.style.display='none';} if(games.length > 0){games.forEach(g=>{const card=document.createElement('div'); card.className='game-card'; card.dataset.id=g.id; card.setAttribute('tabindex','0'); card.innerHTML=`<div class="game-card-header"><img class="game-favicon" alt="" width="16" height="16" loading="lazy"><h4></h4></div><p class="category"></p><div class="game-card-actions"><button class="play-btn" title="Play Game">${ICONS.play}</button><button class="edit-btn" title="Edit Game">${ICONS.edit}</button><button class="delete-btn" title="Delete Game">${ICONS.delete}</button></div>`; const ne=card.querySelector('h4'); const ce=card.querySelector('p.category'); const fe=card.querySelector('.game-favicon'); ne.textContent=g.name.replace(/</g,"&lt;"); ce.textContent=g.category||'Uncategorized'; if(fe){fe.alt=`${g.name} Favicon`; if(g.url && (g.url.startsWith('http://')||g.url.startsWith('https://'))){try{const gu=new URL(g.url);const hn=gu.hostname;const fsu=`https://www.google.com/s2/favicons?domain=${hn}&sz=32`;fe.src=fsu;fe.onerror=()=>{console.warn(`Favicon fail: ${hn}`);fe.style.display='none';}; fe.style.display='inline-block';}catch(e){console.warn(`URL parse fail: ${g.url}`,e);fe.style.display='none';}}else{console.log(`Skip non-http favicon: ${g.url}`);fe.style.display='none';}} card.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();playGame(g.url,g.name);}});card.querySelector('.play-btn').onclick=(e)=>{e.stopPropagation();playGame(g.url,g.name);};card.querySelector('.edit-btn').onclick=(e)=>{e.stopPropagation();openGameModal(g);};card.querySelector('.delete-btn').onclick=(e)=>{e.stopPropagation();deleteGame(g.id,card);};container.appendChild(card);});} filterGames();}
        function openGameModal(gte=null) { const m=document.getElementById('gameModal');const t=document.getElementById('gameModalTitle');const ii=document.getElementById('gameIdInput');const ni=document.getElementById('gameNameInput');const ui=document.getElementById('gameUrlInput');const cs=document.getElementById('gameCategorySelect');const sb=document.getElementById('saveGameBtn'); if(!m||!t||!ii||!ni||!ui||!cs||!sb)return; isEditingGame=!!gte;ii.value='';ni.value='';ui.value='';ni.style.borderColor='';ui.style.borderColor='';populateCategorySelect(cs,gte?gte.category:"");if(isEditingGame){t.textContent='Edit Game';ii.value=gte.id;ni.value=gte.name;ui.value=gte.url;sb.textContent='Save Changes';}else{t.textContent='Add New Game';sb.textContent='Add Game';} m.classList.add('visible');ni.focus();}
        function closeGameModal() { const m=document.getElementById('gameModal'); if(m)m.classList.remove('visible'); isEditingGame=false; }
        function handleSaveGame() { const ni=document.getElementById('gameNameInput');const ui=document.getElementById('gameUrlInput');const cs=document.getElementById('gameCategorySelect');const ii=document.getElementById('gameIdInput'); if(!ni||!ui||!cs||!ii)return; const name=ni.value.trim(); const url=ui.value.trim(); const category=cs.value; const id=ii.value; let iv=true; if(!name){ni.style.borderColor='red';iv=false;}else{ni.style.borderColor='';} if(!url||!url.match(/^(https?:\/\/|.\/|..\/|\/)/)){ui.style.borderColor='red';iv=false;alert("Valid URL needed (http://, https://, /, ./, ../)");}else{ui.style.borderColor='';} if(!iv)return; if(isEditingGame&&id){const gi=games.findIndex(g=>g.id===id); if(gi>-1){games[gi]={...games[gi],name,url,category};}else{console.error("Edit fail: ID not found");closeGameModal();return;}}else{const ng={id:crypto.randomUUID(),name,url,category};games.push(ng);} saveGames();renderGames();closeGameModal();}
        function deleteGame(id, ce) { if (!confirm(`Delete this game?`)) return; if (ce) { ce.classList.add('deleting'); ce.addEventListener('animationend', () => { games = games.filter(g => g.id !== id); saveGames(); renderGames(); }, { once: true }); } else { games = games.filter(g => g.id !== id); saveGames(); renderGames(); } }

        // --- Function to open content in about:blank (WITH BROADCAST CHANNEL LISTENER) ---
        function openInAboutBlank(url, title = 'Content') {
            console.log(`[DEBUG] Creating about:blank wrapper for: ${url}. Initial Warn setting: ${warnOnClose}`);
            if (!url || !url.match(/^(https?:\/\/|.\/|..\/|\/)/)) { console.error("Invalid URL provided:", url); alert("Cannot open link: Invalid URL provided."); return; }

            const newWindow = window.open('', '_blank');
            if (newWindow) {
                try {
                    newWindow.document.open();
                    newWindow.document.write(`
                        <!DOCTYPE html>
                        <html lang="en">
                        <head>
                            <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>${title.replace(/</g, "&lt;")}</title>
                            <style>html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#000;}iframe{display:block;width:100%;height:100%;border:none;}</style>
                        </head>
                        <body>
                            <iframe src="${url}" frameborder="0" allowfullscreen sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-top-navigation-by-user-activation"></iframe>
                            <script>
                                let __internalShouldWarnOnClose__ = ${warnOnClose};
                                const __channelName__ = 'qbit_warn_channel';
                                let __warningChannel__;
                                console.log('Child window: Initial warn state:', __internalShouldWarnOnClose__);
                                try {
                                    __warningChannel__ = new BroadcastChannel(__channelName__);
                                    console.log('Child window: Broadcast channel connected.');
                                    __warningChannel__.onmessage = (event) => {
                                        if (event.data && typeof event.data.warn === 'boolean') {
                                            const newState = event.data.warn;
                                            if (__internalShouldWarnOnClose__ !== newState) {
                                                __internalShouldWarnOnClose__ = newState;
                                                console.log('Child window: Received warn update via BroadcastChannel:', __internalShouldWarnOnClose__);
                                            }
                                        }
                                    };
                                    window.addEventListener('unload', () => { if (__warningChannel__) { __warningChannel__.close(); console.log('Child window: Broadcast channel closed.'); } });
                                } catch (e) { console.error("Child window: BroadcastChannel API not supported or failed.", e); __warningChannel__ = null; }

                                window.addEventListener('beforeunload', (event) => {
                                    if (__internalShouldWarnOnClose__) {
                                        console.log('Child window: beforeunload triggered WITH warning (state:', __internalShouldWarnOnClose__, ')');
                                        const confirmationMessage = 'Closing this window might interrupt your game/session. Are you sure?';
                                        event.preventDefault(); event.returnValue = confirmationMessage; return confirmationMessage;
                                    } else { console.log('Child window: beforeunload triggered WITHOUT warning (state:', __internalShouldWarnOnClose__, ')'); }
                                });
                            <\/script>
                            </body>
                            </html>
                    `);
                    newWindow.document.close();
                    console.log("[DEBUG] about:blank wrapper written with updated embedded script.");
                } catch (e) {
                    console.error("Error writing to new window:", e); try { newWindow.location.href = url; } catch (e2) { console.error("Error navigating new window:", e2); alert("Could not open link. Check pop-up blocker."); newWindow.close(); }
                }
            } else { console.error("Failed to open new window. Pop-up blocker?"); alert("Could not open link. Please check pop-up blocker."); }
        }
        const playGame = openInAboutBlank;

        // --- UI Section Management ---
        function showSection(section) { if(!mainContent) return; mainContent.style.opacity=0; setTimeout(()=>{ mainContent.innerHTML=''; mainContent.style.animation='none'; let sc=''; if(section==="welcome" && currentUserName){ displayWelcomeMessage(currentUserName); mainContent.style.opacity=1; return; } else if(section==="games"){ if(!currentUserName){ promptForName(); return; } sc=`<div id="games-section-header"><h2>My Games</h2><button id="addGameBtn">+ Add Game</button></div><div class="game-list-container"></div>`; mainContent.innerHTML=sc; const ab=document.getElementById('addGameBtn'); if(ab) ab.onclick=()=>openGameModal(); renderGames(); } else if(section==="proxy"){ if(!currentUserName){ promptForName(); return; } sc=`<h2>Proxy Sites</h2><div class="proxy-list-container"></div>`; mainContent.innerHTML=sc; renderProxySites(); } else if(section==="tools"){ if(!currentUserName){ promptForName(); return; } sc=`<h2>Tools</h2><p>Useful links, calculators, etc.</p>`; mainContent.innerHTML=sc; } else if(!currentUserName){ if(welcomeAreaPlaceholder) mainContent.appendChild(welcomeAreaPlaceholder); if(welcomeAreaPlaceholder) welcomeAreaPlaceholder.style.display='flex'; promptForName(); mainContent.style.opacity=1; return; } else { displayWelcomeMessage(currentUserName); mainContent.style.opacity=1; return; } if(!mainContent.querySelector('#welcome-area') && !mainContent.querySelector('#namePromptModal')){ mainContent.style.opacity=0; void mainContent.offsetWidth; mainContent.style.animation="fadeIn 0.5s forwards"; mainContent.style.opacity=1; } }, 200); }
        function renderProxySites() { const c=mainContent?mainContent.querySelector('.proxy-list-container'):null; if(!c)return; c.innerHTML=''; const ps=[{name:"Space",url:"https://shop.lang.hm/"},{name:"Transend",url:"https://hw.billigerhost.com/"},{name:"RammerHead",url:"https://pluh.root.sx/"},{name:"Utopia",url:"https://bio.write.examinedbytopmen.com/"}]; ps.forEach(s=>{const card=document.createElement('div');card.className='proxy-card';card.setAttribute('tabindex','0');card.innerHTML=`<div><h4></h4></div><div class="proxy-card-actions"><button class="play-btn" title="Open ${s.name.replace(/</g,"&lt;")}">${ICONS.play}</button></div>`;card.querySelector('h4').textContent=s.name.replace(/</g,"&lt;");card.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();openInAboutBlank(s.url,s.name);}});card.querySelector('.play-btn').onclick=(e)=>{e.stopPropagation();openInAboutBlank(s.url,s.name);};c.appendChild(card);}); }
        function openChat() { alert("Chat feature placeholder."); }

        // --- Settings Panel & Controls ---
        function toggleSettings() { if(settingsPanel) settingsPanel.classList.toggle("show"); }
        function updateSliderVisuals(s,t,p,d) { if(!s||!t||!p||!d)return; try{const min=parseFloat(s.min)||12; const max=parseFloat(s.max)||24; const v=parseFloat(s.value)||16; let pct=((v-min)/(max-min))*100; pct=Math.max(0,Math.min(100,pct)); t.style.left=`${pct}%`; t.style.transform='translateX(-50%)'; p.style.width=`${pct}%`; d.textContent=`${Math.round(v)}px`;}catch(e){console.error("Slider update err:",e);} }
        function updateFontSize(v) { const s=document.getElementById('fontSizeSlider');const t=document.getElementById('fontSizeThumb');const p=document.getElementById('fontSizeProgress');const d=document.getElementById('fontSizeValue'); if(!s||!root)return; const val=v||s.value; root.style.setProperty("--font-size",`${val}px`); saveSetting(LS_FONTSIZE,val); updateSliderVisuals(s,t,p,d); }
        function updateFontFamily(fn) { const s=document.getElementById('fontSelector'); if(!s||!root)return; const v=fn||s.value; root.style.setProperty("--font-family",v); saveSetting(LS_FONTFAMILY,v); }

        // --- Custom Background Image Functions ---
        function applyCustomBackground() { if(!root||!bgImageControlContainer||!bgImageToggleSwitch)return; if(bgImageEnabled){bgImageControlContainer.style.display='flex';}else{bgImageControlContainer.style.display='none';} if(bgImageEnabled&&bgImageUrl&&bgImageUrl.startsWith('data:image/')){root.style.setProperty('--custom-bg-image',`url("${bgImageUrl}")`);}else{root.style.setProperty('--custom-bg-image','none');} bgImageToggleSwitch.checked=bgImageEnabled; }
        function handleImageFileSelect(e) { if(!e.target.files||e.target.files.length===0)return; const f=e.target.files[0]; if(!f.type.startsWith('image/')){alert("Select image file.");e.target.value=null;return;} if(f.size>MAX_IMAGE_SIZE_BYTES){alert(`Image too large (${(f.size/1024/1024).toFixed(1)}MB). Max ${MAX_IMAGE_SIZE_MB}MB.`);e.target.value=null;return;} const r=new FileReader(); r.onload=(le)=>{bgImageUrl=le.target.result;saveSetting(LS_BGIMAGE_URL,bgImageUrl);applyCustomBackground();console.log("BG saved.");}; r.onerror=(ee)=>{console.error("FileRead err:",ee);alert("Error reading file.");e.target.value=null;}; r.onabort=()=>{console.warn("FileRead abort.");e.target.value=null;}; r.readAsDataURL(f); }
        function clearCustomBackground() { bgImageUrl=''; removeSetting(LS_BGIMAGE_URL); if(bgImageFileInput)bgImageFileInput.value=null; applyCustomBackground(); }

        // --- updateTheme Function ---
        function updateTheme(theme) { const selector=document.getElementById('themeSelector'); if(!root||!body) return; const value=theme||(selector?selector.value:'dark'); let accentColor='#444444'; let textColorValue='#ffffff'; switch(value){ case "light": root.style.setProperty("--bg","#ffffff"); root.style.setProperty("--sidebar","#eeeeee"); root.style.setProperty("--topbar","#dddddd"); root.style.setProperty("--accent","#cccccc"); root.style.setProperty("--text","#1a1a1a"); accentColor='#cccccc'; textColorValue='#1a1a1a'; break; case "blue": root.style.setProperty("--bg","#0a0f1c"); root.style.setProperty("--sidebar","#091121"); root.style.setProperty("--topbar","#101a35"); root.style.setProperty("--accent","#395b9c"); root.style.setProperty("--text","#e0e0ff"); accentColor='#395b9c'; textColorValue='#e0e0ff'; break; case "forest": root.style.setProperty("--bg","#1f2e1f"); root.style.setProperty("--sidebar","#141e14"); root.style.setProperty("--topbar","#2a3f2a"); root.style.setProperty("--accent","#4a784a"); root.style.setProperty("--text","#e5f5e5"); accentColor='#4a784a'; textColorValue='#e5f5e5'; break; case "sunset": root.style.setProperty("--bg","#2b1a1a"); root.style.setProperty("--sidebar","#3a2525"); root.style.setProperty("--topbar","#4d3333"); root.style.setProperty("--accent","#b36b4a"); root.style.setProperty("--text","#ffe8e0"); accentColor='#b36b4a'; textColorValue='#ffe8e0'; break; case "trigonometrical-red": root.style.setProperty("--bg", "#ffffff"); root.style.setProperty("--sidebar", "#a02020"); root.style.setProperty("--topbar", "#b03030"); root.style.setProperty("--accent", "#e53e3e"); root.style.setProperty("--text", "#1a1a1a"); accentColor='#e53e3e'; textColorValue='#1a1a1a'; break; case "dark": default: root.style.setProperty("--bg","#1e1e1e"); root.style.setProperty("--sidebar","#111111"); root.style.setProperty("--topbar","#2c2c2c"); root.style.setProperty("--accent","#444444"); root.style.setProperty("--text","#ffffff"); accentColor='#444444'; textColorValue='#ffffff'; break; } currentThemeColor=accentColor; body.setAttribute('data-theme', value); updateSelectArrowColor(textColorValue); if(root.style && typeof root.style.setProperty==='function'){ const ca=getComputedStyle(root).getPropertyValue('--accent').trim(); const ct=getComputedStyle(root).getPropertyValue('--text').trim(); const ctb=getComputedStyle(root).getPropertyValue('--topbar').trim(); root.style.setProperty('--slider-track-bg', ca); root.style.setProperty('--slider-thumb-bg', ct); root.style.setProperty('--slider-progress-color', ct); root.style.setProperty('--game-card-bg', ctb); root.style.setProperty('--game-card-hover-bg', ca); } updateFavicon(accentColor); updateWelcomeLogoColor(accentColor); saveSetting(LS_THEME, value); applyCustomBackground(); }

        // --- Search & Filtering ---
        function filterGames() { const s_in=document.getElementById('search'); const mc=document.getElementById('main-content'); if(!s_in||!mc) return; const st=s_in.value.toLowerCase().trim(); const glc=mc.querySelector('.game-list-container'); let ngfm=mc.querySelector('#no-games-found'); let vgc=0; if(glc){ const gcs=glc.querySelectorAll('.game-card'); if(gcs.length>0){gcs.forEach(c=>{const ne=c.querySelector('h4');const ce=c.querySelector('p.category');const n=ne?ne.textContent.toLowerCase():'';const cat=ce?ce.textContent.toLowerCase():'';if(!st||n.includes(st)||cat.includes(st)){c.style.display='';vgc++;}else{c.style.display='none';}});}else{vgc=0;}} if(!ngfm && glc && games.length===0 && !st){ const me=document.createElement('p');me.id='no-games-found';me.style.cssText="grid-column:1/-1;text-align:center;opacity:0.7;padding:20px;color:var(--text);";me.textContent="No games added yet.";glc.appendChild(me);ngfm=me;}else if(ngfm){ const tg=games.length; if(vgc===0 && tg>0 && st){ngfm.textContent=`No games found matching "${s_in.value.trim()}"`;ngfm.style.display='block';}else if(vgc===0 && tg===0){ngfm.textContent=`No games added yet.`;ngfm.style.display='block';}else{ngfm.style.display='none';}} const plc=mc.querySelector('.proxy-list-container'); if(plc&&st){const pcs=plc.querySelectorAll('.proxy-card');pcs.forEach(c=>{const ne=c.querySelector('h4');const n=ne?ne.textContent.toLowerCase():'';if(n.includes(st)){c.style.display='';}else{c.style.display='none';}});}else if(plc){const pcs=plc.querySelectorAll('.proxy-card');pcs.forEach(c=>c.style.display='');} }
        const debouncedFilterGames = debounce(filterGames, 300);

        // --- Warn on Close Logic ---
        function handleMainBeforeUnload(e) { if(warnOnClose){const cm='Close Qbit?';e.preventDefault();e.returnValue=cm;return cm;} }

        // --- Function to Clear All Local Storage Data ---
        function clearAllData() { if(confirm("Clear ALL saved data (name, settings, games, background)? Cannot be undone.")){console.log("[DEBUG] Clearing all data..."); try{const ktr=[LS_USERNAME,LS_THEME,LS_FONTSIZE,LS_FONTFAMILY,LS_GAMES,LS_CATEGORIES,LS_WARNONCLOSE,LS_INITIALIZED,LS_BGIMAGE_ENABLED,LS_BGIMAGE_URL];ktr.forEach(k=>{removeSetting(k);console.log(`Removed: ${k}`);});alert("Data cleared. Reloading.");window.location.reload();}catch(e){console.error("Clear data err:", e);alert("Error clearing data.");}}else{console.log("Clear cancelled.");}}

        // --- Load Settings & Initial Setup ---
        function loadSettingsAndInit() { console.log("[DEBUG] Init."); try { const t=localStorage.getItem(LS_THEME)||'dark'; const fs=localStorage.getItem(LS_FONTSIZE)||'16'; const ff=localStorage.getItem(LS_FONTFAMILY)||"'Segoe UI', sans-serif"; currentUserName=localStorage.getItem(LS_USERNAME); warnOnClose=localStorage.getItem(LS_WARNONCLOSE)==='true'; bgImageEnabled=localStorage.getItem(LS_BGIMAGE_ENABLED)==='true'; bgImageUrl=localStorage.getItem(LS_BGIMAGE_URL)||''; if(themeSelector)themeSelector.value=t; if(fontSelector)fontSelector.value=ff; if(fontSizeSlider)fontSizeSlider.value=fs; if(warnOnCloseSwitch)warnOnCloseSwitch.checked=warnOnClose; if(bgImageToggleSwitch)bgImageToggleSwitch.checked=bgImageEnabled; updateTheme(t); updateFontSize(fs); updateFontFamily(ff); if(warnOnClose)window.addEventListener('beforeunload',handleMainBeforeUnload); loadGames(); loadCategories(); if(welcomeAreaPlaceholder)welcomeAreaPlaceholder.style.display='none'; if(currentUserName)showSection('welcome'); else { if(welcomeAreaPlaceholder&&mainContent)mainContent.appendChild(welcomeAreaPlaceholder); if(welcomeAreaPlaceholder)welcomeAreaPlaceholder.style.display='flex'; promptForName(); } updateFavicon(currentThemeColor); } catch(e){ console.error("Init err:", e); if(mainContent)mainContent.innerHTML=`<h2 style="color:red;text-align:center;">Error loading state: ${e.message}</h2>`; updateTheme('dark'); updateFontSize('16'); updateFontFamily("'Segoe UI', sans-serif"); if(!currentUserName)promptForName(); else showSection('welcome'); } updateSelectArrowColor(getComputedStyle(root).getPropertyValue('--text').trim()); console.log("Init complete."); }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => { console.log("DOM ready."); try { mainContent=document.getElementById("main-content"); settingsPanel=document.getElementById("settingsPanel"); root=document.documentElement; body=document.body; faviconLink=document.getElementById('dynamic-favicon'); namePromptModal=document.getElementById('namePromptModal'); gameModal=document.getElementById('gameModal'); settingsBtn=document.getElementById('settingsBtn'); searchInput=document.getElementById('search'); welcomeAreaPlaceholder=document.getElementById('welcome-area-placeholder'); themeSelector=document.getElementById('themeSelector'); fontSelector=document.getElementById('fontSelector'); fontSizeSlider=document.getElementById('fontSizeSlider'); warnOnCloseSwitch=document.getElementById('warnOnCloseSwitch'); bgImageToggleSwitch=document.getElementById('bgImageToggleSwitch'); bgImageControlContainer=document.getElementById('bgImageControlContainer'); bgImageFileInput=document.getElementById('bgImageFileInput'); clearBgImageBtn=document.getElementById('clearBgImageBtn'); const ce={mainContent,settingsPanel,settingsBtn,namePromptModal,gameModal,searchInput,themeSelector,fontSelector,fontSizeSlider,warnOnCloseSwitch,bgImageToggleSwitch,bgImageControlContainer,bgImageFileInput,clearBgImageBtn}; const m=Object.entries(ce).filter(([k,v])=>!v).map(([k])=>k); if(m.length>0) throw new Error(`Missing elements: ${m.join(', ')}`); } catch(e){ console.error("FATAL:", e); document.body.innerHTML=`<div style="padding:30px;color:red;background:#333;"><h2>App Init Error</h2><p>${e.message}</p></div>`; return; } loadSettingsAndInit(); console.log("Attaching listeners."); settingsBtn.addEventListener('click',toggleSettings); searchInput.addEventListener('input',debouncedFilterGames); const sgb=document.getElementById('saveGameBtn');const cgb=document.getElementById('cancelGameBtn');const acb=document.getElementById('addCategoryBtn'); if(sgb)sgb.addEventListener('click',handleSaveGame); if(cgb)cgb.addEventListener('click',closeGameModal); if(acb)acb.addEventListener('click',handleAddCategory); if(gameModal)gameModal.addEventListener('click',(e)=>{if(e.target===gameModal)closeGameModal();}); fontSizeSlider.addEventListener('input',(e)=>updateFontSize(e.target.value));
        // Warn on Close Listener with Broadcast
        warnOnCloseSwitch.addEventListener('change',(e)=>{ warnOnClose=e.target.checked; saveSetting(LS_WARNONCLOSE,warnOnClose); if(warnOnClose)window.addEventListener('beforeunload',handleMainBeforeUnload); else window.removeEventListener('beforeunload',handleMainBeforeUnload); try{ if(warningChannel) warningChannel.postMessage({warn:warnOnClose}); console.log(`[DEBUG] Broadcasted warn status: ${warnOnClose}`); } catch(be){ console.error("Warn broadcast err:", be); } });
        // Background Listeners
        bgImageToggleSwitch.addEventListener('change',(e)=>{bgImageEnabled=e.target.checked;saveSetting(LS_BGIMAGE_ENABLED,bgImageEnabled);if(!bgImageEnabled){bgImageUrl='';removeSetting(LS_BGIMAGE_URL);if(bgImageFileInput)bgImageFileInput.value=null;}applyCustomBackground();}); bgImageFileInput.addEventListener('change',handleImageFileSelect); clearBgImageBtn.addEventListener('click',clearCustomBackground);
        // Clear All Data Listener
        const cdb=document.getElementById('clearDataBtn'); if(cdb)cdb.addEventListener('click',clearAllData); else console.warn("Clear Data btn not found."); console.log("Listeners attached."); });
    </script>

</body>
</html>
