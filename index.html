<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Qbit</title>
    <link rel="icon" id="dynamic-favicon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>Q</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- Root Variables and Base Styles --- */
        :root {
            /* Theme Variables */ --bg: #1e1e1e; --sidebar: #111; --topbar: #2c2c2c; --accent: #444; --text: #ffffff;
            /* Font */ --font-size: 16px; --font-family: 'Segoe UI', sans-serif;
            /* Radii */ --radius-std: 8px; --radius-lg: 12px;
            /* Slider */ --slider-track-bg: var(--accent); --slider-thumb-bg: var(--text); --slider-progress-color: var(--text); --slider-track-height: 6px; --slider-thumb-size: 16px;
            /* Components */ --game-card-bg: var(--topbar); --game-card-hover-bg: var(--accent);
            /* Colors */ --delete-color: #e53e3e; --edit-color: #4299e1; --play-color: #48bb78; --mod-color: #4ec9b0; --owner-color: #c586c0; --system-color: #ce9178;
            /* Background */ --custom-bg-image: none;
            /* Added: Accent Blue for focus */ --accent-blue: #3b82f6;
        }
        html, body { height: 100%; margin: 0; overflow: hidden; }
        body, .sidebar, .main, .modal-overlay, .modal-box, .sidebar button, .search input, .icon-btn, .content, iframe, .settings-panel label, .settings-panel select, .settings-panel input[type="file"], .settings-panel button, .custom-slider-container, input[type="range"].custom-slider, .modal-box input, .modal-box select, .modal-box button, .game-card, .game-card button, #addGameBtn, #gameModal input, #gameModal select, #gameModal button, #addCategoryBtn, .proxy-card, .proxy-card button, #clearDataBtn, .chat-panel, .chat-section, .chat-log-container, .chat-input-area input, .chat-input-area button { box-sizing: border-box; }
        body { font-family: var(--font-family); display: flex; background-color: var(--bg); color: var(--text); font-size: var(--font-size); transition: background-color 0.3s, color 0.3s; background-image: var(--custom-bg-image); background-size: cover; background-position: center center; background-repeat: no-repeat; background-attachment: fixed; }

        /* --- Layout: Sidebar, Main, Topbar --- */
        .sidebar { width: 200px; background-color: var(--sidebar); flex-shrink: 0; animation: slideInLeft 0.5s ease forwards; transition: background-color 0.3s; display:flex; flex-direction:column; padding: 20px 10px; gap: 20px; height: 100vh; }
        .sidebar h2 { font-size: 1.1em; border-bottom: 1px solid var(--accent); padding-bottom: 5px; margin-bottom: 10px; color: var(--text);}
        .sidebar button { background: var(--accent); border: none; padding: 0.6em 0.8em; text-align: left; color: var(--text); cursor: pointer; border-radius: var(--radius-std); transition: background 0.3s, transform 0.2s, color 0.3s; font-size: 0.9em; display: block; width: 100%; }
        .sidebar button:hover:not(:disabled) { filter: brightness(1.1); transform: scale(1.03); }
        .sidebar button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(50%); transform: none;}
        .main { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; height: 100vh; }
        .topbar { background-color: var(--topbar); animation: slideDown 0.5s ease forwards; transition: background-color 0.3s; display:flex; align-items:center; justify-content: space-between; padding: 10px 20px; flex-shrink: 0; z-index: 2; }
        .search { flex-grow: 1; margin-right: 10px; }
        .search input { width: 100%; padding: 8px 12px; background-color: var(--bg); color: var(--text); border: 1px solid var(--accent); border-radius: var(--radius-std); font-size: 0.9em; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        .top-buttons { display: flex; gap: 10px; }
        .icon-btn { width: 38px; height: 38px; border-radius: 50%; background-color: var(--accent); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.3s, transform 0.2s, filter 0.2s; padding: 0; }
        .icon-btn:disabled { filter: grayscale(70%) opacity(50%); cursor: not-allowed; transform: none; }
        .icon-btn:hover:not(:disabled) { filter: brightness(1.1); transform: scale(1.1); }
        .icon-btn svg { width: 18px; height: 18px; fill: var(--text); display: block; }

        /* --- Content Area --- */
        .content { padding: 25px; overflow-y: auto; flex-grow: 1; line-height: 1.6; color: var(--text); display: block; height: calc(100% - 58px); /* Adjusted for topbar height */ }
        .content h1 { font-size: 1.8em; margin-bottom: 0.5em; color: var(--text);} .content h2 { font-size: 1.4em; margin-bottom: 0.4em; margin-top: 1em; color: var(--text);} .content p { font-size: 1em; margin-bottom: 1em; color: var(--text);}

        /* --- Welcome Area --- */
        #welcome-area { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100%; opacity: 0; animation: fadeIn 1s 0.2s forwards; padding-bottom: 20px; overflow-y: auto; }
        #welcome-logo-container { width: 64px; height: 64px; margin-bottom: 20px; opacity: 0; transform: scale(0.5); animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.5s forwards; flex-shrink: 0; }
        #welcome-logo-container svg { display: block; width: 100%; height: 100%; }
        #welcome-message { opacity: 0; transform: translateY(20px); animation: fadeInUp 0.8s ease-out 0.8s forwards; color: var(--text); margin-bottom: 15px; flex-shrink: 0; font-size: 1.6em; }
        #user-count-display { font-size: 0.9em; opacity: 0.8; margin-bottom: 25px; color: var(--text); flex-shrink: 0; }
        #changelog-section { margin-top: 20px; padding: 15px 20px; background-color: rgba(0, 0, 0, 0.1); border-radius: var(--radius-std); width: 80%; max-width: 600px; text-align: left; border: 1px solid var(--accent); flex-shrink: 0; margin-bottom: auto; }
        #changelog-section h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.2em; border-bottom: 1px solid var(--accent); padding-bottom: 5px; color: var(--text); }
        .changelog-version { margin-bottom: 15px; }
        .changelog-version h4 { margin: 0 0 5px 0; font-size: 1em; color: var(--text); }
        .changelog-version ul { margin: 0; padding-left: 20px; list-style: disc; font-size: 0.9em; color: var(--text); opacity: 0.9; }
        .changelog-version ul li { margin-bottom: 4px; }

        /* --- Settings Panel --- */
        .settings-panel { position: fixed; top: 55px; right: 20px; background-color: var(--topbar); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 280px; z-index: 10; opacity: 0; transform: translateY(-20px); transition: opacity 0.4s ease, transform 0.4s ease, background-color 0.3s, visibility 0s linear 0.4s; display: none; flex-direction: column; gap: 15px; color: var(--text); }
        .settings-panel.show { display: flex; opacity: 1; transform: translateY(0); visibility: visible; transition: opacity 0.4s ease, transform 0.4s ease, background-color 0.3s; }
        .settings-panel label:not(.toggle-switch-label) { font-size: 0.9em; display: flex; flex-direction: column; gap: 8px; color: var(--text); }
        .settings-panel select { padding: 10px; border-radius: var(--radius-std); border: 1px solid var(--accent); background-color: var(--bg); color: var(--text); transition: background-color 0.3s, color 0.3s, border-color 0.3s; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23${(typeof getComputedStyle !== 'undefined' ? (getComputedStyle(document.documentElement).getPropertyValue('--text') || '#ffffff').substring(1) : 'ffffff')}%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 12px center; background-size: 10px auto; padding-right: 35px; font-size: 0.9em; }
        /* Slider Styles */
        .custom-slider-container { position: relative; width: 100%; height: var(--slider-thumb-size); display: flex; align-items: center; cursor: pointer; margin-top: 5px; }
        input[type="range"].custom-slider { appearance: none; -webkit-appearance: none; width: 100%; height: var(--slider-track-height); background: transparent; position: absolute; top: calc(50% - var(--slider-track-height) / 2); left: 0; z-index: 2; margin: 0; cursor: pointer; }
        input[type="range"].custom-slider::-webkit-slider-thumb { appearance: none; -webkit-appearance: none; width: var(--slider-thumb-size); height: var(--slider-thumb-size); background: transparent; border: none; }
        input[type="range"].custom-slider::-moz-range-thumb { width: var(--slider-thumb-size); height: var(--slider-thumb-size); background: transparent; border: none; border-radius: 0; }
        .slider-track { position: absolute; width: 100%; height: var(--slider-track-height); background-color: var(--slider-track-bg); border-radius: var(--slider-track-height); top: calc(50% - var(--slider-track-height) / 2); left: 0; z-index: 0; transition: background-color 0.3s; }
        .slider-progress { position: absolute; height: var(--slider-track-height); background-color: var(--slider-progress-color); border-radius: var(--slider-track-height); top: calc(50% - var(--slider-track-height) / 2); left: 0; z-index: 1; width: 50%; transition: background-color 0.3s; opacity: 0.7; }
        .slider-thumb { position: absolute; width: var(--slider-thumb-size); height: var(--slider-thumb-size); background-color: var(--slider-thumb-bg); border-radius: 50%; border: 1px solid var(--accent); top: calc(50% - var(--slider-thumb-size) / 2); left: 50%; transform: translateX(-50%); z-index: 3; box-shadow: 0 1px 3px rgba(0,0,0,0.2); transition: background-color 0.3s, border-color 0.3s; }
        .slider-value-display { margin-left: 10px; font-size: 0.85em; color: var(--text); opacity: 0.8; position: absolute; right: 0; top: -1.5em; min-width: 30px; text-align: right; }
        /* Toggle Switch Styles */
        .toggle-switch-label { display: flex; align-items: center; justify-content: space-between; cursor: pointer; font-size: 0.9em; color: var(--text); position: relative; user-select: none; }
        .toggle-switch { opacity: 0; width: 0; height: 0; position: absolute; }
        .toggle-slider { position: relative; display: inline-block; width: 40px; height: 20px; background-color: var(--accent); border-radius: 20px; transition: background-color 0.3s; flex-shrink: 0; }
        .toggle-slider::before { content: ""; position: absolute; width: 16px; height: 16px; left: 2px; bottom: 2px; background-color: var(--text); border-radius: 50%; transition: transform 0.3s; }
        .toggle-switch:checked + .toggle-slider { background-color: var(--play-color); }
        .toggle-switch:checked + .toggle-slider::before { transform: translateX(20px); }
        .toggle-switch:focus-visible + .toggle-slider { box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent); }
        /* Danger/Action Buttons */
        .danger-btn { background-color: var(--accent); color: var(--text); border: none; padding: 10px 15px; border-radius: var(--radius-std); cursor: pointer; font-size: 0.9em; font-weight: bold; text-align: center; transition: background-color 0.3s, transform 0.1s, filter 0.3s; margin-top: 10px; width: 100%; }
        .danger-btn:hover { filter: brightness(0.85); }
        .danger-btn:active { transform: scale(0.98); }
        #logoutBtn { background-color: var(--edit-color); } /* Specific color for logout */
        #logoutBtn:hover:not(:disabled) { filter: brightness(1.15); }
        #logoutBtn:disabled { background-color: var(--accent); opacity: 0.5; cursor: not-allowed; filter: grayscale(50%); transform: none;} /* Style for disabled logout */

        /* --- Modals (Auth, Game) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 100; opacity: 0; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .modal-overlay.visible { display: flex; opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-box { background-color: var(--topbar); padding: 30px 40px; border-radius: var(--radius-lg); border: 1px solid var(--accent); box-shadow: 0 5px 20px rgba(0,0,0,0.4); text-align: center; color: var(--text); transform: scale(0.9); transition: transform 0.3s ease, background-color 0.3s, color 0.3s; max-width: 450px; width: 90%; }
        .modal-overlay.visible .modal-box { transform: scale(1); }
        .modal-box h3 { margin-top: 0; margin-bottom: 25px; font-size: 1.3em; color: var(--text); }
        .modal-box p { margin-bottom: 20px; font-size: 0.95em; opacity: 0.9; text-align: left; color: var(--text); }
        .modal-box label { display: block; text-align: left; margin-bottom: 5px; font-size: 0.9em; font-weight: bold; color: var(--text); }
        .modal-box .form-field { margin-bottom: 18px; }
        .modal-box .category-field { display: flex; align-items: center; gap: 10px; }
        .modal-box input[type="text"], .modal-box input[type="url"], .modal-box input[type="password"], .modal-box select { display: block; width: 100%; padding: 10px; border: 1px solid var(--accent); border-radius: var(--radius-std); background-color: var(--bg); color: var(--text); font-size: 1em; flex-grow: 1; }
        .modal-box select { appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23${(typeof getComputedStyle !== 'undefined' ? (getComputedStyle(document.documentElement).getPropertyValue('--text') || '#ffffff').substring(1) : 'ffffff')}%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 12px center; background-size: 10px auto; padding-right: 35px; }
        #addCategoryBtn { padding: 6px 10px; font-size: 0.8em; flex-shrink: 0; background-color: var(--accent); color: var(--text); border: none; border-radius: var(--radius-std); cursor: pointer; }
        #addCategoryBtn:hover { filter: brightness(1.2); }
        .modal-box .modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-box button { padding: 10px 20px; border: none; border-radius: var(--radius-std); font-size: 1em; cursor: pointer; transition: background-color 0.3s, transform 0.1s; color: var(--text); }
        .modal-box button.primary { background-color: var(--accent); }
        .modal-box button.secondary { background-color: transparent; border: 1px solid var(--accent); }
        .modal-box button:hover { filter: brightness(1.2); } .modal-box button:active { transform: scale(0.95); }
        .modal-box button:disabled { filter: grayscale(50%); opacity: 0.6; cursor: not-allowed; }
        #loginError, #registerError { color: var(--delete-color); margin-bottom: 15px; display: none; text-align: left; font-size: 0.9em;}

        /* --- Game/Proxy Cards --- */
        #games-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--accent); }
        #addGameBtn { background-color: var(--accent); color: var(--text); border: none; padding: 8px 15px; border-radius: var(--radius-std); cursor: pointer; font-size: 0.9em; transition: background-color 0.3s, transform 0.1s; }
        #addGameBtn:hover { filter: brightness(1.2); } #addGameBtn:active { transform: scale(0.95); }
        .game-list-container, .proxy-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; padding-top: 10px; }
        .game-card, .proxy-card { background-color: var(--game-card-bg); border-radius: var(--radius-lg); padding: 15px; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid transparent; transition: transform 0.3s ease, background-color 0.3s, border-color 0.3s, box-shadow 0.3s; opacity: 0; transform: translateY(20px); animation: cardFadeInUp 0.5s ease forwards; min-height: 110px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); color: var(--text); }
        .game-card:nth-child(n), .proxy-card:nth-child(n) { animation-delay: calc(0.05s * n); } /* Stagger animation slightly */
        .game-card:hover, .proxy-card:hover { transform: translateY(-5px) scale(1.02); background-color: var(--game-card-hover-bg); border-color: var(--text); box-shadow: 0 8px 15px rgba(0,0,0,0.3); }
        .proxy-card h4 { font-size: 1.05em; margin-top: 0; margin-bottom: 8px; word-break: break-word; flex-grow: 1; color: var(--text);}
        .game-card p.category { font-size: 0.75em; color: var(--text); opacity: 0.7; margin-top: 0; margin-bottom: 10px; background-color: rgba(0,0,0,0.2); padding: 3px 8px; border-radius: var(--radius-std); display: inline-block; }
        .game-card-actions, .proxy-card-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: auto; }
        .game-card-actions button, .proxy-card-actions button { background-color: transparent; border: none; border-radius: var(--radius-std); cursor: pointer; padding: 5px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, transform 0.1s; }
        .game-card-actions button svg, .proxy-card-actions button svg { width: 18px; height: 18px; display: block; fill: var(--text); opacity: 0.7; transition: opacity 0.2s, fill 0.2s; }
        .game-card-actions button:hover svg, .proxy-card-actions button:hover svg { opacity: 1; }
        .game-card-actions button:active, .proxy-card-actions button:active { transform: scale(0.9); }
        .game-card-actions button.play-btn:hover svg, .proxy-card-actions button.play-btn:hover svg { fill: var(--play-color); }
        .game-card-actions button.edit-btn:hover svg { fill: var(--edit-color); }
        .game-card-actions button.delete-btn:hover svg { fill: var(--delete-color); }
        .game-card.deleting { animation: cardFadeOut 0.4s ease forwards; }
        #no-games-found { display: none; grid-column: 1 / -1; text-align: center; opacity: 0.7; padding: 20px; color: var(--text);}
        .game-card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-grow: 1; min-height: 20px; }
        .game-favicon { width: 16px; height: 16px; flex-shrink: 0; border-radius: 3px; object-fit: contain; background-color: rgba(128, 128, 128, 0.1); display: inline-block; vertical-align: middle; }
        .game-card-header h4 { margin: 0; flex-grow: 1; line-height: 1.2; color: var(--text); word-break: break-word; }

        /* --- Chat Panel & Messages --- */
        .chat-panel { background-color: var(--bg); padding: 0px 15px 15px 15px; border: none; border-radius: 0; width: 100%; height: 100%; flex-grow: 1; display: none; flex-direction: column; color: var(--text); overflow: hidden; }
        #chatActiveSection { display: flex; flex-direction: column; height: 100%; flex-grow: 1; min-height: 0; }
        .chat-log-container { flex-grow: 1; overflow-y: auto; margin-bottom: 15px; background-color: transparent; border: none; padding: 0px 5px 10px 10px; display: flex; flex-direction: column; gap: 0px; }
        .chat-loading-indicator { text-align: center; padding: 10px; font-style: italic; opacity: 0.7; color: var(--text); display: none; flex-shrink: 0; order: -1; }
        .chat-message-group { display: flex; padding: 8px 0; margin-bottom: 4px; border-radius: var(--radius-std); transition: background-color 0.2s; }
        .chat-message-group:hover { background-color: rgba(128, 128, 128, 0.08); }
        .chat-pfp-container { width: 40px; height: 40px; margin-right: 12px; flex-shrink: 0; border-radius: 50%; overflow: hidden; background-color: var(--accent); align-self: flex-start; margin-top: 2px; }
        .chat-pfp-container svg { width: 100%; height: 100%; display: block; }
        .chat-message-content { flex-grow: 1; display: flex; flex-direction: column; }
        .chat-message-header { display: flex; align-items: baseline; margin-bottom: 3px; }
        /* Username and Role Styling */
        .chat-username { font-weight: 700; margin-right: 4px; /* Reduced margin */ font-size: 0.98em; color: var(--text); cursor: default; }
        .username-mod { color: var(--mod-color); /* Teal */ }
        .username-owner { color: var(--owner-color); /* Purple */ font-weight: bold; }
        .role-tag { font-size: 0.8em; opacity: 0.8; margin-left: 4px; font-weight: normal; color: var(--text-muted); }
        .username-mod + .role-tag { color: var(--mod-color); opacity: 0.9; }
        .username-owner + .role-tag { color: var(--owner-color); opacity: 0.9; font-weight: bold; }
        /* Timestamp and Message Text */
        .chat-timestamp { font-size: 0.75em; color: var(--text); opacity: 0.6; padding-left: 8px; cursor: default; white-space: nowrap; }
        .chat-message-text { margin: 0 0 2px 0; font-size: 0.95em; word-wrap: break-word; white-space: pre-wrap; line-height: 1.45; color: var(--text); }
        .chat-system-message { font-style: italic; font-size: 0.85em; color: var(--system-color); opacity: 0.9; text-align: center; margin: 8px 0; padding: 2px 10px; width: fit-content; margin-left: auto; margin-right: auto; background-color: rgba(128, 128, 128, 0.1); border-radius: var(--radius-std); flex-shrink: 0; }
        /* Chat Input Area */
        .chat-input-area { display: flex; gap: 10px; align-items: center; margin-top: auto; flex-shrink: 0; padding-top: 10px; }
        .chat-input-area input { flex-grow: 1; margin: 0; background-color: var(--topbar); padding: 10px; border: 1px solid var(--accent); border-radius: var(--radius-std); color: var(--text); font-size: 1em; }
        .chat-input-area input:disabled { background-color: var(--sidebar); cursor: not-allowed; opacity: 0.6; }
        .chat-input-area input:disabled::placeholder { opacity: 0.5; }
        .chat-input-area .icon-btn { flex-shrink: 0; width: 38px; height: 38px; }
        #sendMessageBtn { display: none; } /* Hidden by default, shown by JS when logged in */

        /* --- Focus Styles --- */
        *:focus { outline: none; }
        button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible, iframe:focus-visible, .game-card:focus-visible, .proxy-card:focus-visible, input[type="file"]:focus-visible { box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent-blue); transition: box-shadow 0.2s ease-in-out; border-color: var(--accent-blue); }
        .settings-panel:focus-visible { border-radius: var(--radius-lg); box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent-blue); }
        input[type="range"].custom-slider:focus-visible { box-shadow: none; }
        input[type="range"].custom-slider:focus-visible + .slider-track + .slider-progress + .slider-thumb { box-shadow: 0 0 0 2px var(--bg), 0 0 0 4px var(--accent-blue); border-radius: 50%; }

        /* --- Placeholders --- */
        input::placeholder, .modal-box input::placeholder, .search input::placeholder, textarea::placeholder { color: var(--text); opacity: 0.6; }

        /* --- Theme Overrides (Example: Trigonometrical Red) --- */
        [data-theme="trigonometrical-red"] { --mod-color: #1abc9c; --owner-color: #9b59b6; --system-color: #e67e22; }
        [data-theme="trigonometrical-red"] .modal-box, [data-theme="trigonometrical-red"] .settings-panel, [data-theme="trigonometrical-red"] .sidebar button, [data-theme="trigonometrical-red"] .sidebar h2, [data-theme="trigonometrical-red"] .icon-btn svg, [data-theme="trigonometrical-red"] .slider-value-display { color: #ffffff; fill: #ffffff; }
        /* ... other overrides ... */
        [data-theme="trigonometrical-red"] .chat-panel { background-color: #ffffff; color: #1a1a1a; }
        [data-theme="trigonometrical-red"] .chat-log-container { background-color: #f8f8f8; }
        [data-theme="trigonometrical-red"] .chat-system-message { color: var(--system-color); background-color: rgba(230, 126, 34, 0.1); }
        /* ... more overrides ... */


        /* --- Animations --- */
        @keyframes slideInLeft { from { transform: translateX(-100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes fadeInUp { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes cardFadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes cardFadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.8); } }

    </style>
</head>
<body data-theme="dark">

    <div class="modal-overlay" id="loginModal"> <div class="modal-box"> <h3>Login to Qbit</h3> <div id="loginError"></div> <div class="form-field"> <label for="loginUsername">Username:</label> <input type="text" id="loginUsername" placeholder="Your Username" maxlength="30"> </div> <div class="form-field"> <label for="loginPassword">Password:</label> <input type="password" id="loginPassword" placeholder="Your Password"> </div> <div class="modal-actions" style="justify-content: space-between;"> <button type="button" class="secondary" id="switchToRegisterBtn" style="font-size: 0.9em;">Need an account?</button> <div> <button type="button" class="secondary" id="cancelLoginBtn">Cancel</button> <button type="button" class="primary" id="submitLoginBtn">Login</button> </div> </div> </div> </div>
    <div class="modal-overlay" id="registerModal"> <div class="modal-box"> <h3>Register for Qbit</h3> <div id="registerError"></div> <p style="font-size: 0.85em; opacity: 0.8; text-align: left;">Usernames cannot contain spaces (max 30 chars). Passwords need 6+ chars.</p> <div class="form-field"> <label for="registerUsername">Choose Username:</label> <input type="text" id="registerUsername" placeholder="New Username" maxlength="30"> </div> <div class="form-field"> <label for="registerPassword">Choose Password (min 6 chars):</label> <input type="password" id="registerPassword" placeholder="New Password"> </div> <div class="form-field"> <label for="registerPasswordConfirm">Confirm Password:</label> <input type="password" id="registerPasswordConfirm" placeholder="Confirm Password"> </div> <div class="modal-actions" style="justify-content: space-between;"> <button type="button" class="secondary" id="switchToLoginBtn" style="font-size: 0.9em;">Have an account?</button> <div> <button type="button" class="secondary" id="cancelRegisterBtn">Cancel</button> <button type="button" class="primary" id="submitRegisterBtn">Register</button> </div> </div> </div> </div>
    <div class="modal-overlay" id="gameModal"> <div class="modal-box"> <h3 id="gameModalTitle">Add New Game</h3> <input type="hidden" id="gameIdInput"> <div class="form-field"> <label for="gameNameInput">Name:</label> <input type="text" id="gameNameInput" placeholder="e.g., 2048" required> </div> <div class="form-field"> <label for="gameUrlInput">URL:</label> <input type="url" id="gameUrlInput" placeholder="https://play2048.co/" required> </div> <div class="form-field"> <label for="gameCategorySelect">Category:</label> <div class="category-field"> <select id="gameCategorySelect"> <option value="">Uncategorized</option> </select> <button id="addCategoryBtn" title="Add New Category">+</button> </div> </div> <div class="modal-actions"> <button type="button" class="secondary" id="cancelGameBtn">Cancel</button> <button type="button" class="primary" id="saveGameBtn">Save Game</button> </div> </div> </div>

    <div class="sidebar">
        <h2>Qbit</h2>
        <button onclick="showSection('welcome')">Home</button>
        <button onclick="showSection('games')" id="sidebarGamesBtn">Games</button>
        <button onclick="showSection('proxy')" id="sidebarProxyBtn">Proxy</button>
        <button onclick="showSection('tools')" id="sidebarToolsBtn">Tools</button>
    </div>

    <div class="main">
        <div class="topbar">
            <div class="search"> <input type="text" id="search" placeholder="Search Games or..." /> </div>
            <div class="top-buttons">
                <button class="icon-btn" onclick="toggleChatView()" title="Toggle Chat View" id="chatToggleBtn">
                    <svg viewBox="0 0 24 24"><path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z"/></svg>
                </button>
                <button class="icon-btn" title="Settings" id="settingsBtn">
                    <svg viewBox="0 0 24 24"><path d="M12 15.5C10.07 15.5 8.5 13.93 8.5 12S10.07 8.5 12 8.5 15.5 10.07 15.5 12 13.93 15.5 12 15.5ZM19.43 12.98C19.46 12.66 19.5 12.34 19.5 12S19.46 11.34 19.43 11.02L21.54 9.37C21.73 9.21 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.06 19.3 4.97 19.07 5.03L16.56 5.67C16.04 5.25 15.47 4.89 14.85 4.6L14.5 2H9.5L9.15 4.6C8.53 4.89 7.96 5.25 7.44 5.67L4.93 5.03C4.7 4.97 4.46 5.06 4.34 5.27L2.34 8.73C2.22 8.95 2.27 9.21 2.46 9.37L4.57 11.02C4.54 11.34 4.5 11.66 4.5 12S4.54 12.66 4.57 12.98L2.46 14.63C2.27 14.79 2.22 15.05 2.34 15.27L4.34 18.73C4.46 18.94 4.7 19.03 4.93 18.97L7.44 18.33C7.96 18.75 8.53 19.11 9.15 19.4L9.5 22H14.5L14.85 19.4C15.47 19.11 16.04 18.75 16.56 18.33L19.07 18.97C19.3 19.03 19.54 18.94 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.79 21.54 14.63L19.43 12.98Z"/></svg>
                </button>
            </div>
        </div>

        <div class="content" id="main-content">
            <div id="welcome-area-placeholder" style="display: none; flex-direction:column; align-items:center; justify-content:center; height:100%; text-align:center;"><h2>Loading Qbit...</h2><p style="opacity:0.7;">Please wait.</p></div>
            </div>

        <div class="chat-panel" id="chatPanel">
             <div class="chat-section" id="chatActiveSection">
                  <div class="chat-log-container" id="chatLogContainer">
                       <div class="chat-loading-indicator">Loading...</div>
                       {/* Chat messages dynamically loaded here */}
                  </div>
                  <div class="chat-input-area">
                       <input type="text" id="chatMessageInput" placeholder="Login to chat..." disabled>
                       <button id="sendMessageBtn" class="icon-btn" title="Send Message" style="display: none;">
                            <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                       </button>
                  </div>
             </div>
        </div>

        <div class="settings-panel" id="settingsPanel">
            <label>Font Size: <span class="slider-value-display" id="fontSizeValue">16px</span> <div class="custom-slider-container"> <div class="slider-track"></div> <div class="slider-progress" id="fontSizeProgress"></div> <div class="slider-thumb" id="fontSizeThumb"></div> <input type="range" id="fontSizeSlider" class="custom-slider" min="12" max="24" step="1" value="16"> </div> </label>
            <label>Color Scheme: <select id="themeSelector" onchange="updateTheme(this.value)"> <option value="dark">Dark</option> <option value="light">Light</option> <option value="blue">Cool Blue</option> <option value="forest">Forest Green</option> <option value="sunset">Sunset Orange</option> <option value="trigonometrical-red">Trigonometrical Red</option> </select> </label>
            <label>Font Family: <select id="fontSelector" onchange="updateFontFamily(this.value)"> <option value="'Segoe UI', sans-serif">Segoe UI</option> <option value="Arial, sans-serif">Arial</option> <option value="Verdana, sans-serif">Verdana</option> <option value="'Times New Roman', Times, serif">Times New Roman</option> <option value="'Courier New', Courier, monospace">Courier New</option> <option value="Georgia, serif">Georgia</option> <option value="'Roboto', sans-serif">Roboto</option> <option value="'Lato', sans-serif">Lato</option> </select> </label>
            <label class="toggle-switch-label"> <span>Custom Background:</span> <input type="checkbox" id="bgImageToggleSwitch" class="toggle-switch"> <span class="toggle-slider"></span> </label>
            <div id="bgImageControlContainer"> <label for="bgImageFileInput">Select Image (Max 2MB):</label> <input type="file" id="bgImageFileInput" accept="image/*"> <button id="clearBgImageBtn" title="Remove custom background">Clear Background</button> </div>
            <label class="toggle-switch-label"> Warn on Close: <input type="checkbox" id="warnOnCloseSwitch" class="toggle-switch"> <span class="toggle-slider"></span> </label>
            <button id="logoutBtn" class="danger-btn" style="margin-top: 15px; background-color: var(--edit-color); display: none;">Logout</button>
            </div>
    </div>

<script>
    // --- Constants ---
    const BACKEND_URL = 'https://auckland-previous-sender-popular.trycloudflare.com'; // !!! UPDATE IF NEEDED !!!
    const CHAT_POLL_INTERVAL = 3000;
    const MESSAGE_COOLDOWN_MS = 2000;
    const CHAT_HISTORY_LOAD_LIMIT = 50;
    const MAX_IMAGE_SIZE_MB = 2;
    const MAX_IMAGE_SIZE_BYTES = MAX_IMAGE_SIZE_MB * 1024 * 1024;
    const LS_PREFIX = 'qbit_'; // LocalStorage Prefix
    const LS_THEME = LS_PREFIX + 'theme';
    const LS_FONTSIZE = LS_PREFIX + 'fontSize';
    const LS_FONTFAMILY = LS_PREFIX + 'fontFamily';
    const LS_GAMES = LS_PREFIX + 'games';
    const LS_CATEGORIES = LS_PREFIX + 'categories';
    const LS_WARNONCLOSE = LS_PREFIX + 'warnOnClose';
    const LS_INITIALIZED = LS_PREFIX + 'initialized_v3'; // Increment version if defaults change
    const LS_BGIMAGE_ENABLED = LS_PREFIX + 'bgImageEnabled';
    const LS_BGIMAGE_URL = LS_PREFIX + 'bgImageUrl';
    const LS_LOGGED_IN_USER = LS_PREFIX + 'loggedInUser_v2'; // Key for localStorage login state
    const LS_IS_BANNED = LS_PREFIX + 'isBanned'; // Key for client-side ban flag
    const USER_COUNT_POLL_INTERVAL = 15000;
    const BAN_CHECK_INTERVAL = 5000; // Check every 5 seconds

    // --- DOM Element References ---
    let mainContent, settingsPanel, root, body, faviconLink,
        gameModal, gameModalTitle, gameIdInput, gameNameInput, gameUrlInput,
        gameCategorySelect, addCategoryBtn, saveGameBtn, cancelGameBtn,
        fontSizeSlider, fontSizeThumb, fontSizeValueDisplay, fontSizeProgress,
        themeSelector, fontSelector, settingsBtn, searchInput, warnOnCloseSwitch,
        bgImageToggleSwitch, bgImageControlContainer, bgImageFileInput, clearBgImageBtn,
        loginModal, registerModal, loginUsername, loginPassword, submitLoginBtn, cancelLoginBtn, switchToRegisterBtn, loginError,
        registerUsername, registerPassword, registerPasswordConfirm, submitRegisterBtn, cancelRegisterBtn, switchToLoginBtn, registerError,
        logoutBtn, chatToggleBtn, sidebarGamesBtn, sidebarProxyBtn, sidebarToolsBtn,
        chatPanel, chatActiveSection, chatLogContainer, chatMessageInput, sendMessageBtn, chatLoadingIndicator,
        welcomeAreaPlaceholder;

    // --- Global State ---
    let currentThemeColor = '#444444'; let games = []; let categories = []; let isEditingGame = false;
    let warnOnClose = false; let bgImageEnabled = false; let bgImageUrl = ''; let debounceTimer;
    let isLoggedIn = false; let loggedInUsername = null; let isClientSideBanned = false; // State variable for ban flag
    let chatPollIntervalId = null; let lastMessageTimestamp = 0; let isChatViewActive = false;
    let lastSentTimestamp = 0; let isSendingMessage = false;
    let isLoadingOlderMessages = false; let oldestMessageTimestamp = null; let noMoreOlderMessages = false;
    let userCountIntervalId = null;
    let banCheckIntervalId = null; // To store the interval ID for ban checking

    // --- SVG Icons ---
    const ICONS = { play: `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`, edit: `<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`, delete: `<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>` };

    // --- Helper Functions (debounce, hash, color, logo) ---
    function debounce(func, delay) { return function(...args) { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => { func.apply(this, args); }, delay); }; }
    function simpleHash(str) { let hash = 5381; for (let i = 0; i < str.length; i++) { const char = str.charCodeAt(i); hash = ((hash << 5) + hash) + char; } return Math.abs(hash); }
    function stringToHslColor(str, s = 65, l = 55) { if (!str) str = "default"; const hash = simpleHash(str); const h = hash % 360; return `hsl(${h}, ${s}%, ${l}%)`; }
    function getLogoSvg(color) { const safeColor = color || '#444444'; return `<svg width="40" height="40" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" fill="${safeColor}"><rect x="5" y="9" width="7" height="14" rx="2.5"/><rect x="13" y="9" width="7" height="14" rx="2.5"/><rect x="21" y="9" width="7" height="14" rx="2.5"/></svg>`; }
    function generateUserPfpSvg(username) { const userColor = stringToHslColor(username, 65, 55); return getLogoSvg(userColor); }

    // --- LocalStorage/Settings Helpers ---
    function updateFavicon(color) { if (!faviconLink) return; const svgString = getLogoSvg(color); const dataUri = `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgString)}`; faviconLink.href = dataUri; }
    function saveSetting(key, value) { try { localStorage.setItem(key, value); } catch (e) { console.error(`LS Save Error for key "${key}":`, e); if (e.name === 'QuotaExceededError') alert(`Could not save setting. Storage limit reached.`); } }
    function removeSetting(key) { try { localStorage.removeItem(key); } catch (e) { console.error(`LS Remove Error for key "${key}":`, e); } }
    function updateSelectArrowColor(textColor = '#ffffff') { const styleId = 'dynamic-select-arrow-style'; let el = document.getElementById(styleId); if (!el) { el = document.createElement('style'); el.id = styleId; document.head.appendChild(el); } const safeColor = encodeURIComponent((textColor || '#ffffff').substring(1)); const svgUrl = `data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23${safeColor}%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E`; el.textContent = ` .settings-panel select, .modal-box select { background-image: url('${svgUrl}'); } `; }

    // --- Authentication Modals ---
    function showLoginModal() { closeAuthModals(); if (loginModal) { loginModal.classList.add('visible'); if(loginUsername) loginUsername.focus(); if(loginError) { loginError.style.display = 'none'; loginError.textContent = ''; }} }
    function showRegisterModal() { closeAuthModals(); if(registerModal) { registerModal.classList.add('visible'); if(registerUsername) registerUsername.focus(); if(registerError) { registerError.style.display = 'none'; registerError.textContent = ''; }} }
    function closeAuthModals() { if(loginModal) loginModal.classList.remove('visible'); if(registerModal) registerModal.classList.remove('visible'); }

    // --- Backend API Call for Ban Status ---
    async function checkUserBanStatus(username) {
        if (!username || !isLoggedIn) {
            if (isClientSideBanned) { isClientSideBanned = false; localStorage.removeItem(LS_IS_BANNED); updateLoginUI(); console.log("[DEBUG] Cleared stale ban flag as user is not logged in."); }
            return { isBanned: false, checked: false };
        }
        try {
            const response = await fetch(`${BACKEND_URL}/check-ban-status`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: username }) });
            const data = await response.json();
            if (response.ok && data.success) { return { isBanned: data.isBanned, isPermanentlyBanned: data.isPermanentlyBanned, banExpires: data.banExpires, checked: true }; }
            else { console.error(`[DEBUG] Failed backend check for ban status: ${data.message || response.statusText}`); return { isBanned: isClientSideBanned, checked: false }; }
        } catch (error) { console.error("[DEBUG] Network error checking ban status:", error); return { isBanned: isClientSideBanned, checked: false }; }
    }

    // --- Periodic Ban Check Logic ---
    async function checkBanStatusPeriodically() {
        if (!isLoggedIn || !loggedInUsername) { console.log("[DEBUG] Ban check skipped: User not logged in (client-side)."); stopBanStatusPolling(); if (isClientSideBanned) { isClientSideBanned = false; localStorage.removeItem(LS_IS_BANNED); updateLoginUI(); } return; }
        // console.log(`[DEBUG] Performing periodic ban check for: ${loggedInUsername}`); // Noisy
        const banStatus = await checkUserBanStatus(loggedInUsername);
        if (banStatus.checked) {
             const currentlyBanned = banStatus.isBanned;
             if (currentlyBanned !== isClientSideBanned) {
                 console.log(`[DEBUG] Ban status changed for ${loggedInUsername}. New status: ${currentlyBanned}`);
                 isClientSideBanned = currentlyBanned;
                 if (isClientSideBanned) { localStorage.setItem(LS_IS_BANNED, 'true'); }
                 else { localStorage.removeItem(LS_IS_BANNED); }
                 updateLoginUI();
             }
        } else { console.warn("[DEBUG] Periodic ban check failed (network or server error). UI reflects last known status."); }
    }

    // --- Functions to Start/Stop Ban Polling ---
    function startBanStatusPolling() {
        stopBanStatusPolling();
        if (isLoggedIn && loggedInUsername) { console.log(`[DEBUG] Starting periodic ban check (every ${BAN_CHECK_INTERVAL / 1000}s) for ${loggedInUsername}`); checkBanStatusPeriodically(); banCheckIntervalId = setInterval(checkBanStatusPeriodically, BAN_CHECK_INTERVAL); }
        else { console.log("[DEBUG] Did not start ban polling (user not logged in)."); }
    }
    function stopBanStatusPolling() { if (banCheckIntervalId) { console.log("[DEBUG] Stopping periodic ban check."); clearInterval(banCheckIntervalId); banCheckIntervalId = null; } }

    // --- Handle Login/Register/Logout API ---
    async function handleLogin() {
        console.log("[DEBUG] handleLogin called");
        if (!loginUsername || !loginPassword || !submitLoginBtn || !loginError) return;
        const username = loginUsername.value.trim(); const password = loginPassword.value;
        if (!username || !password) { loginError.textContent = 'Username and password required.'; loginError.style.display = 'block'; return; }
        loginError.style.display = 'none';
        try {
            submitLoginBtn.disabled = true; submitLoginBtn.textContent = 'Logging in...';
            const response = await fetch(`${BACKEND_URL}/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
            const data = await response.json();
            if (response.ok && data.success) {
                console.log("[DEBUG] Login successful");
                isLoggedIn = true; loggedInUsername = data.username;
                localStorage.setItem(LS_LOGGED_IN_USER, loggedInUsername);
                localStorage.removeItem(LS_IS_BANNED);
                isClientSideBanned = false;
                startBanStatusPolling(); // Start polling (includes initial check)
                updateLoginUI();
                closeAuthModals();
                showSection('welcome');
                console.log(`Logged in as ${loggedInUsername}`);
            } else {
                console.log(`[DEBUG] Login failed. Status: ${response.status}, Message: ${data.message}`);
                if (response.status === 403 && (data.message?.toLowerCase().includes('banned'))) { localStorage.setItem(LS_IS_BANNED, 'true'); isClientSideBanned = true; console.warn(`[DEBUG] Login blocked for ${username} (Banned), setting client-side flag.`); }
                else { localStorage.removeItem(LS_IS_BANNED); isClientSideBanned = false; console.log("[DEBUG] Login failed for other reason, clearing client-side ban flag."); }
                loginError.textContent = data.message || 'Login failed.';
                loginError.style.display = 'block';
                stopBanStatusPolling();
                updateLoginUI();
            }
        } catch (error) {
            console.error("Login error:", error);
            loginError.textContent = 'Network error during login.';
            loginError.style.display = 'block';
            localStorage.removeItem(LS_IS_BANNED);
            isClientSideBanned = false;
            stopBanStatusPolling();
            updateLoginUI();
        }
        finally { if(submitLoginBtn) { submitLoginBtn.disabled = false; submitLoginBtn.textContent = 'Login'; }}
    }
    async function handleRegister() {
        console.log("[DEBUG] handleRegister called");
        if (!registerUsername || !registerPassword || !registerPasswordConfirm || !submitRegisterBtn || !registerError) return;
        const username = registerUsername.value.trim(); const password = registerPassword.value; const confirmPassword = registerPasswordConfirm.value;
        registerError.style.display = 'none';
        if (!username || !password || !confirmPassword) { registerError.textContent = 'All fields are required.'; registerError.style.display = 'block'; return; }
        if (password !== confirmPassword) { registerError.textContent = 'Passwords do not match.'; registerError.style.display = 'block'; return; }
        if (/\s/.test(username)) { registerError.textContent = 'Username cannot contain spaces.'; registerError.style.display = 'block'; return; }
        if (password.length < 6) { registerError.textContent = 'Password must be at least 6 characters.'; registerError.style.display = 'block'; return; }
        try {
            submitRegisterBtn.disabled = true; submitRegisterBtn.textContent = 'Registering...';
            const response = await fetch(`${BACKEND_URL}/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }) });
            const data = await response.json();
            if (response.ok && data.success) {
                 console.log("[DEBUG] Registration successful");
                isLoggedIn = true; loggedInUsername = data.username;
                localStorage.setItem(LS_LOGGED_IN_USER, loggedInUsername);
                localStorage.removeItem(LS_IS_BANNED);
                isClientSideBanned = false;
                startBanStatusPolling(); // Start polling (includes initial check)
                updateLoginUI();
                closeAuthModals();
                showSection('welcome');
                console.log(`Registered and logged in as ${loggedInUsername}`);
            } else {
                console.log(`[DEBUG] Registration failed. Status: ${response.status}, Message: ${data.message}`);
                registerError.textContent = data.message || 'Registration failed.';
                registerError.style.display = 'block';
                stopBanStatusPolling();
                updateLoginUI();
            }
        } catch (error) {
            console.error("Registration error:", error);
            registerError.textContent = 'Network error during registration.';
            registerError.style.display = 'block';
            stopBanStatusPolling();
            updateLoginUI();
        }
        finally { if(submitRegisterBtn) { submitRegisterBtn.disabled = false; submitRegisterBtn.textContent = 'Register'; }}
    }
    function handleLogout() {
        console.log("[DEBUG] handleLogout called");
        stopBanStatusPolling(); // Stop ban polling
        isLoggedIn = false; loggedInUsername = null;
        localStorage.removeItem(LS_LOGGED_IN_USER);
        localStorage.removeItem(LS_IS_BANNED);
        isClientSideBanned = false;
        updateLoginUI();
        stopChatPolling();
        stopUserCountPolling();
        showSection('welcome');
        console.log("Logged out.");
    }

    // --- Welcome Area ---
    function displayWelcomeMessage(name) {
        console.log("[DEBUG] Displaying welcome message for:", name);
        if (!mainContent) return;
        mainContent.innerHTML = ''; // Clear previous content
        const welcomeArea = document.createElement('div'); welcomeArea.id = 'welcome-area';
        const logoContainer = document.createElement('div'); logoContainer.id = 'welcome-logo-container'; logoContainer.innerHTML = getLogoSvg(currentThemeColor);
        const messageHeading = document.createElement('h1'); messageHeading.id = 'welcome-message'; messageHeading.textContent = `Welcome, ${name.replace(/</g, "&lt;").replace(/>/g, "&gt;")}!`;
        const userCountP = document.createElement('p'); userCountP.id = 'user-count-display'; userCountP.textContent = 'Users online: Loading...';
        const changelogDiv = document.createElement('div'); changelogDiv.id = 'changelog-section';
        changelogDiv.innerHTML = `<h2>Changelog</h2><div class="changelog-version"><h4>v0.41 (Current)</h4><ul><li>Added immediate ban check when opening Settings panel or Chat view.</li><li>Refined logic for setting/reverting chat input placeholder during cooldowns/state changes.</li><li>Ensured initial UI state accurately reflects stored ban status on load after awaiting check.</li></ul></div><div class="changelog-version"><h4>v0.40</h4><ul><li>Added periodic (5s) ban status check for logged-in users.</li><li>Logout button hiding made more robust on initial load/login.</li><li>"Chat Restricted" placeholder stabilized to prevent flashing.</li></ul></div><div class="changelog-version"><h4>v0.39</h4><ul><li>Backend endpoint added to check user ban status directly.</li><li>Frontend updated to use ban check endpoint.</li></ul></div><div class="changelog-version"><h4>v0.38</h4><ul><li>Fixed client-side ban flag logic.</li></ul></div><div class="changelog-version"><h4>v0.37</h4><ul><li>Backend: Permanent bans, fuzzy blacklist, ASCII-only msg, sys msg dedupe.</li><li>Frontend: Removed Clear Data, Logout hidden if banned (cosmetic).</li></ul></div><div class="changelog-version"><h4>v0.36</h4><ul><li>Login persistence (LocalStorage).</li><li>MOD/OWNER tags & colors.</li><li>System messages in main chat.</li><li>Mod panel updates (roles, unban/untimeout, reasons).</li></ul></div><div class="changelog-version"><h4>v0.35</h4><ul><li>User Accounts (Register/Login).</li><li>Removed chat key.</li><li>Server blacklist & cooldown.</li><li>Chat scroll-to-load.</li></ul></div>`;
        welcomeArea.appendChild(logoContainer); welcomeArea.appendChild(messageHeading); welcomeArea.appendChild(userCountP); welcomeArea.appendChild(changelogDiv);
        mainContent.appendChild(welcomeArea);
        mainContent.style.opacity = 1; // Trigger fade-in
        startUserCountPolling();
    }
    function updateWelcomeLogoColor(color) { const wa=document.getElementById('welcome-area'); if(!wa) return; const lse=wa.querySelector('#welcome-logo-container svg'); if(lse){ const sc=color||'#444444'; lse.setAttribute('fill', sc); lse.querySelectorAll('rect').forEach(r=>r.setAttribute('fill', sc)); } }

    // --- Game & Category Management ---
    function loadGames() { const dg=[{id:crypto.randomUUID(),name:"N-GON",url:"https://landgreen.github.io/n-gon/index.html",category:"Strategy"},{id:crypto.randomUUID(),name:"Dead Shot",url:"https://deadshot.io/",category:"Action"},{id:crypto.randomUUID(),name:"Tik-Tok",url:"https://cars.happyforever.com/&?q=TikTok",category:"Media"},{id:crypto.randomUUID(),name:"VS-Code",url:"https://cars.happyforever.com/&?q=VS%20Code",category:"Coding"},{id:crypto.randomUUID(),name:"ChatGPT",url:"https://cars.happyforever.com/&?q=ChatGPT",category:"Conversation"},{id:crypto.randomUUID(),name:"Netquel",url:"https://netquel.com/",category:"Strategy"},{id:crypto.randomUUID(),name:"MK48",url:"https://mk48.io/",category:"Strategy"},{id:crypto.randomUUID(),name:"Ships 3D",url:"https://yp3d.com/ships3d/",category:"Action"},{id:crypto.randomUUID(),name:"Geometry Dash",url:"https://geometrylite.github.io",category:"Action"},{id:crypto.randomUUID(),name:"Five Nights At Freddy's",url:"https://wellsousaaa.github.io/Five-Nights-at-Freddys-Web/",category:"Horror"},{id:crypto.randomUUID(),name:"Five Nights At Freddy's Two",url:"https://ruihq.github.io/FNAF2/",category:"Horror"},{id:crypto.randomUUID(),name:"Five Nights At Freddy's Three",url:"https://sussygamedeveloper.github.io/fnaf3/",category:"Horror"}]; try { if(!localStorage.getItem(LS_INITIALIZED)){ console.log("[DEBUG] First run. Loading default games."); games=dg; saveGames(); localStorage.setItem(LS_INITIALIZED,'true'); } else { const sg=localStorage.getItem(LS_GAMES); try { games=sg?JSON.parse(sg):[]; } catch(pe){ console.error("Error parsing stored games:", pe); games=[]; } } } catch(e){ console.error("Error loading games:",e); games=dg; } }
    function saveGames() { try { saveSetting(LS_GAMES, JSON.stringify(games)); } catch (e) { console.error("Failed to save games:", e); } }
    function loadCategories() { const dc=['Action','Puzzle','Strategy','Simulation','Misc','Horror','Media','Coding','Conversation']; try { const sc=localStorage.getItem(LS_CATEGORIES); categories=sc?JSON.parse(sc):dc; } catch (e){ console.error("Failed load categories:",e); categories=dc; } dc.forEach(c=>{if(!categories.includes(c))categories.push(c);}); categories.sort(); }
    function saveCategories() { try { saveSetting(LS_CATEGORIES, JSON.stringify(categories)); } catch (e) { console.error("Failed save categories:", e); } }
    function populateCategorySelect(se, sc="") { if (!se) return; se.innerHTML='<option value="">Uncategorized</option>'; categories.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;if(c===sc)o.selected=true;se.appendChild(o);}); }
    function handleAddCategory() { const cs=document.getElementById('gameCategorySelect'); if(!cs)return; const nc=prompt("Enter new category name:"); if(nc && nc.trim()){const tc=nc.trim(); if(!categories.includes(tc)){categories.push(tc);categories.sort();saveCategories();populateCategorySelect(cs,tc);} else {alert("Category exists!");cs.value=tc;}} }
    function renderGames() { const container=mainContent?mainContent.querySelector('.game-list-container'):null; if(!container)return; container.innerHTML=''; let ngfp=mainContent.querySelector('#no-games-found'); if(!ngfp && games.length === 0){container.innerHTML='<p id="no-games-found" style="grid-column:1/-1;text-align:center;opacity:0.7;color:var(--text);">No games added yet.</p>'; ngfp=mainContent.querySelector('#no-games-found');} else if(ngfp){ngfp.style.display='none';} if(games.length > 0){games.forEach((g, index)=>{const card=document.createElement('div'); card.className='game-card'; card.dataset.id=g.id; card.setAttribute('tabindex','0'); card.style.animationDelay = `${0.05 * (index + 1)}s`; card.innerHTML=`<div class="game-card-header"><img class="game-favicon" alt="" width="16" height="16" loading="lazy"><h4></h4></div><p class="category"></p><div class="game-card-actions"><button class="play-btn" title="Play Game">${ICONS.play}</button><button class="edit-btn" title="Edit Game">${ICONS.edit}</button><button class="delete-btn" title="Delete Game">${ICONS.delete}</button></div>`; const ne=card.querySelector('h4'); const ce=card.querySelector('p.category'); const fe=card.querySelector('.game-favicon'); ne.textContent=g.name.replace(/</g,"&lt;"); ce.textContent=g.category||'Uncategorized'; if(fe){fe.alt=`${g.name} Favicon`; if(g.url && (g.url.startsWith('http://')||g.url.startsWith('https://'))){try{const gu=new URL(g.url);const hn=gu.hostname;const fsu=`https://www.google.com/s2/favicons?domain=${hn}&sz=32`;fe.src=fsu;fe.onerror=()=>{fe.style.display='none';}; fe.style.display='inline-block';}catch(e){fe.style.display='none';}}else{fe.style.display='none';}} card.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();playGame(g.url,g.name);}});card.querySelector('.play-btn').onclick=(e)=>{e.stopPropagation();playGame(g.url,g.name);};card.querySelector('.edit-btn').onclick=(e)=>{e.stopPropagation();openGameModal(g);};card.querySelector('.delete-btn').onclick=(e)=>{e.stopPropagation();deleteGame(g.id,card);};container.appendChild(card);});} filterGames();}
    function openGameModal(gte=null) { const m=document.getElementById('gameModal');const t=document.getElementById('gameModalTitle');const ii=document.getElementById('gameIdInput');const ni=document.getElementById('gameNameInput');const ui=document.getElementById('gameUrlInput');const cs=document.getElementById('gameCategorySelect');const sb=document.getElementById('saveGameBtn'); if(!m||!t||!ii||!ni||!ui||!cs||!sb)return; isEditingGame=!!gte;ii.value='';ni.value='';ui.value='';ni.style.borderColor='';ui.style.borderColor='';populateCategorySelect(cs,gte?gte.category:"");if(isEditingGame){t.textContent='Edit Game';ii.value=gte.id;ni.value=gte.name;ui.value=gte.url;sb.textContent='Save Changes';}else{t.textContent='Add New Game';sb.textContent='Add Game';} m.classList.add('visible');ni.focus();}
    function closeGameModal() { const m=document.getElementById('gameModal'); if(m)m.classList.remove('visible'); isEditingGame=false; }
    function handleSaveGame() { const ni=document.getElementById('gameNameInput');const ui=document.getElementById('gameUrlInput');const cs=document.getElementById('gameCategorySelect');const ii=document.getElementById('gameIdInput'); if(!ni||!ui||!cs||!ii)return; const name=ni.value.trim(); const url=ui.value.trim(); const category=cs.value; const id=ii.value; let iv=true; if(!name){ni.style.borderColor='red';iv=false;}else{ni.style.borderColor='';} if(!url||!url.match(/^(https?:\/\/|.\/|..\/|\/)/)){ui.style.borderColor='red';iv=false;alert("Valid URL needed (http://, https://, /, ./, ../)");}else{ui.style.borderColor='';} if(!iv)return; if(isEditingGame&&id){const gi=games.findIndex(g=>g.id===id); if(gi>-1){games[gi]={...games[gi],name,url,category};}else{console.error("Edit fail: ID not found");closeGameModal();return;}}else{const ng={id:crypto.randomUUID(),name,url,category};games.push(ng);} saveGames();renderGames();closeGameModal();}
    function deleteGame(id, ce) { if (!confirm(`Delete this game?`)) return; if (ce) { ce.classList.add('deleting'); ce.addEventListener('animationend', () => { games = games.filter(g => g.id !== id); saveGames(); renderGames(); }, { once: true }); } else { games = games.filter(g => g.id !== id); saveGames(); renderGames(); } }
    function playGame (url, title = 'Content') { openInAboutBlank(url, title); }
    function openInAboutBlank(url, title = 'Content') { if (!url || !url.match(/^(https?:\/\/|.\/|..\/|\/)/)) { console.error("Invalid URL provided:", url); alert("Cannot open link: Invalid URL provided."); return; } const newWindow = window.open('', '_blank'); if (newWindow) { try { newWindow.document.open(); newWindow.document.write(` <!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>${title.replace(/</g, "&lt;")}</title> <style>html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#000;}iframe{display:block;width:100%;height:100%;border:none;}</style> </head> <body> <iframe src="${url}" frameborder="0" allowfullscreen sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-top-navigation-by-user-activation"></iframe> <script> const shouldWarnOnClose = ${warnOnClose}; window.addEventListener('beforeunload', (event) => { if (shouldWarnOnClose) { const confirmationMessage = 'Closing this window might interrupt your game/session. Are you sure?'; event.preventDefault(); event.returnValue = confirmationMessage; return confirmationMessage; } }); <\/script> </body> </html> `); newWindow.document.close(); } catch (e) { console.error("Error writing to new window:", e); try { newWindow.location.href = url; } catch (e2) { console.error("Error navigating new window:", e2); alert("Could not open link. Check pop-up blocker."); newWindow.close(); } } } else { alert("Could not open link. Please check pop-up blocker."); } }

    // --- UI Section Management ---
    function showSection(section) {
        if (!mainContent || !chatPanel) return;
        if (isWelcomeAreaVisible()) { stopUserCountPolling(); }
        if (isChatViewActive) { stopChatPolling(); chatPanel.style.display = 'none'; isChatViewActive = false; }

        const protectedSections = ['games', 'proxy', 'tools'];
        if (protectedSections.includes(section) && !isLoggedIn) {
            console.log(`Section '${section}' requires login.`);
            showLoginModal();
            return;
        }

        mainContent.style.display = 'block'; mainContent.style.opacity = 0;
        setTimeout(() => {
            mainContent.innerHTML = ''; mainContent.style.animation = 'none';
            let sectionContent = '';
            if (section === "welcome") { displayWelcomeMessage(isLoggedIn ? loggedInUsername : "Guest"); }
            else if (section === "games") { sectionContent = `<div id="games-section-header"><h2>My Games</h2><button id="addGameBtn">+ Add Game</button></div><div class="game-list-container"></div>`; mainContent.innerHTML = sectionContent; const addBtn = document.getElementById('addGameBtn'); if (addBtn) addBtn.onclick = () => openGameModal(); renderGames(); stopUserCountPolling(); }
            else if (section === "proxy") { sectionContent = `<h2>Proxy Sites</h2><div class="proxy-list-container"></div>`; mainContent.innerHTML = sectionContent; renderProxySites(); stopUserCountPolling(); }
            else if (section === "tools") { sectionContent = `<h2>Tools</h2><p>Useful links, calculators, etc.</p>`; mainContent.innerHTML = sectionContent; stopUserCountPolling(); }
            else { if (welcomeAreaPlaceholder) { mainContent.appendChild(welcomeAreaPlaceholder); welcomeAreaPlaceholder.style.display = 'flex'; } displayWelcomeMessage(isLoggedIn ? loggedInUsername : "Guest"); }
            if (mainContent.innerHTML) { requestAnimationFrame(() => { mainContent.style.opacity = 0; mainContent.style.animation = "fadeIn 0.5s forwards"; mainContent.style.opacity = 1; }); } else { mainContent.style.opacity = 1; }
        }, 50); // Short delay for smoother transition
    }
    function renderProxySites() { const c = mainContent ? mainContent.querySelector('.proxy-list-container') : null; if (!c) return; c.innerHTML = ''; const spaceUrls = [ "https://yessir.happyforever.com/", "https://fish.happyforever.com/", "https://turtle.happyforever.com/", "https://cars.happyforever.com/" ]; const ps = [ { name: "Space", url: null }, { name: "Transend", url: "https://hw.billigerhost.com/" }, { name: "RammerHead", url: "https://pluh.root.sx/" }, { name: "Utopia", url: "https://bio.write.examinedbytopmen.com/" } ]; ps.forEach((s, index) => { const card = document.createElement('div'); card.className = 'proxy-card'; card.setAttribute('tabindex', '0'); card.style.animationDelay = `${0.05 * (index + 1)}s`; card.innerHTML = ` <div><h4></h4></div> <div class="proxy-card-actions"> <button class="play-btn" title="Open ${s.name.replace(/</g, "&lt;")}">${ICONS.play}</button> </div> `; card.querySelector('h4').textContent = s.name.replace(/</g, "&lt;"); const handleOpen = () => { const urlToOpen = s.name === "Space" ? spaceUrls[Math.floor(Math.random() * spaceUrls.length)] : s.url; openInAboutBlank(urlToOpen, s.name); }; card.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); handleOpen(); } }); card.querySelector('.play-btn').onclick = (e) => { e.stopPropagation(); handleOpen(); }; c.appendChild(card); }); }

    // --- Settings Panel & Controls ---
    async function handleSettingsButtonClick() { // Renamed from toggleSettings, now async
        if (!settingsBtn || !settingsPanel || !isLoggedIn) {
             if (!isLoggedIn) showLoginModal(); // Prompt login if trying to open settings while logged out
            return;
        }

        // If panel is already open, just close it without checks
        if (settingsPanel.classList.contains('show')) {
             settingsPanel.classList.remove('show');
             startBanStatusPolling(); // Restart background polling when closed
             console.log("[DEBUG] Settings panel closed, restarting ban polling.");
             return;
        }

        // Show loading/disabled state on button
        settingsBtn.disabled = true;
        settingsBtn.style.opacity = '0.7'; // Visual cue
        settingsBtn.style.cursor = 'wait';
        console.log("[DEBUG] Settings button clicked, checking ban status before opening...");

        const banStatus = await checkUserBanStatus(loggedInUsername); // Check status NOW
        isClientSideBanned = banStatus.isBanned; // Update global flag

        // Update localStorage based on check
        if (isClientSideBanned) {
            localStorage.setItem(LS_IS_BANNED, 'true');
        } else {
            localStorage.removeItem(LS_IS_BANNED);
        }

        updateLoginUI(); // Ensure UI (like logout button visibility) is correct based on the check

        if (isClientSideBanned) {
            console.warn("[DEBUG] Settings cannot be opened: User is banned.");
            // Optional: Show a brief message to the user
            // alert("Settings unavailable: Account restricted.");
        } else {
            console.log("[DEBUG] Ban check passed. Opening settings panel and stopping background polling.");
            stopBanStatusPolling(); // ---> Stop background polling while panel is open <---
            settingsPanel.classList.add('show'); // Show panel only if not banned
        }

        // Reset button state
        settingsBtn.disabled = false;
        settingsBtn.style.opacity = '1';
        settingsBtn.style.cursor = 'pointer';
    }
    function updateSliderVisuals(s,t,p,d) { if(!s||!t||!p||!d)return; try{const min=parseFloat(s.min)||12; const max=parseFloat(s.max)||24; const v=parseFloat(s.value)||16; let pct=((v-min)/(max-min))*100; pct=Math.max(0,Math.min(100,pct)); t.style.left=`${pct}%`; t.style.transform='translateX(-50%)'; p.style.width=`${pct}%`; d.textContent=`${Math.round(v)}px`;}catch(e){console.error("Slider update err:",e);} }
    function updateFontSize(v) { const s=document.getElementById('fontSizeSlider');const t=document.getElementById('fontSizeThumb');const p=document.getElementById('fontSizeProgress');const d=document.getElementById('fontSizeValue'); if(!s||!root)return; const val=v||s.value; root.style.setProperty("--font-size",`${val}px`); saveSetting(LS_FONTSIZE,val); updateSliderVisuals(s,t,p,d); }
    function updateFontFamily(fn) { const s=document.getElementById('fontSelector'); if(!s||!root)return; const v=fn||s.value; root.style.setProperty("--font-family",v); saveSetting(LS_FONTFAMILY,v); }
    function applyCustomBackground() { if(!root||!bgImageControlContainer||!bgImageToggleSwitch)return; if(bgImageEnabled){bgImageControlContainer.style.display='flex';}else{bgImageControlContainer.style.display='none';} if(bgImageEnabled&&bgImageUrl&&bgImageUrl.startsWith('data:image/')){root.style.setProperty('--custom-bg-image',`url("${bgImageUrl}")`);}else{root.style.setProperty('--custom-bg-image','none');} bgImageToggleSwitch.checked=bgImageEnabled; }
    function handleImageFileSelect(e) { if(!e.target.files||e.target.files.length===0)return; const f=e.target.files[0]; if(!f.type.startsWith('image/')){alert("Select image file.");e.target.value=null;return;} if(f.size>MAX_IMAGE_SIZE_BYTES){alert(`Image too large (${(f.size/1024/1024).toFixed(1)}MB). Max ${MAX_IMAGE_SIZE_MB}MB.`);e.target.value=null;return;} const r=new FileReader(); r.onload=(le)=>{bgImageUrl=le.target.result;saveSetting(LS_BGIMAGE_URL,bgImageUrl);applyCustomBackground();console.log("BG saved.");}; r.onerror=(ee)=>{console.error("FileRead err:",ee);alert("Error reading file.");e.target.value=null;}; r.onabort=()=>{console.warn("FileRead abort.");e.target.value=null;}; r.readAsDataURL(f); }
    function clearCustomBackground() { bgImageUrl=''; removeSetting(LS_BGIMAGE_URL); if(bgImageFileInput)bgImageFileInput.value=null; applyCustomBackground(); }
    function updateTheme(theme) { const selector=document.getElementById('themeSelector'); if(!root||!body) return; const value=theme||(selector?selector.value:'dark'); let accentColor='#444444'; let textColorValue='#ffffff'; switch(value){ case "light": root.style.setProperty("--bg","#ffffff"); root.style.setProperty("--sidebar","#eeeeee"); root.style.setProperty("--topbar","#dddddd"); root.style.setProperty("--accent","#cccccc"); root.style.setProperty("--text","#1a1a1a"); accentColor='#cccccc'; textColorValue='#1a1a1a'; break; case "blue": root.style.setProperty("--bg","#0a0f1c"); root.style.setProperty("--sidebar","#091121"); root.style.setProperty("--topbar","#101a35"); root.style.setProperty("--accent","#395b9c"); root.style.setProperty("--text","#e0e0ff"); accentColor='#395b9c'; textColorValue='#e0e0ff'; break; case "forest": root.style.setProperty("--bg","#1f2e1f"); root.style.setProperty("--sidebar","#141e14"); root.style.setProperty("--topbar","#2a3f2a"); root.style.setProperty("--accent","#4a784a"); root.style.setProperty("--text","#e5f5e5"); accentColor='#4a784a'; textColorValue='#e5f5e5'; break; case "sunset": root.style.setProperty("--bg","#2b1a1a"); root.style.setProperty("--sidebar","#3a2525"); root.style.setProperty("--topbar","#4d3333"); root.style.setProperty("--accent","#b36b4a"); root.style.setProperty("--text","#ffe8e0"); accentColor='#b36b4a'; textColorValue='#ffe8e0'; break; case "trigonometrical-red": root.style.setProperty("--bg", "#ffffff"); root.style.setProperty("--sidebar", "#a02020"); root.style.setProperty("--topbar", "#b03030"); root.style.setProperty("--accent", "#e53e3e"); root.style.setProperty("--text", "#1a1a1a"); accentColor='#e53e3e'; textColorValue='#1a1a1a'; break; case "dark": default: root.style.setProperty("--bg","#1e1e1e"); root.style.setProperty("--sidebar","#111111"); root.style.setProperty("--topbar","#2c2c2c"); root.style.setProperty("--accent","#444444"); root.style.setProperty("--text","#ffffff"); accentColor='#444444'; textColorValue='#ffffff'; break; } currentThemeColor=accentColor; body.setAttribute('data-theme', value); updateSelectArrowColor(textColorValue); if(root.style && typeof root.style.setProperty==='function'){ const ca=getComputedStyle(root).getPropertyValue('--accent').trim(); const ct=getComputedStyle(root).getPropertyValue('--text').trim(); const ctb=getComputedStyle(root).getPropertyValue('--topbar').trim(); root.style.setProperty('--slider-track-bg', ca); root.style.setProperty('--slider-thumb-bg', ct); root.style.setProperty('--slider-progress-color', ct); root.style.setProperty('--game-card-bg', ctb); root.style.setProperty('--game-card-hover-bg', ca); } updateFavicon(accentColor); updateWelcomeLogoColor(accentColor); saveSetting(LS_THEME, value); applyCustomBackground(); }

    // --- Search & Filtering ---
    function filterGames() { const s_in=document.getElementById('search'); const mc=document.getElementById('main-content'); if(!s_in||!mc) return; const st=s_in.value.toLowerCase().trim(); const glc=mc.querySelector('.game-list-container'); let ngfm=mc.querySelector('#no-games-found'); let vgc=0; if(glc){ const gcs=glc.querySelectorAll('.game-card'); if(gcs.length>0){gcs.forEach(c=>{const ne=c.querySelector('h4');const ce=c.querySelector('p.category');const n=ne?ne.textContent.toLowerCase():'';const cat=ce?ce.textContent.toLowerCase():'';if(!st||n.includes(st)||cat.includes(st)){c.style.display='';vgc++;}else{c.style.display='none';}});}else{vgc=0;}} if(!ngfm && glc && games.length===0 && !st){ const me=document.createElement('p');me.id='no-games-found';me.style.cssText="grid-column:1/-1;text-align:center;opacity:0.7;padding:20px;color:var(--text);";me.textContent="No games added yet.";glc.appendChild(me);ngfm=me;}else if(ngfm){ const tg=games.length; if(vgc===0 && tg>0 && st){ngfm.textContent=`No games found matching "${s_in.value.trim()}"`;ngfm.style.display='block';}else if(vgc===0 && tg===0){ngfm.textContent=`No games added yet.`;ngfm.style.display='block';}else{ngfm.style.display='none';}} const plc=mc.querySelector('.proxy-list-container'); if(plc&&st){const pcs=plc.querySelectorAll('.proxy-card');pcs.forEach(c=>{const ne=c.querySelector('h4');const n=ne?ne.textContent.toLowerCase():'';if(n.includes(st)){c.style.display='';}else{c.style.display='none';}});}else if(plc){const pcs=plc.querySelectorAll('.proxy-card');pcs.forEach(c=>c.style.display='');} }
    const debouncedFilterGames = debounce(filterGames, 300);

    // --- Warn on Close Logic ---
    function handleMainBeforeUnload(e) { if(warnOnClose){const cm='Close Qbit? Changes might be lost.';e.preventDefault();e.returnValue=cm;return cm;} }

    // --- Chat View Toggle (MODIFIED for immediate check) ---
    function toggleChatView() {
        if (!mainContent || !chatPanel) return;
        if (!isLoggedIn) { showLoginModal(); return; } // Require login

        if (isChatViewActive) { // Hide Chat
            chatPanel.style.display = 'none';
            mainContent.style.display = 'block';
            isChatViewActive = false;
            stopChatPolling();
        } else { // Show Chat
            if (isWelcomeAreaVisible()) stopUserCountPolling();
            mainContent.style.display = 'none';
            chatPanel.style.display = 'flex';
            isChatViewActive = true;

            updateLoginUI(); // Update UI first

            fetchInitialMessages();
            startChatPolling(); // Start message polling

            // ---> Run immediate ban check when opening chat <---
            console.log("[DEBUG] Chat view opened, running immediate ban check.");
            checkBanStatusPeriodically(); // Update ban status and potentially UI again

            if(chatMessageInput) chatMessageInput.focus();
        }
    }

    // --- Send Message Function ---
    async function sendMessage() {
        console.log(`[DEBUG] sendMessage called. isLoggedIn: ${isLoggedIn}, isClientSideBanned: ${isClientSideBanned}`);
        if (!isLoggedIn || !loggedInUsername) { alert("Please login to send messages."); showLoginModal(); return; }
        if (isClientSideBanned) { alert("Cannot send message (Account Restricted)"); console.warn("[DEBUG] sendMessage blocked by client-side ban flag."); return; }
        if (isSendingMessage) return;
        const messageText = chatMessageInput.value.trim();
        if (!messageText) return;
        const now = Date.now();
        if (now - lastSentTimestamp < MESSAGE_COOLDOWN_MS) { const waitSec = Math.ceil((MESSAGE_COOLDOWN_MS - (now - lastSentTimestamp)) / 1000); setTempPlaceholder(`Wait ${waitSec}s...`); console.log("Client cooldown active."); return; }
        const messageData = { message: messageText, siteUsername: loggedInUsername };
        setSendingState(true);
        try {
            const response = await fetch(`${BACKEND_URL}/send-message`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(messageData) });
            const data = await response.json();
            if (response.ok && data.success) {
                console.log("[DEBUG] sendMessage successful.");
                lastSentTimestamp = Date.now();
                fetchNewMessages(); // Fetch new messages which might include our own
                if (isClientSideBanned) { console.log("[DEBUG] Message succeeded, clearing client-side ban flag."); localStorage.removeItem(LS_IS_BANNED); isClientSideBanned = false; updateLoginUI(); }
            } else {
                console.error(`[DEBUG] Failed to send message. Status: ${response.status}, Message: ${data.message}`);
                alert(`Failed: ${data.message || 'Unknown error'}`);
                chatMessageInput.value = messageText; // Keep message on failure
                if (response.status === 403 && (data.message?.toLowerCase().includes('banned') || data.message?.toLowerCase().includes('timed out'))) { console.warn("[DEBUG] Send message failed due to ban/timeout. Setting client-side flag."); localStorage.setItem(LS_IS_BANNED, 'true'); isClientSideBanned = true; updateLoginUI(); }
                else { if (isClientSideBanned) { console.log("[DEBUG] Send message failed for other reason, clearing client-side ban flag."); localStorage.removeItem(LS_IS_BANNED); isClientSideBanned = false; updateLoginUI(); } }
                if (response.status === 429) { lastSentTimestamp = Date.now(); const waitSec = Math.ceil(MESSAGE_COOLDOWN_MS / 1000); setTempPlaceholder(`Wait ${waitSec}s...`); }
            }
        } catch (error) {
            console.error("Error sending message:", error);
            alert("Network error sending message.");
            chatMessageInput.value = messageText;
            if (isClientSideBanned) { console.log("[DEBUG] Network error during send, clearing client-side ban flag."); localStorage.removeItem(LS_IS_BANNED); isClientSideBanned = false; updateLoginUI(); }
        } finally {
            setSendingState(false); // Ensure state is reset and placeholder updated
        }
    }
    // --- Chat Helpers (setSendingState, setTempPlaceholder - Modified for stability) ---
    function setSendingState(isSending) {
        isSendingMessage = isSending;
        const isDisabled = isSending || !isLoggedIn || isClientSideBanned; // Calculate disabled state based on current flags

        if (chatMessageInput) chatMessageInput.disabled = isDisabled;
        if (sendMessageBtn) sendMessageBtn.disabled = isDisabled;

        if (!isSending && chatMessageInput) { // When message send finishes or state is reset
            chatMessageInput.value = ''; // Clear input

            // ---> STABILIZED PLACEHOLDER: Re-evaluate placeholder based on current state <---
            if (isClientSideBanned) {
                chatMessageInput.placeholder = 'Chat disabled (Account Restricted)';
            } else if (isLoggedIn) {
                chatMessageInput.placeholder = 'Enter message...';
                // Only focus if sending finished successfully and user is allowed to type
                if (!isDisabled) chatMessageInput.focus();
            } else {
                chatMessageInput.placeholder = 'Login to chat...';
            }
             // ---> End re-evaluation <---

        }
        // Note: The logic when isSending=true doesn't need placeholder changes as input is disabled
    }
    function setTempPlaceholder(text, duration = MESSAGE_COOLDOWN_MS) {
        if(!chatMessageInput) return;
        // ---> STABILIZED PLACEHOLDER: Determine correct default based on current state <---
        let originalPlaceholder;
        if (isClientSideBanned) {
            originalPlaceholder = 'Chat disabled (Account Restricted)';
        } else if (isLoggedIn) {
            originalPlaceholder = 'Enter message...';
        } else {
            originalPlaceholder = 'Login to chat...';
        }
        // ---> End determination <---

        chatMessageInput.placeholder = text; // Set temporary text
        setTimeout(() => {
            // Only revert if the placeholder is still the temporary text AND the input is enabled
            // (Prevents overriding "Chat disabled..." if a ban happened during the cooldown)
            if(chatMessageInput && chatMessageInput.placeholder === text && !chatMessageInput.disabled) {
                 // Re-check the correct placeholder *again* before reverting, in case state changed
                if (isClientSideBanned) {
                    chatMessageInput.placeholder = 'Chat disabled (Account Restricted)';
                } else if (isLoggedIn) {
                    chatMessageInput.placeholder = 'Enter message...';
                } else {
                    chatMessageInput.placeholder = 'Login to chat...';
                }
            } else if (chatMessageInput && chatMessageInput.placeholder === text && chatMessageInput.disabled && isClientSideBanned) {
                // If input became disabled due to a ban while showing temp text, force the restricted placeholder
                 chatMessageInput.placeholder = 'Chat disabled (Account Restricted)';
            }
        }, duration);
    }

    // --- Append/Prepend Message - Handles Roles ---
    function appendMessageToLog(sender, message, timestamp, role = 'user') {
        if (!chatLogContainer) return;
        const lastMessageGroup = chatLogContainer.lastElementChild; let isNewGroup = true; const MAX_GROUP_TIME_MINUTES = 5;
        let lastRealMessageGroup = lastMessageGroup; while (lastRealMessageGroup && !lastRealMessageGroup.classList.contains('chat-message-group')) { lastRealMessageGroup = lastRealMessageGroup.previousElementSibling; }
        if (lastRealMessageGroup && lastRealMessageGroup.dataset.sender === sender && sender !== 'System' && sender !== '[MOD]') { const lastTimestamp = parseInt(lastRealMessageGroup.dataset.latestTimestamp || '0'); const timeDiffMinutes = (timestamp - lastTimestamp) / (1000 * 60); if (!isNaN(timeDiffMinutes) && timeDiffMinutes < MAX_GROUP_TIME_MINUTES) { isNewGroup = false; } }

        const safeSender = sender.replace(/</g, "&lt;"); const safeMessage = message.replace(/</g, "&lt;"); const messageDate = new Date(timestamp); const formattedTime = messageDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }); const formattedDateTime = messageDate.toLocaleString();

        if (sender === 'System') { appendSystemMessage(safeMessage, timestamp); return; }

        if (isNewGroup) {
            const messageGroupDiv = document.createElement('div'); messageGroupDiv.classList.add('chat-message-group'); messageGroupDiv.dataset.sender = sender; messageGroupDiv.dataset.timestamp = timestamp; messageGroupDiv.dataset.latestTimestamp = timestamp;
            const pfpContainer = document.createElement('div'); pfpContainer.classList.add('chat-pfp-container'); pfpContainer.innerHTML = generateUserPfpSvg(sender); messageGroupDiv.appendChild(pfpContainer);
            const messageContentDiv = document.createElement('div'); messageContentDiv.classList.add('chat-message-content');
            const messageHeaderDiv = document.createElement('div'); messageHeaderDiv.classList.add('chat-message-header');
            const usernameSpan = document.createElement('span'); usernameSpan.classList.add('chat-username'); usernameSpan.textContent = safeSender;
            let roleTag = '';
            if (role === 'mod' || sender === '[MOD]') { usernameSpan.classList.add('username-mod'); roleTag = '[MOD]'; }
            else if (role === 'owner') { usernameSpan.classList.add('username-owner'); roleTag = '[OWNER]'; }
            messageHeaderDiv.appendChild(usernameSpan);
            if (roleTag) { const roleTagSpan = document.createElement('span'); roleTagSpan.className = 'role-tag'; roleTagSpan.textContent = roleTag; messageHeaderDiv.appendChild(roleTagSpan); }
            const timestampSpan = document.createElement('span'); timestampSpan.classList.add('chat-timestamp'); timestampSpan.textContent = formattedTime; timestampSpan.title = formattedDateTime; messageHeaderDiv.appendChild(timestampSpan);
            messageContentDiv.appendChild(messageHeaderDiv);
            const messageP = document.createElement('p'); messageP.classList.add('chat-message-text'); messageP.textContent = safeMessage; messageContentDiv.appendChild(messageP);
            messageGroupDiv.appendChild(messageContentDiv); chatLogContainer.appendChild(messageGroupDiv);
        } else {
            const existingContentDiv = lastRealMessageGroup.querySelector('.chat-message-content');
            if (existingContentDiv) { const messageP = document.createElement('p'); messageP.classList.add('chat-message-text'); messageP.textContent = safeMessage; existingContentDiv.appendChild(messageP); lastRealMessageGroup.dataset.latestTimestamp = timestamp; }
            else { console.warn("Could not find content div in last group."); appendMessageToLog(sender, message, timestamp, role); } // Fallback
        }
        if (timestamp > lastMessageTimestamp) { lastMessageTimestamp = timestamp; }
    }
    function prependMessageToLog(sender, message, timestamp, role = 'user') {
        if (!chatLogContainer) return;
        const safeSender = sender.replace(/</g, "&lt;"); const safeMessage = message.replace(/</g, "&lt;"); const messageDate = new Date(timestamp); const formattedTime = messageDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }); const formattedDateTime = messageDate.toLocaleString();

         if (sender === 'System') {
             const systemDiv = document.createElement('p'); systemDiv.classList.add('chat-system-message'); systemDiv.textContent = safeMessage;
             const firstChild = chatLogContainer.firstChild; if (firstChild) chatLogContainer.insertBefore(systemDiv, firstChild); else chatLogContainer.appendChild(systemDiv);
             return;
         }

        const messageGroupDiv = document.createElement('div'); messageGroupDiv.classList.add('chat-message-group'); messageGroupDiv.dataset.sender = sender; messageGroupDiv.dataset.timestamp = timestamp; messageGroupDiv.dataset.latestTimestamp = timestamp;
        const pfpContainer = document.createElement('div'); pfpContainer.classList.add('chat-pfp-container'); pfpContainer.innerHTML = generateUserPfpSvg(sender); messageGroupDiv.appendChild(pfpContainer);
        const messageContentDiv = document.createElement('div'); messageContentDiv.classList.add('chat-message-content');
        const messageHeaderDiv = document.createElement('div'); messageHeaderDiv.classList.add('chat-message-header');
        const usernameSpan = document.createElement('span'); usernameSpan.classList.add('chat-username'); usernameSpan.textContent = safeSender;
        let roleTag = ''; if (role === 'mod' || sender === '[MOD]') { usernameSpan.classList.add('username-mod'); roleTag = '[MOD]'; } else if (role === 'owner') { usernameSpan.classList.add('username-owner'); roleTag = '[OWNER]'; }
        messageHeaderDiv.appendChild(usernameSpan); if (roleTag) { const roleTagSpan = document.createElement('span'); roleTagSpan.className = 'role-tag'; roleTagSpan.textContent = roleTag; messageHeaderDiv.appendChild(roleTagSpan); }
        const timestampSpan = document.createElement('span'); timestampSpan.classList.add('chat-timestamp'); timestampSpan.textContent = formattedTime; timestampSpan.title = formattedDateTime; messageHeaderDiv.appendChild(timestampSpan);
        messageContentDiv.appendChild(messageHeaderDiv); const messageP = document.createElement('p'); messageP.classList.add('chat-message-text'); messageP.textContent = safeMessage; messageContentDiv.appendChild(messageP);
        messageGroupDiv.appendChild(messageContentDiv);
        const indicator = chatLogContainer.querySelector('.chat-loading-indicator');
        if (indicator && indicator.nextSibling) { chatLogContainer.insertBefore(messageGroupDiv, indicator.nextSibling); }
        else if (indicator) { chatLogContainer.appendChild(messageGroupDiv); }
        else if (chatLogContainer.firstChild) { chatLogContainer.insertBefore(messageGroupDiv, chatLogContainer.firstChild); }
        else { chatLogContainer.appendChild(messageGroupDiv); }
    }
    function appendSystemMessage(message, timestamp = Date.now()) { if (!chatLogContainer) return; const messageDiv = document.createElement('p'); messageDiv.classList.add('chat-system-message'); messageDiv.textContent = message; messageDiv.dataset.timestamp = timestamp; chatLogContainer.appendChild(messageDiv); scrollToChatBottom(); }
    function scrollToChatBottom() { if (chatLogContainer) { setTimeout(() => { chatLogContainer.scrollTop = chatLogContainer.scrollHeight; }, 50); } }

    // --- Chat Polling & Loading ---
    async function fetchNewMessages() {
        if (!isChatViewActive || !isLoggedIn) return;
        // console.log("[DEBUG] Polling for new messages..."); // Noisy
        try {
            const response = await fetch(`${BACKEND_URL}/get-messages?after=${lastMessageTimestamp}`);
            if (!response.ok) {
                console.warn(`[DEBUG] Poll failed. Status: ${response.status}`);
                if (response.status === 401 || response.status === 403) {
                    let data = {}; try { data = await response.json(); } catch (e) { console.warn("[DEBUG] Poll error response was not JSON."); }
                    if (data.message?.toLowerCase().includes('banned') || data.message?.toLowerCase().includes('timed out')) { console.warn("[DEBUG] Polling failed due to ban/timeout. Setting client-side flag."); localStorage.setItem(LS_IS_BANNED, 'true'); isClientSideBanned = true; updateLoginUI(); }
                    else { console.warn(`[DEBUG] Poll failed with ${response.status} but message ("${data.message}") doesn't indicate ban/timeout.`); }
                } else { console.error(`[DEBUG] Error fetching new messages: ${response.statusText}`); }
                return;
            }
             if (isClientSideBanned) { console.log("[DEBUG] Poll succeeded, clearing client-side ban flag."); localStorage.removeItem(LS_IS_BANNED); isClientSideBanned = false; updateLoginUI(); }
            const messages = await response.json();
            if (messages && messages.length > 0) {
                let scrolled = false; messages.sort((a, b) => a.timestamp - b.timestamp);
                messages.forEach(msg => {
                    const exists = chatLogContainer.querySelector(`.chat-message-group[data-timestamp="${msg.timestamp}"], .chat-system-message[data-timestamp="${msg.timestamp}"]`);
                    if (!exists && msg.timestamp > lastMessageTimestamp) { appendMessageToLog(msg.sender, msg.text, msg.timestamp, msg.role); scrolled = true; }
                    else if (msg.timestamp > lastMessageTimestamp) { lastMessageTimestamp = msg.timestamp; }
                });
                if (scrolled) scrollToChatBottom();
            }
        } catch (error) {
            console.error("Error polling:", error);
             if (isClientSideBanned) { console.log("[DEBUG] Network error during poll, clearing client-side ban flag."); localStorage.removeItem(LS_IS_BANNED); isClientSideBanned = false; updateLoginUI(); }
        }
    }
    async function fetchInitialMessages() { if (!chatLogContainer) return; console.log("Fetching initial messages..."); chatLogContainer.innerHTML = ''; addChatLoadingIndicator(); noMoreOlderMessages = false; isLoadingOlderMessages = false; oldestMessageTimestamp = null; lastMessageTimestamp = 0; const welcomeName = loggedInUsername || 'Guest'; const welcomeHTML = `<p class="chat-system-message" data-timestamp="1">Welcome to the chat, <span id="chatActiveUserName">${welcomeName.replace(/</g, "&lt;")}</span>!</p>`; chatLogContainer.innerHTML = welcomeHTML; try { const response = await fetch(`${BACKEND_URL}/get-messages?limit=${CHAT_HISTORY_LOAD_LIMIT}`); if (!response.ok) throw new Error(`HTTP error: ${response.status}`); const messages = await response.json(); if (messages && messages.length > 0) { messages.sort((a, b) => a.timestamp - b.timestamp); messages.forEach(msg => appendMessageToLog(msg.sender, msg.text, msg.timestamp, msg.role)); oldestMessageTimestamp = messages[0].timestamp; if (messages.length < CHAT_HISTORY_LOAD_LIMIT) { noMoreOlderMessages = true; chatLoadingIndicator.textContent = "Beginning of chat history."; } } else { noMoreOlderMessages = true; chatLoadingIndicator.textContent = "Beginning of chat history."; } scrollToChatBottom(); setupScrollListener(); } catch (error) { console.error("Error fetching initial messages:", error); appendSystemMessage("Error loading initial chat history."); chatLoadingIndicator.textContent = "Error loading history."; } finally { if (!noMoreOlderMessages && chatLoadingIndicator) { chatLoadingIndicator.style.display = 'none'; } } }
    async function fetchOlderMessages() { if (isLoadingOlderMessages || noMoreOlderMessages || !oldestMessageTimestamp) return; if (!chatLogContainer || !chatLoadingIndicator) return; console.log(`Workspaceing messages before ${oldestMessageTimestamp}`); isLoadingOlderMessages = true; chatLoadingIndicator.textContent = "Loading older messages..."; chatLoadingIndicator.style.display = 'block'; try { const response = await fetch(`${BACKEND_URL}/get-messages?before=${oldestMessageTimestamp}&limit=${CHAT_HISTORY_LOAD_LIMIT}`); if (!response.ok) throw new Error(`HTTP error: ${response.status}`); const messages = await response.json(); if (messages && messages.length > 0) { const oldScrollHeight = chatLogContainer.scrollHeight; const oldScrollTop = chatLogContainer.scrollTop; messages.sort((a, b) => a.timestamp - b.timestamp); for (let i = messages.length - 1; i >= 0; i--) { prependMessageToLog(messages[i].sender, messages[i].text, messages[i].timestamp, messages[i].role); } oldestMessageTimestamp = messages[0].timestamp; chatLogContainer.scrollTop = oldScrollTop + (chatLogContainer.scrollHeight - oldScrollHeight); if (messages.length < CHAT_HISTORY_LOAD_LIMIT) { noMoreOlderMessages = true; chatLoadingIndicator.textContent = "Beginning of chat history."; } else { chatLoadingIndicator.style.display = 'none'; } } else { noMoreOlderMessages = true; chatLoadingIndicator.textContent = "Beginning of chat history."; } } catch (error) { console.error("Error fetching older messages:", error); chatLoadingIndicator.textContent = "Error loading older history."; } finally { isLoadingOlderMessages = false; if (!noMoreOlderMessages && chatLoadingIndicator && !isLoadingOlderMessages) { chatLoadingIndicator.style.display = 'none'; } } }
    function addChatLoadingIndicator() { if (!chatLogContainer) return; if (!chatLoadingIndicator) { chatLoadingIndicator = document.createElement('div'); chatLoadingIndicator.className = 'chat-loading-indicator'; } chatLoadingIndicator.textContent = 'Loading...'; chatLoadingIndicator.style.display = 'block'; const welcomeMsg = chatLogContainer.querySelector('.chat-system-message'); if (welcomeMsg) { chatLogContainer.insertBefore(chatLoadingIndicator, welcomeMsg.nextSibling); } else if (chatLogContainer.firstChild) { chatLogContainer.insertBefore(chatLoadingIndicator, chatLogContainer.firstChild); } else { chatLogContainer.appendChild(chatLoadingIndicator); } }
    function setupScrollListener() { if (!chatLogContainer) return; chatLogContainer.removeEventListener('scroll', handleChatScroll); chatLogContainer.addEventListener('scroll', handleChatScroll); }
    const handleChatScroll = debounce(() => { if (!chatLogContainer) return; if (chatLogContainer.scrollTop < 50 && !isLoadingOlderMessages && !noMoreOlderMessages) { fetchOlderMessages(); } }, 150);
    function startChatPolling() { if (chatPollIntervalId) clearInterval(chatPollIntervalId); if (!isChatViewActive || !isLoggedIn) return; console.log("Starting chat polling..."); fetchNewMessages(); chatPollIntervalId = setInterval(fetchNewMessages, CHAT_POLL_INTERVAL); }
    function stopChatPolling() { if (chatPollIntervalId) { console.log("Stopping chat polling."); clearInterval(chatPollIntervalId); chatPollIntervalId = null; } }

    // --- User Count Polling ---
    async function fetchUserCount() { if (!isWelcomeAreaVisible()) return; const displayElement = document.getElementById('user-count-display'); if (!displayElement) return; try { const response = await fetch(`${BACKEND_URL}/user-count`); if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); } const data = await response.json(); if (typeof data.count === 'number') { displayElement.textContent = `Users online: ${data.count}`; } else { displayElement.textContent = 'Users online: N/A'; } } catch (error) { console.error("Error fetching user count:", error); if (displayElement) { displayElement.textContent = 'Users online: Error'; } } }
    function isWelcomeAreaVisible() { return mainContent && mainContent.style.display !== 'none' && mainContent.querySelector('#welcome-area'); }
    function startUserCountPolling() { if (userCountIntervalId) clearInterval(userCountIntervalId); if (!isWelcomeAreaVisible()) return; console.log("Starting user count polling..."); fetchUserCount(); userCountIntervalId = setInterval(fetchUserCount, USER_COUNT_POLL_INTERVAL); }
    function stopUserCountPolling() { if (userCountIntervalId) { console.log("Stopping user count polling."); clearInterval(userCountIntervalId); userCountIntervalId = null; } }

    // --- Load Settings & Initial Setup (Await initial check) ---
    async function loadSettingsAndInit() { // Added async
        console.log("[DEBUG] loadSettingsAndInit called.");
        try {
            // --- Load basic settings ---
            const t=localStorage.getItem(LS_THEME)||'dark';
            const fs=localStorage.getItem(LS_FONTSIZE)||'16';
            const ff=localStorage.getItem(LS_FONTFAMILY)||"'Segoe UI', sans-serif";
            warnOnClose=localStorage.getItem(LS_WARNONCLOSE)==='true';
            bgImageEnabled=localStorage.getItem(LS_BGIMAGE_ENABLED)==='true';
            bgImageUrl=localStorage.getItem(LS_BGIMAGE_URL)||'';

            // --- Determine initial login state ---
            const storedUser = localStorage.getItem(LS_LOGGED_IN_USER);
            if (storedUser) {
                isLoggedIn = true;
                loggedInUsername = storedUser;

                // ---> AWAIT Initial Ban Check <---
                console.log(`[DEBUG] Resumed session for: ${loggedInUsername}. Performing initial ban check...`);
                const initialBanStatus = await checkUserBanStatus(loggedInUsername); // Wait for the check
                isClientSideBanned = initialBanStatus.isBanned; // Set flag based on check result
                if (isClientSideBanned) { localStorage.setItem(LS_IS_BANNED, 'true'); console.log("[DEBUG] Initial check confirmed user is banned."); }
                else { localStorage.removeItem(LS_IS_BANNED); console.log("[DEBUG] Initial check confirmed user is NOT banned."); }
                // ---> END Await <---

                // ---> Update UI AFTER initial check <---
                updateLoginUI();
                console.log(`[DEBUG] Initial UI updated based on awaited ban status.`);

                // ---> Start PERIODIC polling AFTER initial check & UI update <---
                startBanStatusPolling();

            } else {
                isLoggedIn = false; loggedInUsername = null;
                localStorage.removeItem(LS_IS_BANNED);
                isClientSideBanned = false;
                stopBanStatusPolling(); // Ensure stopped if not logged in
                console.log(`[DEBUG] No stored user found. Flags cleared.`);
                updateLoginUI(); // Update UI for logged-out state
            }

            // --- Apply visual settings ---
            if(themeSelector)themeSelector.value=t; if(fontSelector)fontSelector.value=ff; if(fontSizeSlider)fontSizeSlider.value=fs; if(warnOnCloseSwitch)warnOnCloseSwitch.checked=warnOnClose; if(bgImageToggleSwitch)bgImageToggleSwitch.checked=bgImageEnabled;
            updateTheme(t); updateFontSize(fs); updateFontFamily(ff); applyCustomBackground();

            // --- Load app data ---
            loadGames(); loadCategories();

            // --- Final UI setup ---
            updateLoginUI(); // Call again ensures theme/font changes reflected
            if(warnOnClose) window.addEventListener('beforeunload',handleMainBeforeUnload);
            if(chatPanel) chatPanel.style.display = 'none'; if(mainContent) mainContent.style.display = 'block'; isChatViewActive = false;
            if(welcomeAreaPlaceholder) welcomeAreaPlaceholder.style.display='none';
            showSection('welcome');
            updateFavicon(currentThemeColor);

        } catch(e){
            console.error("Init err:", e);
            if(mainContent)mainContent.innerHTML=`<h2 style="color:red;">Error loading: ${e.message}</h2>`;
            updateTheme('dark'); updateFontSize('16'); updateFontFamily("'Segoe UI', sans-serif");
            isLoggedIn = false; loggedInUsername = null; isClientSideBanned = false;
            stopBanStatusPolling(); updateLoginUI(); showSection('welcome'); stopUserCountPolling();
        }
        updateSelectArrowColor(getComputedStyle(root).getPropertyValue('--text').trim());
        console.log("[DEBUG] Init complete.");
    }

    // --- Update UI Based on Login State ---
    function updateLoginUI() {
        // console.log(`[DEBUG] updateLoginUI called. isLoggedIn: ${isLoggedIn}, isClientSideBanned: ${isClientSideBanned}`); // Less noisy
        // Logout Button Logic (Hides if banned or not logged in)
        if (logoutBtn) {
            logoutBtn.style.display = (isLoggedIn && !isClientSideBanned) ? 'block' : 'none';
        }

        // Chat Input & Send Button Logic
        const chatDisabled = !isLoggedIn || isClientSideBanned;
        if (chatMessageInput) {
            chatMessageInput.disabled = chatDisabled;
            // Set the correct placeholder based *only* on the current state flags
            chatMessageInput.placeholder = isLoggedIn ? (isClientSideBanned ? 'Chat disabled (Account Restricted)' : 'Enter message...') : 'Login to chat...';
        }
        if (sendMessageBtn) {
            sendMessageBtn.style.display = isLoggedIn && !isClientSideBanned ? 'flex' : 'none';
            sendMessageBtn.disabled = chatDisabled;
        }
        if (chatToggleBtn) chatToggleBtn.disabled = false;

        // Sidebar Button Logic
        const needsLoginBtns = [sidebarGamesBtn, sidebarProxyBtn, sidebarToolsBtn];
         needsLoginBtns.forEach(btn => { if(btn) btn.disabled = !isLoggedIn; });

        // Welcome Message Logic
        const welcomeMsgEl = document.getElementById('welcome-message'); if (welcomeMsgEl) { welcomeMsgEl.textContent = `Welcome, ${(loggedInUsername || 'Guest').replace(/</g, "&lt;")}!`; }
        const chatWelcomeName = document.getElementById('chatActiveUserName'); if (chatWelcomeName) { chatWelcomeName.textContent = (loggedInUsername || 'Guest').replace(/</g, "&lt;"); }
    }

    // --- Event Listeners Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM ready.");
        try {
            // --- Find Elements (Ensure all are found) ---
            mainContent=document.getElementById("main-content"); settingsPanel=document.getElementById("settingsPanel"); root=document.documentElement; body=document.body; faviconLink=document.getElementById('dynamic-favicon'); gameModal=document.getElementById('gameModal'); settingsBtn=document.getElementById('settingsBtn'); searchInput=document.getElementById('search'); welcomeAreaPlaceholder=document.getElementById('welcome-area-placeholder'); themeSelector=document.getElementById('themeSelector'); fontSelector=document.getElementById('fontSelector'); fontSizeSlider=document.getElementById('fontSizeSlider'); warnOnCloseSwitch=document.getElementById('warnOnCloseSwitch'); bgImageToggleSwitch=document.getElementById('bgImageToggleSwitch'); bgImageControlContainer=document.getElementById('bgImageControlContainer'); bgImageFileInput=document.getElementById('bgImageFileInput'); clearBgImageBtn=document.getElementById('clearBgImageBtn');
            fontSizeThumb = document.getElementById('fontSizeThumb'); fontSizeValueDisplay = document.getElementById('fontSizeValue'); fontSizeProgress = document.getElementById('fontSizeProgress');
            loginModal = document.getElementById('loginModal'); registerModal = document.getElementById('registerModal');
            loginUsername = document.getElementById('loginUsername'); loginPassword = document.getElementById('loginPassword'); submitLoginBtn = document.getElementById('submitLoginBtn'); cancelLoginBtn = document.getElementById('cancelLoginBtn'); switchToRegisterBtn = document.getElementById('switchToRegisterBtn'); loginError = document.getElementById('loginError');
            registerUsername = document.getElementById('registerUsername'); registerPassword = document.getElementById('registerPassword'); registerPasswordConfirm = document.getElementById('registerPasswordConfirm'); submitRegisterBtn = document.getElementById('submitRegisterBtn'); cancelRegisterBtn = document.getElementById('cancelRegisterBtn'); switchToLoginBtn = document.getElementById('switchToLoginBtn'); registerError = document.getElementById('registerError');
            logoutBtn = document.getElementById('logoutBtn'); chatToggleBtn = document.getElementById('chatToggleBtn');
            sidebarGamesBtn = document.getElementById('sidebarGamesBtn'); sidebarProxyBtn = document.getElementById('sidebarProxyBtn'); sidebarToolsBtn = document.getElementById('sidebarToolsBtn');
            chatPanel = document.getElementById('chatPanel'); chatActiveSection = document.getElementById('chatActiveSection'); chatLogContainer = document.getElementById('chatLogContainer'); chatMessageInput = document.getElementById('chatMessageInput'); sendMessageBtn = document.getElementById('sendMessageBtn'); chatLoadingIndicator = document.querySelector('.chat-loading-indicator');
            gameModalTitle=document.getElementById('gameModalTitle'); gameIdInput=document.getElementById('gameIdInput'); gameNameInput=document.getElementById('gameNameInput'); gameUrlInput=document.getElementById('gameUrlInput'); gameCategorySelect=document.getElementById('gameCategorySelect'); addCategoryBtn=document.getElementById('addCategoryBtn'); saveGameBtn=document.getElementById('saveGameBtn'); cancelGameBtn=document.getElementById('cancelGameBtn');

            const criticalElements = { mainContent, settingsPanel, root, body, loginModal, registerModal, settingsBtn, searchInput, chatPanel, chatLogContainer, chatMessageInput, sendMessageBtn, logoutBtn };
            const missingCritical = Object.entries(criticalElements).filter(([k, v]) => !v).map(([k]) => k);
            if (missingCritical.length > 0) throw new Error(`Missing critical elements: ${missingCritical.join(', ')}`);

        } catch(e){ console.error("FATAL: Element finding error:", e); document.body.innerHTML=`<div style="padding:30px;color:red;background:#333;"><h2>App Init Error</h2><p>${e.message}</p></div>`; return; }

        loadSettingsAndInit(); // Initializes state, UI, awaits initial check, starts polling

        console.log("Attaching listeners.");

        // --- Settings Button Listener (Uses async handler) ---
        settingsBtn.addEventListener('click', handleSettingsButtonClick);

        // --- Listener to close settings panel and restart polling ---
        document.addEventListener('click', (event) => {
            // Check if the settings panel is visible and the click was outside both the panel and the button that opens it
            if (settingsPanel && settingsPanel.classList.contains('show') &&
                !settingsPanel.contains(event.target) && !settingsBtn.contains(event.target))
            {
                console.log("[DEBUG] Click outside settings panel detected. Closing panel and restarting polling.");
                settingsPanel.classList.remove('show');
                startBanStatusPolling(); // Restart background polling
            }
        });

        // --- Other Standard Listeners ---
        searchInput.addEventListener('input',debouncedFilterGames);
        if(saveGameBtn)saveGameBtn.addEventListener('click',handleSaveGame); if(cancelGameBtn)cancelGameBtn.addEventListener('click',closeGameModal); if(addCategoryBtn)addCategoryBtn.addEventListener('click',handleAddCategory); if(gameModal)gameModal.addEventListener('click',(e)=>{if(e.target===gameModal)closeGameModal();});
        fontSizeSlider.addEventListener('input',(e)=>updateFontSize(e.target.value)); warnOnCloseSwitch.addEventListener('change',(e)=>{ warnOnClose=e.target.checked; saveSetting(LS_WARNONCLOSE,warnOnClose); if(warnOnClose)window.addEventListener('beforeunload',handleMainBeforeUnload); else window.removeEventListener('beforeunload',handleMainBeforeUnload); });
        bgImageToggleSwitch.addEventListener('change',(e)=>{bgImageEnabled=e.target.checked;saveSetting(LS_BGIMAGE_ENABLED,bgImageEnabled);if(!bgImageEnabled){bgImageUrl='';removeSetting(LS_BGIMAGE_URL);if(bgImageFileInput)bgImageFileInput.value=null;}applyCustomBackground();});
        bgImageFileInput.addEventListener('change',handleImageFileSelect); clearBgImageBtn.addEventListener('click',clearCustomBackground);

        // --- Auth Listeners ---
        if(submitLoginBtn) submitLoginBtn.addEventListener('click', handleLogin); if(loginPassword) loginPassword.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleLogin(); }); if(cancelLoginBtn) cancelLoginBtn.addEventListener('click', closeAuthModals); if(switchToRegisterBtn) switchToRegisterBtn.addEventListener('click', showRegisterModal);
        if(submitRegisterBtn) submitRegisterBtn.addEventListener('click', handleRegister); if(registerPasswordConfirm) registerPasswordConfirm.addEventListener('keypress', (e) => { if(e.key === 'Enter') handleRegister(); }); if(cancelRegisterBtn) cancelRegisterBtn.addEventListener('click', closeAuthModals); if(switchToLoginBtn) switchToLoginBtn.addEventListener('click', showLoginModal);
        if(loginModal) loginModal.addEventListener('click', (e) => { if (e.target === loginModal) closeAuthModals(); }); if(registerModal) registerModal.addEventListener('click', (e) => { if (e.target === registerModal) closeAuthModals(); });
        if(logoutBtn) logoutBtn.addEventListener('click', handleLogout);

        // --- Chat Listeners ---
        // Chat toggle listener is attached inline via onclick="toggleChatView()" in the HTML
        if (sendMessageBtn) sendMessageBtn.addEventListener('click', sendMessage);
        if (chatMessageInput) {
            chatMessageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    if (isLoggedIn && !isClientSideBanned) { sendMessage(); }
                    else if (!isLoggedIn) { showLoginModal(); }
                    else { alert("Chat disabled (Account Restricted)"); console.warn("[DEBUG] Enter press blocked by client-side ban flag."); }
                }
            });
         }
         // Scroll listener attached by setupScrollListener()

        console.log("Listeners attached.");
    }); // End DOMContentLoaded
</script>

</body>
</html>
